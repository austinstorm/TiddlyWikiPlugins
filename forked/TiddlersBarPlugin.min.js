/***
|''Name:''|TiddlersBarPlugin|
|''Description:''|Provides browser-like tabs to switch between tiddlers.|
|''Author:''|Pascal Collin / fork: [[Tobias Beer|http://tobibeer.tiddlyspace.com]]|
|''Version:''|1.3.1 (2013-10-03)|
|''~CoreVersion:''|2.5.2|
|''Source:''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/forked/TiddlersBarPlugin.min.js|
|''License:''|[[BSD Open Source License|http://visualtw.ouvaton.org/VisualTW.html#License]]|
!Options 
<<option chkDisableTabsBar>> ''chkDisableTabsBar'' &nbsp; <<option chkHideTabsBarWhenSingleTab>> ''chkHideTabsBarWhenSingleTab''
;txtSelectedTiddlerTabButton
:<<option txtSelectedTiddlerTabButton>> (selected tab command)
;txtPreviousTabKey
:<<option txtPreviousTabKey>> (access key)
;txtNextTabKey
:<<option txtNextTabKey>> (access key)
***/
// /%
(function(e){var t=config.options;e.each({chkDisableTabsBar:false,chkHideTabsBarWhenSingleTab:false,txtSelectedTiddlerTabButton:"closeOthers",txtPreviousTabKey:"",txtNextTabKey:""},function(e,n){if(t[e]==undefined)t[e]=n});var n=config.macros.tiddlersBar={tooltip:"Show %0...",tooltipClose:"Close tiddler...",tooltipSave:"Save tiddler...",promptRename:"Enter new tiddler name",currentTiddler:"",previousState:false,previousKey:t.txtPreviousTabKey,nextKey:t.txtNextTabKey,tabsAnimationSource:null,handler:function(e,t,r){var i,s,o,u,a=null;if(n.isShown())story.forEachTiddler(function(t,r){if(t==n.currentTiddler){o=createTiddlyElement(null,"span",null,"tab tabSelected");n.createActiveTabButton(o,t);if(a&&n.previousKey)a.setAttribute("accessKey",n.nextKey);a="active"}else{o=createTiddlyElement(e,"span",null,"tab tabUnselected");i=createTiddlyButton(o,t,n.tooltip.format([t]),n.onSelectTab);i.setAttribute("tiddler",t);if(a=="active"&&n.nextKey)i.setAttribute("accessKey",n.previousKey);a=i}u=story.isDirty(t);s=createTiddlyButton(o,u?"!":"x",u?n.tooltipSave:n.tooltipClose,u?n.onTabSave:n.onTabClose,"tabButton");s.setAttribute("tiddler",t);if(e.childNodes){e.insertBefore(document.createTextNode(" "),e.firstChild);e.insertBefore(o,e.firstChild)}else e.appendChild(o)})},refresh:function(e,t){removeChildren(e);n.handler(e,"tiddlersBar",t);if(n.previousState!=n.isShown()){story.refreshAllTiddlers();if(n.previousState)story.forEachTiddler(function(e,t){t.style.display=""});n.previousState=!n.previousState}},isShown:function(){if(t.chkDisableTabsBar)return false;if(!t.chkHideTabsBarWhenSingleTab)return true;var e=0;story.forEachTiddler(function(){e++});return e>1},selectNextTab:function(){var e="";story.forEachTiddler(function(t){if(!n.currentTiddler){story.displayTiddler(null,t);return}if(t==n.currentTiddler){if(e){story.displayTiddler(null,e);return}else n.currentTiddler=""}else e=t})},onSelectTab:function(e){var t=this.getAttribute("tiddler");if(t)story.displayTiddler(null,t);return false},onTabClose:function(e){var t=this.getAttribute("tiddler");if(t){if(story.hasChanges(t)&&!readOnly){if(!confirm(config.commands.cancelTiddler.warning.format([t])))return false}story.closeTiddler(t)}return false},onTabSave:function(e){var t=this.getAttribute("tiddler");e=e||window.event;if(t)config.commands.saveTiddler.handler(e,null,t);return false},onSelectedTabButtonClick:function(e,n,r){var i=this.getAttribute("tiddler");e=e||window.event;if(i&&t.txtSelectedTiddlerTabButton&&config.commands[t.txtSelectedTiddlerTabButton])config.commands[t.txtSelectedTiddlerTabButton].handler(e,n,i);return false},onTiddlersBarAction:function(e){var t=e.target?e.target.id:e.srcElement.id;if(t=="tiddlersBar")story.displayTiddler(null,"New Tiddler",DEFAULT_EDIT_TEMPLATE,false,null,null)},createActiveTabButton:function(e,r){if(t.txtSelectedTiddlerTabButton&&config.commands[t.txtSelectedTiddlerTabButton]){var i=createTiddlyButton(e,r,config.commands[t.txtSelectedTiddlerTabButton].tooltip,n.onSelectedTabButtonClick);i.setAttribute("tiddler",r)}else createTiddlyText(e,r)}};Story.prototype.closeTiddlerTIDDLERSBAR=Story.prototype.closeTiddler;Story.prototype.closeTiddler=function(e,t,r){if(e==n.currentTiddler)n.selectNextTab();story.closeTiddlerTIDDLERSBAR.apply(this,arguments);var i=document.getElementById("tiddlersBar");if(i)n.refresh(i,null)};Story.prototype.displayTiddlerTIDDLERSBAR=Story.prototype.displayTiddler;Story.prototype.displayTiddler=function(e,t,r,i,s,o,u){var a=story.displayTiddlerTIDDLERSBAR.apply(this,arguments);var f=a?a.getAttribute("tiddler"):t instanceof Tiddler?t.title:t;if(n.isShown()){story.forEachTiddler(function(e,t){if(e!=f)t.style.display="none";else t.style.display=""});n.currentTiddler=f}var l=document.getElementById("tiddlersBar");if(l)n.refresh(l,null);return a};config.shadowTiddlers.StyleSheetTiddlersBar=["/*{{{*/","#tiddlersBar {padding : 1em 0.5em 0 0.5em; border-bottom:1px solid [[ColorPalette::TertiaryPale]];}","#tiddlersBar .button {border:0;}","#tiddlersBar .tab {border:1px solid transparent;border-bottom:0;white-space:nowrap; padding:2px 5px;","-webkit-border-top-left-radius: 3px;","-webkit-border-top-right-radius: 3px;","-moz-border-radius-topleft: 3px;","-moz-border-radius-topright: 3px;","border-top-left-radius: 3px;","border-top-right-radius: 3px;\n}","#tiddlersBar .tabSelected {background:[[ColorPalette::Background]]; border-color:[[ColorPalette::TertiaryPale]];}","#tiddlersBar .tabUnselected {background:[[ColorPalette::TertiaryPale]]}","#tiddlersBar a {color:[[ColorPalette::TertiaryDark]]}","#tiddlersBar .button:hover,","#tiddlersBar .tabButton:hover{background:transparent;color:[[ColorPalette::PrimaryDark]];}",".tabUnselected .tabButton,",".tabSelected .tabButton {padding : 0 2px 0 2px; margin: 0 0 0 4px; color: [[ColorPalette::TertiaryMid]];}",".tiddler, .tabContents {border:none;}","/*}}}*/"].join("\n");store.addNotification("StyleSheetTiddlersBar",refreshStyles);config.shadowTiddlers.PageTemplate=config.shadowTiddlers.PageTemplate.replace(/<div id='tiddlerDisplay'><\/div>/m,["<div id='tiddlersBar'"," refresh='none'"," ondblclick='config.macros.tiddlersBar.onTiddlersBarAction(event)'>","</div>\n","<div id='tiddlerDisplay'></div>"].join(""));refreshPageTemplateTIDDLERSBAR=refreshPageTemplate;refreshPageTemplate=function(e){refreshPageTemplateTIDDLERSBAR(e);if(n)n.refresh(document.getElementById("tiddlersBar"))};config.refreshers.none=function(){return true};ensureVisible=function(e){return 0}})(jQuery)
// %/