/***
|''Name''|HashTagsPlugin|
|''Author''|[[Tobias Beer|http://tobibeer.tiddlyspace.com]]|
|''Documentation''|http://hashtags.tiddlyspace.com|
|''Requires''||
|''~CoreVersion''|2.5|
|''Version''|0.4.0 (2013-09-05)|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/HashTagsPlugin.min.js|
***/
// /%
(function(t){function n(e,n){t(this).wrap("<span />").click(function(e){var t=e||window.event;t.cancelBubble;if(t.stopPropagation)t.stopPropagation()})}function r(e,t,n,r){var i=(t+n).toLowerCase(),s=r?r:i;h=createTiddlyButton(e,s,"display search results for: "+s,function(e){var t="Search results for %0...".format([s]);if(store.getTiddler(i))story.displayTiddler(this,i);else{config.shadowTiddlers[t]="<<hashtag [["+i+"]]>>";story.displayTiddler(this,t)}return false},config.macros.hashtag.css);h.setAttribute("hashtag",i);return h}config.textPrimitives.hashtag="(?:"+config.textPrimitives.anyLetter+"|\\-)+";config.textPrimitives.hashes="[\\#\\ยง\\$\\!\\%\\&]";config.macros.hashtag={css:"hashtag",exclude:"HashTagsConfig##Exclude",hashtag:new RegExp("(?: |	)+?("+config.textPrimitives.hashes.replace(/\\\\/mg,"\\")+")("+config.textPrimitives.hashtag+")","mg"),preview:function(){},handler:function(e,i,s,o,u,a){var f=[],l,c,h={},p=[],d,v,m,g,y,b,w,E,S,x,T,N,C="",k=store.getTiddlers("modified"),L=config.macros.hashtag,A=(store.getTiddlerText(L.exclude)||"").readBracketedList(),O=/^(!{1,6})(.*)/,M=s[0],_=function(){return(new Date).formatString("YYYY0MM0DD")+Math.random()};if(s.contains("categorySearch")){r(e,M,"","Search for all "+M+"-tags...");return}A.map(function(e){f.pushUnique(e)});for(d=0;d<A.length;d++){store.getTaggedTiddlers(A[d]).map(function(e){f.pushUnique(e.title)})}for(d=0;d<k.length;d++){S="";tid=k[d].title;if(f.contains(tid))continue;y=store.getTiddlerText(tid);if(y){y=y.split("\n");for(v=0;v<y.length;v++){m=y[v];hd=O.exec(m);if(hd){S=hd[2]}else{l=L.hashtag.exec(m);while(l){b=l[2].length+l.index+1;l=l[1]+l[2].toLowerCase();if(p.contains(l+"s"))l=l+"s";if(!M||M&&(M.length==1&&l.substr(0,1)==M||M==l||M+"s"==l||M==l+"s")){if(!p.contains(l)){p.push(l);x=l.substr(0,l.length-1);if(l.substr(l.length-1,1)=="s"&&p.contains(x)){h[l]=h[x];delete p[x];delete h[x]}else{h[l]={}}}if(!h[l][tid])h[l][tid]=[];if(S)h[l][tid].pushUnique(S)}m=m.substr(b,m.length-b);L.hashtag.lastIndex=0;l=L.hashtag.exec(m)}}}}}p.sort();if(M&&M.length>1)C+="<<hashtag "+M.substr(0,1)+" categorySearch>>\n";C+="{{hashtagSearch{";for(O=0;O<p.length;O++){N=p[O];w="{{preview{%0 <<preview [[%1]] [["+N+"]]>>}}}";if(!M||M.length==1)C+="\n!! "+N;d=0;c=h[N];for(T in c){d++;if(typeof c[T]=="object"){C+="\n#"+w.format(["Tiddler [["+T+"]]",T]);for(E=0;E<c[T].length;E++){S=c[T][E];if(version.extensions.SectionLinksPlugin)C+="\n#*"+w.format(["[["+S+"|"+T+"##"+S+"]]",T+"##"+S]);else C+="\n#*"+w.format(["Section "+S,T+"##"+S])}}}}wikify(C,e);t(".hashtagSearch a",e).each(n)}};config.macros.preview={fullTiddler:true,handler:function(e,r,i){if(!i[0])return;var s=i[0].indexOf("##")<0?"Tiddler":"Section";t(createTiddlyElement(e,"div",null,"previewPanel")).css("display","none").attr({refresh:"content",tiddler:i[0],hashtag:i[1]});t(e).last().click(function(e){var r=s=="Section",i=r?"Tiddler":"Section",o,u=e||window.event,a=t(this),f=a.find(".previewPanel"),l=u.altKey,c=config.macros.preview.fullTiddler;tid=a.attr("tiddler"),hashtag=f.attr("hashtag"),isOpen=f.css("display")!="none";f=l?t(".preview"+s,c?t(a).parentsUntil(".tiddler"):a.parent().parent()).find(".previewPanel"):f;f.empty().hide().parent().removeClass("preview"+s+"Open");o=l?a.parentsUntil(c?".tiddler":".hashtagSearch"):r?a.parent().parent().parent():a.next();t(".previewPanel",t(".preview"+i+"Open",o).removeClass("preview"+i+"Open")).css("display","none");if(!isOpen){f.each(function(e){var r=t(this),i=hashtag,o=r.attr("tiddler"),u=store.getTiddlerText(o);r.parent().addClass("preview"+s+"Open");if(u)wikify(u,r[0],null,store.getTiddler(o));t("a",r).each(n);t(".hashtag",r).each(function(e){var n=t(this),r=n.attr("hashtag");n.addClass(r==i||r+"s"==i?"highlight":"dimlight")});r.css("display",isOpen?"none":"block")})}if(f.length<2)ensureVisible(f.parent()[0])}).addClass("preview preview"+s)}};config.formatters.push({name:"hashTag",match:config.textPrimitives.unWikiLink+"?(?:"+config.textPrimitives.hashes+")"+config.textPrimitives.anyLetterStrict+"+.?",lookaheadRegExp:new RegExp(config.textPrimitives.unWikiLink+"?("+config.textPrimitives.hashes+")("+config.textPrimitives.hashtag+")","mg"),handler:function(e){if(e.matchText.substr(0,1)===config.textPrimitives.unWikiLink){e.outputText(e.output,e.matchStart+1,e.nextMatch);return}this.lookaheadRegExp.lastIndex=e.matchStart;var t=this.lookaheadRegExp.exec(e.source);if(t&&t.index===e.matchStart){r(e.output,t[1],t[2]);e.nextMatch=this.lookaheadRegExp.lastIndex}}},{name:"itag",match:"\\:\\:(?:"+config.textPrimitives.anyLetter+"+?):{1,1}(?:"+config.textPrimitives.anyLetter+"+?)\\:\\:",lookaheadRegExp:new RegExp("\\:\\:("+config.textPrimitives.anyLetter+"+?):{1,1}("+config.textPrimitives.anyLetter+"+?)\\:\\:","mg"),handler:function(t){this.lookaheadRegExp.lastIndex=t.matchStart;var n=this.lookaheadRegExp.exec(t.source);if(n&&n.index==t.matchStart){var i=n[1],s=n[2];e=r(t.output,i,s,i+" "+s);t.nextMatch=this.lookaheadRegExp.lastIndex}}});config.shadowTiddlers.StyleSheetHashTags="/*{{{*/\n"+".hashtag{font-size:1.2em;color:#339;padding:0 2px;}\n"+".hashtag:hover{color:#22A;background:transparent;text-decoration:underline;}\n"+".preview{display:block;padding:5px;cursor:pointer;}\n"+".preview:hover{background-color:#cdf;}\n"+".previewTiddlerOpen, .previewSectionOpen{background-color:#cdf;}\n"+".previewPanel{display:block;background:#eef;padding:10px;}\n"+"dt .previewPanel{font-weight:normal;}\n"+".dimlight {background-color:#f6f6f6;}\n"+"/*}}}*/";store.addNotification("StyleSheetHashTags",refreshStyles)})(jQuery)
// %/