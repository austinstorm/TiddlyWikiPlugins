/***
|''Name''|SlidrPlugin|
|''Description''|shows a tiddler timeline using sliders|
|''Documentation''|http://slidr.tiddlyspace.com|
|''Author''|Tobias Beer|
|''Version''|1.0.1 2013-08-31|
|''CoreVersion''|2.6.5|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/SlidrPlugin.min.js|
|''License''|[[Creative Commons Attribution-Share Alike 3.0|http://creativecommons.org/licenses/by-sa/3.0/]]|
{{{
<<slidr>>
}}}
<<slidr>>
!CODE
***/
//{{{
(function(e){config.macros.slidr={defaults:{txtSliderTooltip:"Click to show tiddlers in %0",errDate:"%0 is not a valid start or end date!",lblTiddler1:"tiddler",lblTiddler2:"tiddlers",months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],minGroup:7,openOnLoad:false,level:"month",field:"-modified",exclude:"excludeLists",fmtYear:"YYYY",fmtMonth:"MMM, YYYY",fmtDay:"0DD. mmm, YYYY",fmtDate:"0hh:0mm",fmtDateFull:"0DD. mmm, YYYY",fmtSlider:"{{slidr_title{%0}}}{{slidr_count{%1}}}",fmtTiddler:"\n{{slidr_entry{ {{slidr_date{%1}}}"+"{{slidr_tid{[[%0]]}}}"+"{{slidr_tags{%2}}} }}}",fmtTag:"<<tag [[%0]]>>",fmtCount:"(%0 %1)"},handler:function(t,n,r,i,s,o){var u,a,f,l,c,h,p,d,v,m=[],g=[],y=config.messages,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D=this.defaults,P=r[0],H=s.parseParams("anon",null,true),B=parseInt(getParam(H,"year")),j=parseInt(getParam(H,"month")),F=parseInt(getParam(H,"day")),h=getParam(H,"start"),a=getParam(H,"end"),c=getParam(H,"level",D.level),I=getParam(H,"exclude",D.exclude),q=getParam(H,"field",D.field),R=getParam(H,"keep","").readBracketedList(),U=getParam(H,"filter",""),z={open:getParam(H,"open",D.openOnLoad),year:B,month:j,day:F,fmtTiddler:getParam(H,"format",D.fmtTiddler),fmtDate:D.fmtDate,fmtDateUser:getParam(H,"dateformat"),fmtDateFull:getParam(H,"dateformat.full",D.fmtDateFull),fmtYear:getParam(H,"format.year",D.fmtYear),fmtMonth:getParam(H,"format.month",D.fmtMonth),fmtDay:getParam(H,"format.day",D.fmtDay),min:getParam(H,"min",D.minGroup),ex:I},W=q.substr(0,1)=="-",X=function(e,t){var n=e[e.length-1],r=[t,[]];if(!n||t!=n[0]){e.push(r);n=e[e.length-1]}return n[1]};l=a?!this.isValidDate(a):false;if(l||(h?!this.isValidDate(h):false)){createTiddlyError(t,y.macroError.format(["slidr"]),y.macroErrorDetails.format(["slidr",D.errDate.format([l?a:h])]));return}h=h?Date.convertFromYYYYMMDDHHMM(h):h;a=a?Date.convertFromYYYYMMDDHHMM(a):a;c=c.toLowerCase();c=c.substr(c.length-1)=="s"?c.substr(0,c.length-1):c;z.level=c;q=W||q.substr(0,1)=="+"?q.substr(1):q;if(U){m=store.filterTiddlers(U)}else{m=store.getTiddlers(q);if(W)m.reverse()}I=I.readBracketedList();for(p=0;p<m.length;p++){v=m[p];if(!(R.contains(v.title)||v.tags.containsAny(R))&&(I.contains(v.title)||v.tags.containsAny(I)))continue;ti=v.title;u=v[q]||v.fields[q];if(!u.getMonth)u=Date.convertFromYYYYMMDDHHMM(u);b=u.getYear()+1900;w=u.getMonth()+1;E=u.getDate()+1;S=b==B;x=w==j;T=E==F;N=!B&&!j&&!F;L=B&&!j&&!F;M=B&&j&&!F;_=B&&j&&F;C=!B&&j&&!F;k=!B&&!j&&F;O=B&&!j&&F;A=!B&&j&&F;if((!h||h&&u>=h)&&(!a||a&&u<=a)&&(N||L&&S||C&&x||k&&T||M&&S&&x||A&&x&&T||O&&S&&T||_&&S&&x&&T)){d=X(X(X(g,b),w),E);d.push({title:ti,date:u,tags:v.tags})}}z["yrs"]=g;t=createTiddlyElement(t,"div",null,"slidr");e('<div class="slidr_clear"/>').insertAfter(e(t));e(t).data("params",z);what=F?"day":j?"month":B?"year":"";this.renderSliders(t,what,B,j,F)},renderSliders:function(t,n,r,i,s){var o,u=[],a=config.macros.slidr,f=[],l=[],c=[],h=e(t).closest(".slidr").data("params"),p=h.yrs,d=function(e,t,n,r,i){u.push({title:e,year:t,month:n,day:r,tids:i})};e.each(p,function(t,o){yK=o[0];yV=o[1];if(!n||n=="year"){if(!n||!r||yK==r)d(a.formatDate(yK,"11","11",h.fmtYear),yK,isNaN(i)?null:i,isNaN(s)?null:s,a.getTids(h,yV,h.level=="year"?false:true))}else{e.each(yV,function(t,o){mK=o[0];mV=o[1];if(n=="month"){if((!i||mK==i)&&(!r||yK==r)){d(a.formatDate(yK,mK,"11",h.fmtMonth),yK,mK,isNaN(s)?null:s,a.getTids(h,mV,h.level=="month"?false:true))}}else{e.each(mV,function(e,t){dK=t[0];dV=t[1];if((!s||mK==s)&&(!r||yK==r)&&(!i||mK==i)){d(a.formatDate(yK,mK,dK,h.fmtDay),yK,mK,dK,a.getTids(h,dV))}})}})}});for(o=0;o<u.length;o++){this.createSlider(t,u[o],n,h.open)}},createSlider:function(t,n,r,i){var s=config.macros.slidr.defaults,o=parseInt(n.tids)?n.tids:n.tids.length,u=e(createTiddlyElement(t,"a",null,"button slidr_button",null,{title:s.txtSliderTooltip.format([n.title]),year:n.year,month:n.month,day:n.day})).data("tiddlers",n.tids).click(this.click);wikify(s.fmtSlider.format([n.title,s.fmtCount.format([o,o>1?s.lblTiddler2:s.lblTiddler1])]),u[0]);if(i)u.click()},click:function(t){var n="",r,i=config.macros.slidr,s=t||window.event,o=e(resolveTarget(s)).closest(".slidr_button"),u=o.closest(".slidr").data("params"),a=o.next(),f=parseInt(o.attr("year")),l=parseInt(o.attr("month")),c=parseInt(o.attr("day")),h=c?"tids":l?"day":f?"month":"",p=o.data("tiddlers"),d=typeof p=="object";if(a.hasClass("slidr_list")){if(a.is(":hidden")){a.slideDown();o.addClass("slidr_open")}else{a.find(".slidr_list").slideUp().prev().removeClass("slidr_open");a.slideUp();o.removeClass("slidr_open")}}else{r=e('<div class="slidr_list'+(d?" slidr_tids":"")+'"/>').insertAfter(o)[0];if(d){e.each(p,function(e,t){var r=new Date(t.date),s="";t.tags.map(function(e){if(!u.ex.readBracketedList().contains(e))s+=i.defaults.fmtTag.format([e])});n+=u.fmtTiddler.format([t.title,r.formatString(u.fmtDateUser?u.fmtDateUser:c&&u.level=="day"?u.fmtDate:u.fmtDateFull),s])});wikify(n.substr(0,1)=="\n"?n.substr(1):n,r)}else{i.renderSliders(r,h,f,l,c)}e(r).slideDown();o.addClass("slidr_open")}},getTids:function(t,n,r){var i=0,s=[],o=function(t,n){if(typeof n[0]=="number"){e.each(n[1],function(e,t){o(e,t)})}else{i++;s.push(n)}};e.each(n,function(e,t){o(e,t)});return r&&i>=t.min?i:s},formatDate:function(e,t,n,r){return Date.convertFromYYYYMMDDHHMM(String.zeroPad(e,4)+String.zeroPad(t,2)+String.zeroPad(n,2)+"1111").formatString(r)},isValidDate:function(e){var t=/(\d{4})(\d{2})(\d{2})$/.exec(e),n=function(e,t,n){return t>0&&t<13&&e>0&&e<32768&&n>0&&n<=(new Date(e,t,0)).getDate()};return t&&n(t[1],t[2],t[3])}};config.shadowTiddlers["StyleSheetSlidr"]="/*{{{*/\n%0\n/*}}}*/".format([store.getTiddlerText("SlidrPlugin##CSS")]);store.addNotification("StyleSheetSlidr",refreshStyles)})(jQuery)
//}}}

//{{{
/*
!CSS
.slidr{
    clear:left;
    width:90%;
}
.slidr_button,
.viewer .slidr_button{
    width:100%;
    display:block;
    cursor:pointer;
    margin:0;
    padding:0;
    clear:left;
}
.viewer .slidr_title{
    padding-left:7px;
}
.viewer .slidr_list .slidr_title{
    padding-left:14px;
}
.viewer .slidr_list .slidr_list .slidr_title{
    padding-left:21px;
}
.slidr_list{
    width:100%;
    display:block;
    display:none;
}
.slidr_list ul,
.slidr_list li{
    margin:0;
    padding:0;
    list-style-type:none;
}
.slidr_clear{
    height:1px;
    clear:both;
}
.slidr_tid,
.slidr_tags,
.slidr_date,
.slidr_entry{
    float:left;
    display:block;
}
.slidr_entry{
    width:100%;
    padding:1px;
}
.slidr_entry:hover{
    background:[[ColorPalette::TertiaryPale]];
}
.slidr_tid{
    margin-left:7px;
}
.slidr_tags{
    float:right;
    text-align:right;
    min-width:300px;
    margin-left:7px;
}
.viewer .slidr_tags .button {
    margin-right:0;
}
.slidr_count{
    float:right;
    margin:0 7px 0 2em;
}
.slidr_open{
    background:[[ColorPalette::SecondaryLight]];
}
.slidr_list .slidr_open{
    background:[[ColorPalette::SecondaryPale]];
}
.slidr_tids {
    padding:1px 0;
}
!END
*/
//}}}