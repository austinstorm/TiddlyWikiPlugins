/***
|''Name''|SlidrPlugin|
|''Description''|shows a tiddler timeline using sliders|
|''Documentation''|http://slidr.tiddlyspace.com|
|''Author''|Tobias Beer|
|''Version''|1.0.5 2013-09-01|
|''CoreVersion''|2.6.5|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/SlidrPlugin.min.js|
|''License''|[[Creative Commons Attribution-Share Alike 3.0|http://creativecommons.org/licenses/by-sa/3.0/]]|
{{{
<<slidr>>
}}}
<<slidr>>
!CODE
***/
//{{{
(function(e){config.macros.slidr={defaults:{txtSliderTooltip:"Click to show tiddlers in %0",errDate:"%0 is not a valid start or end date!",lblTiddler1:"tiddler",lblTiddler2:"tiddlers",minGroup:7,openOnLoad:false,level:"month",field:"-modified",exclude:"excludeLists",fmtYear:"YYYY",fmtMonth:"MMM, YYYY",fmtDay:"0DD. mmm, YYYY",fmtDate:"0hh:0mm",fmtDateFull:"0DD. mmm, YYYY",fmtSlider:"{{slidr_title{%0}}}{{slidr_count{%1}}}",fmtTiddler:"\n{{slidr_entry{ {{slidr_date{%1}}}"+"{{slidr_tid{[[%0]]}}}"+"{{slidr_tags{%2}}} }}}",fmtTag:"<<tag [[%0]]>>",fmtTagSlider:"<<tag [[%0]]>>",fmtCount:"(%0 %1)"},handler:function(t,n,r,i,s,o){var u,a,f,l,c,h,d,v,m,g=[],y,b=[],w=config.messages,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H=this.defaults,B=r.contains("tags")?[]:undefined;p=s.parseParams("anon",null,true),year=parseInt(getParam(p,"year")),month=parseInt(getParam(p,"month")),day=parseInt(getParam(p,"day")),h=getParam(p,"start"),a=getParam(p,"end"),c=getParam(p,"level",B?"":H.level),ex=getParam(p,"exclude",H.exclude),fld=getParam(p,"field",H.field),keep=getParam(p,"keep","").readBracketedList(),filter=getParam(p,"filter",""),px={open:getParam(p,"open",H.openOnLoad),year:year,month:month,day:day,fmtTiddler:getParam(p,"format",H.fmtTiddler),fmtDate:H.fmtDate,fmtDateUser:getParam(p,"dateformat"),fmtDateFull:getParam(p,"dateformat.full",H.fmtDateFull),fmtYear:getParam(p,"format.year",H.fmtYear),fmtMonth:getParam(p,"format.month",H.fmtMonth),fmtDay:getParam(p,"format.day",H.fmtDay),min:getParam(p,"min",H.minGroup),ex:ex},desc=fld.substr(0,1)=="-",last=function(e,t){var n=e[e.length-1],r=[t,[]];if(!n||t!=n[0]){e.push(r);n=e[e.length-1]}return n[1]};l=a?!this.isValidDate(a):false;if(l||(h?!this.isValidDate(h):false)){createTiddlyError(t,w.macroError.format(["slidr"]),w.macroErrorDetails.format(["slidr",H.errDate.format([l?a:h])]));return}h=h?Date.convertFromYYYYMMDDHHMM(h):h;a=a?Date.convertFromYYYYMMDDHHMM(a):a;c=c.toLowerCase();c=c.substr(c.length-1)=="s"?c.substr(0,c.length-1):c;px.level=c;fld=desc||fld.substr(0,1)=="+"?fld.substr(1):fld;if(filter){g=store.sortTiddlers(store.filterTiddlers(filter),fld)}else{g=store.getTiddlers(fld);if(desc)g.reverse()}ex=ex.readBracketedList();for(d=0;d<g.length;d++){m=g[d];y=m.tags?m.tags:[];if(!(keep.contains(m.title)||y.containsAny(keep))&&(ex.contains(m.title)||y.containsAny(ex)))continue;ti=m.title;u=m[fld]||m.fields[fld];if(!u.getMonth)u=Date.convertFromYYYYMMDDHHMM(u);E=u.getYear()+1900;S=u.getMonth()+1;x=u.getDate()+1;T=E==year;N=S==month;C=x==day;k=!year&&!month&&!day;O=year&&!month&&!day;D=year&&month&&!day;P=year&&month&&day;L=!year&&month&&!day;A=!year&&!month&&day;_=year&&!month&&day;M=!year&&month&&day;if((!h||h&&u>=h)&&(!a||a&&u<=a)&&(k||O&&T||L&&N||A&&C||D&&T&&N||M&&N&&C||_&&T&&C||P&&T&&N&&C)){v=last(last(last(b,E),S),x);v.push({title:ti,date:u,tags:m.tags})}if(B){e.each(y,function(e,t){if(!ex.contains(t))B.pushUnique(t)})}}px["yrs"]=b;t=createTiddlyElement(t,"div",null,"slidr");e('<div class="slidr_clear"/>').insertAfter(e(t));e(t).data("params",px);what=day?"day":month?"month":year?"year":"";if(B)B.sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())});this.renderSliders(t,what,year,month,day,B)},renderSliders:function(t,n,r,i,s,o){var u,a,f=[],l,c=config.macros.slidr,h=[],p=[],d=[],v=e(t).closest(".slidr").data("params"),m=v.yrs,g=function(e,t,n,r,i){f.push({title:e,year:t,month:n,day:r,tids:i})};if(o){e.each(o,function(e,t){l=c.getTids(v,m,v.level?true:false,t);u=typeof l=="object";if(u&&l.length||l>0)g(t,null,null,null,l)})}else{e.each(m,function(t,o){yK=o[0];yV=o[1];if(!n||n=="year"){if(!n||!r||yK==r)g(c.formatDate(yK,"11","11",v.fmtYear),yK,isNaN(i)?null:i,isNaN(s)?null:s,c.getTids(v,yV,v.level=="year"?false:true))}else{e.each(yV,function(t,o){mK=o[0];mV=o[1];if(n=="month"){if((!i||mK==i)&&(!r||yK==r)){g(c.formatDate(yK,mK,"11",v.fmtMonth),yK,mK,isNaN(s)?null:s,c.getTids(v,mV,v.level=="month"?false:true))}}else{e.each(mV,function(e,t){dK=t[0];dV=t[1];if((!s||mK==s)&&(!r||yK==r)&&(!i||mK==i)){g(c.formatDate(yK,mK,dK,v.fmtDay),yK,mK,dK,c.getTids(v,dV))}})}})}})}for(a=0;a<f.length;a++){this.createSlider(t,f[a],n,v.open)}},createSlider:function(t,n,r,i){var s=!n.year;def=config.macros.slidr.defaults,count=parseInt(n.tids)?n.tids:n.tids.length,$s=e(createTiddlyElement(t,"a",null,"button slidr_button",null,{title:def.txtSliderTooltip.format([n.title]),year:n.year,month:n.month,day:n.day})).data("tiddlers",n.tids).click(this.click);if(s)$s.attr("tag",n.title);wikify(def.fmtSlider.format([(s?def.fmtTagSlider:"%0").format([n.title]),def.fmtCount.format([count,count>1?def.lblTiddler2:def.lblTiddler1])]),$s[0]);if(i)$s.click()},click:function(t){var n="",r,i=config.macros.slidr,s=t||window.event,o=e(resolveTarget(s)).closest(".slidr_button"),u=o.attr("tag"),a=o.closest(".slidr").data("params"),f=o.next(),l=parseInt(o.attr("year")),c=parseInt(o.attr("month")),h=parseInt(o.attr("day")),p=h?"tids":c?"day":l?"month":"",d=o.data("tiddlers"),v=typeof d=="object";if(f.hasClass("slidr_list")){if(f.is(":hidden")){f.slideDown();o.addClass("slidr_open")}else{f.find(".slidr_list").slideUp().prev().removeClass("slidr_open");f.slideUp();o.removeClass("slidr_open")}}else{r=e('<div class="slidr_list'+(v?" slidr_tids":"")+'"/>').insertAfter(o)[0];if(v){e.each(d,function(e,t){var r=new Date(t.date),s="";t.tags.map(function(e){if(u!=e&&!a.ex.readBracketedList().contains(e))s+=i.defaults.fmtTag.format([e])});n+=a.fmtTiddler.format([t.title,r.formatString(a.fmtDateUser?a.fmtDateUser:h&&a.level=="day"?a.fmtDate:a.fmtDateFull),s])});wikify(n.substr(0,1)=="\n"?n.substr(1):n,r)}else{i.renderSliders(r,p,l,c,h)}e(r).slideDown();o.addClass("slidr_open")}},getTids:function(t,n,r,i){var s=0,o=[],u=function(t,n){if(typeof n[0]=="number"){e.each(n[1],function(e,t){u(e,t)})}else{if(!i||n.tags.contains(i)){s++;o.push(n)}}};e.each(n,function(e,t){u(e,t)});return r&&s>=t.min?s:o},formatDate:function(e,t,n,r){return Date.convertFromYYYYMMDDHHMM(String.zeroPad(e,4)+String.zeroPad(t,2)+String.zeroPad(n,2)+"1111").formatString(r)},isValidDate:function(e){var t=/(\d{4})(\d{2})(\d{2})$/.exec(e),n=function(e,t,n){return t>0&&t<13&&e>0&&e<32768&&n>0&&n<=(new Date(e,t,0)).getDate()};return t&&n(t[1],t[2],t[3])}};config.shadowTiddlers["StyleSheetSlidr"]="/*{{{*/\n%0\n/*}}}*/".format([store.getTiddlerText("SlidrPlugin##CSS")]);store.addNotification("StyleSheetSlidr",refreshStyles)})(jQuery)
//}}}

//{{{
/*
!CSS
.slidr{
    clear:left;
    width:90%;
}
.slidr_button,
.viewer .slidr_button{
    width:100%;
    display:block;
    cursor:pointer;
    margin:0;
    padding:0;
    clear:left;
}
.viewer .slidr_title .button{
    border-color:transparent;
}
.viewer .slidr_button:hover .button{
    background:[[ColorPalette::Background]];
}
.viewer .slidr_title{
    padding-left:7px;
}
.viewer .slidr_list .slidr_title{
    padding-left:14px;
}
.viewer .slidr_list .slidr_list .slidr_title{
    padding-left:21px;
}
.slidr_entry:hover,
.slidr_list .slidr_list .slidr_open{
    background:[[ColorPalette::TertiaryPale]];
}
.slidr_open{
    background:[[ColorPalette::SecondaryLight]];
}
.slidr_list .slidr_open{
    background:[[ColorPalette::SecondaryPale]];
}
.slidr_list{
    width:100%;
    display:block;
    display:none;
}
.slidr_list ul,
.slidr_list li{
    margin:0;
    padding:0;
    list-style-type:none;
}
.slidr_clear{
    height:1px;
    clear:both;
}
.slidr_tid,
.slidr_tags,
.slidr_date,
.slidr_entry{
    float:left;
    display:block;
}
.slidr_entry{
    width:100%;
    padding:1px;
}
.slidr_tid{
    margin-left:7px;
}
.slidr_tags{
    float:right;
    text-align:right;
    min-width:300px;
    margin-left:7px;
}
.viewer .slidr_tags .button {
    margin-right:0;
}
.slidr_count{
    float:right;
    margin:0 7px 0 2em;
}
.slidr_tids {
    padding:1px 0;
}
!END
*/
//}}}