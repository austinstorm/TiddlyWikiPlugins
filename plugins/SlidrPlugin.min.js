/***
|''Name''|SlidrPlugin|
|''Description''|shows a tiddler timeline using sliders|
|''Documentation''|http://slidr.tiddlyspace.com|
|''Author''|Tobias Beer|
|''Version''|1.0.6 2013-09-01|
|''CoreVersion''|2.6.5|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/SlidrPlugin.min.js|
|''License''|[[Creative Commons Attribution-Share Alike 3.0|http://creativecommons.org/licenses/by-sa/3.0/]]|
{{{
<<slidr>>
}}}
<<slidr>>
!CODE
***/
//{{{
(function(e){config.macros.slidr={defaults:{txtSliderTooltip:"Click to show tiddlers in %0. CTRL+Click to expand / collapse all.",errDate:"%0 is not a valid start or end date!",lblTiddler1:"tiddler",lblTiddler2:"tiddlers",minGroup:7,openOnLoad:false,level:"month",field:"-modified",exclude:"excludeLists",noDblClick:true,fmtYear:"YYYY",fmtMonth:"MMM, YYYY",fmtDay:"0DD. mmm, YYYY",fmtDate:"0hh:0mm",fmtDateFull:"0DD. mmm, YYYY",fmtSlider:"{{slidr_title{%0}}}{{slidr_count{%1}}}",fmtTiddler:"\n{{slidr_entry{ {{slidr_date{%1}}}"+"{{slidr_tid{[[%0]]}}}"+"{{slidr_tags{%2}}} }}}",fmtTag:"<<tag [[%0]]>>",fmtTagTitle:"<<tag [[%0]]>>",fmtCount:"(%0 %1)"},handler:function(t,n,r,i,s,o){var u,a,l,c,h,p,d,v,m,g,y=[],b,w=[],E=config.messages,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B=this.defaults,j=s.parseParams("anon",null,true),F=store.getTiddlerText(getParam(j,"config","")),I=F?F.parseParams("anon",null,true):j,q=I[0]["anon"]&&I[0]["anon"].contains("tags")?[]:undefined;year=parseInt(getParam(I,"year")),month=parseInt(getParam(I,"month")),day=parseInt(getParam(I,"day")),d=getParam(I,"start"),a=getParam(I,"end"),p=getParam(I,"level",q?"":B.level),ex=getParam(I,"exclude",B.exclude),f=getParam(I,"field",B.field),keep=getParam(I,"keep","").readBracketedList(),filter=getParam(I,"filter",""),format=getParam(I,"format",B.fmtTiddler),template=getParam(I,"template",""),px={open:getParam(I,"open",B.openOnLoad),year:year,month:month,day:day,fmtDate:B.fmtDate,fmtDateUser:getParam(I,"dateformat"),fmtDateFull:getParam(I,"dateformat.full",B.fmtDateFull),fmtYear:getParam(I,"format.year",B.fmtYear),fmtMonth:getParam(I,"format.month",B.fmtMonth),fmtDay:getParam(I,"format.day",B.fmtDay),min:getParam(I,"min",B.minGroup),ex:ex},desc=f.substr(0,1)=="-",last=function(e,t){var n=e[e.length-1],r=[t,[]];if(!n||t!=n[0]){e.push(r);n=e[e.length-1]}return n[1]};if(template){template=store.getTiddlerText(template);if(template)format=template}px.fmtTiddler=format;c=a?!this.isValidDate(a):false;if(c||(d?!this.isValidDate(d):false)){createTiddlyError(t,E.macroError.format(["slidr"]),E.macroErrorDetails.format(["slidr",B.errDate.format([c?a:d])]));return}d=d?Date.convertFromYYYYMMDDHHMM(d):d;a=a?Date.convertFromYYYYMMDDHHMM(a):a;p=p.toLowerCase();p=p.substr(p.length-1)=="s"?p.substr(0,p.length-1):p;px.level=p;h=desc||f.substr(0,1)=="+"?f.substr(1):f;if(filter){y=store.sortTiddlers(store.filterTiddlers(filter),f)}else{y=store.getTiddlers(h);if(desc)y.reverse()}ex=ex.readBracketedList();for(v=0;v<y.length;v++){g=y[v];b=g.tags?g.tags:[];if(!(keep.contains(g.title)||b.containsAny(keep))&&(ex.contains(g.title)||b.containsAny(ex)))continue;ti=g.title;u=g[h]||g.fields[h];if(!u.getMonth)u=Date.convertFromYYYYMMDDHHMM(u);S=u.getYear()+1900;x=u.getMonth()+1;T=u.getDate()+1;N=S==year;C=x==month;k=T==day;L=!year&&!month&&!day;M=year&&!month&&!day;P=year&&month&&!day;H=year&&month&&day;A=!year&&month&&!day;O=!year&&!month&&day;D=year&&!month&&day;_=!year&&month&&day;if((!d||d&&u>=d)&&(!a||a&&u<=a)&&(L||M&&N||A&&C||O&&k||P&&N&&C||_&&C&&k||D&&N&&k||H&&N&&C&&k)){m=last(last(last(w,S),x),T);m.push({title:ti,date:u,tags:g.tags})}if(q){e.each(b,function(e,t){if(!ex.contains(t))q.pushUnique(t)})}}px["yrs"]=w;t=createTiddlyElement(t,"div",null,"slidr");e('<div class="slidr_clear"/>').insertAfter(e(t));e(t).data("params",px);if(B.noDblClick)e(t).dblclick(function(){return false});what=day?"day":month?"month":year?"year":"";if(q)q.sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())});this.renderSliders(t,what,year,month,day,q)},renderSliders:function(t,n,r,i,s,o){var u,a,f=[],l,c=config.macros.slidr,h=[],p=[],d=[],v=e(t).closest(".slidr").data("params"),m=v.yrs,g=function(e,t,n,r,i){f.push({title:e,year:t,month:n,day:r,tids:i})};if(o){e.each(o,function(e,t){l=c.getTids(v,m,v.level?true:false,t);u=typeof l=="object";if(u&&l.length||l>0)g(t,null,null,null,l)})}else{e.each(m,function(t,o){yK=o[0];yV=o[1];if(!n||n=="year"){if(!n||!r||yK==r)g(c.formatDate(yK,"11","11",v.fmtYear),yK,isNaN(i)?null:i,isNaN(s)?null:s,c.getTids(v,yV,v.level=="year"?false:true))}else{e.each(yV,function(t,o){mK=o[0];mV=o[1];if(n=="month"){if((!i||mK==i)&&(!r||yK==r)){g(c.formatDate(yK,mK,"11",v.fmtMonth),yK,mK,isNaN(s)?null:s,c.getTids(v,mV,v.level=="month"?false:true))}}else{e.each(mV,function(e,t){dK=t[0];dV=t[1];if((!s||mK==s)&&(!r||yK==r)&&(!i||mK==i)){g(c.formatDate(yK,mK,dK,v.fmtDay),yK,mK,dK,c.getTids(v,dV))}})}})}})}for(a=0;a<f.length;a++){this.createSlider(t,f[a],n,v.open)}},createSlider:function(t,n,r,i){var s=!n.year;def=config.macros.slidr.defaults,count=parseInt(n.tids)?n.tids:n.tids.length,$s=e(createTiddlyElement(t,"a",null,"button slidr_button",null,{title:def.txtSliderTooltip.format([n.title]),year:n.year,month:n.month,day:n.day})).data("tiddlers",n.tids).click(this.click);if(s)$s.attr("tag",n.title);wikify(def.fmtSlider.format([(s?def.fmtTagTitle:"%0").format([n.title]),def.fmtCount.format([count,count>1?def.lblTiddler2:def.lblTiddler1])]),$s[0]);if(i)$s.click()},click:function(t){var n="",r,i,s,o=config.macros.slidr,u=t||window.event,a=e(resolveTarget(u)).closest(".slidr_button"),f=a.attr("tag"),l=a.closest(".slidr"),c=l.data("params"),h=a.next(),p=parseInt(a.attr("year")),d=parseInt(a.attr("month")),v=parseInt(a.attr("day")),m=v?"tids":d?"day":p?"month":"",g=a.data("tiddlers"),y=typeof g=="object";if(h.hasClass("slidr_list")){if(h.is(":hidden")){h.slideDown();a.addClass("slidr_open")}else{h.find(".slidr_list").slideUp().prev().removeClass("slidr_open");h.slideUp();a.removeClass("slidr_open")}}else{s=e('<div class="slidr_list'+(y?" slidr_tids":"")+'"/>').insertAfter(a)[0];if(y){e.each(g,function(e,t){var r=new Date(t.date),i="";t.tags.map(function(e){if(f!=e&&!c.ex.readBracketedList().contains(e))i+=o.defaults.fmtTag.format([e])});n+=c.fmtTiddler.format([t.title,r.formatString(c.fmtDateUser?c.fmtDateUser:v&&c.level=="day"?c.fmtDate:c.fmtDateFull),i])});wikify(n.substr(0,1)=="\n"?n.substr(1):n,s)}else{o.renderSliders(s,m,p,d,v)}e(s).slideDown();a.addClass("slidr_open")}if(u.ctrlKey){r=a.hasClass("slidr_open");i=c.open=="true";c.open=r;e((!r?" > ":"")+".slidr_button",l).each(function(t){var n=e(this),i=n.hasClass("slidr_open");if(r&&!i||!r&&i){n.click()}});c.open=i?"true":"false"}},getTids:function(t,n,r,i){var s=0,o=[],u=function(t,n){if(typeof n[0]=="number"){e.each(n[1],function(e,t){u(e,t)})}else{if(!i||n.tags.contains(i)){s++;o.push(n)}}};e.each(n,function(e,t){u(e,t)});return!r||s<t.min?o:s},formatDate:function(e,t,n,r){return Date.convertFromYYYYMMDDHHMM(String.zeroPad(e,4)+String.zeroPad(t,2)+String.zeroPad(n,2)+"1111").formatString(r)},isValidDate:function(e){var t=/(\d{4})(\d{2})(\d{2})$/.exec(e),n=function(e,t,n){return t>0&&t<13&&e>0&&e<32768&&n>0&&n<=(new Date(e,t,0)).getDate()};return t&&n(t[1],t[2],t[3])}};config.shadowTiddlers["StyleSheetSlidr"]="/*{{{*/\n%0\n/*}}}*/".format([store.getTiddlerText("SlidrPlugin##CSS")]);store.addNotification("StyleSheetSlidr",refreshStyles)})(jQuery)
//}}}

//{{{
/*
!CSS
.slidr{
    clear:left;
    width:90%;
}
.slidr_button,
.viewer .slidr_button{
    width:100%;
    display:block;
    cursor:pointer;
    margin:0;
    padding:0;
    clear:left;
}
.viewer .slidr_title .button{
    border-color:transparent;
}
.viewer .slidr_button:hover .button{
    background:[[ColorPalette::Background]];
}
.viewer .slidr_title{
    padding-left:7px;
}
.viewer .slidr_list .slidr_title{
    padding-left:14px;
}
.viewer .slidr_list .slidr_list .slidr_title{
    padding-left:21px;
}
.slidr_entry:hover,
.slidr_list .slidr_list .slidr_open{
    background:[[ColorPalette::TertiaryPale]];
}
.slidr_open{
    background:[[ColorPalette::SecondaryLight]];
}
.slidr_list .slidr_open{
    background:[[ColorPalette::SecondaryPale]];
}
.slidr_list{
    width:100%;
    display:block;
    display:none;
}
.slidr_list ul,
.slidr_list li{
    margin:0;
    padding:0;
    list-style-type:none;
}
.slidr_clear{
    height:1px;
    clear:both;
}
.slidr_tid,
.slidr_tags,
.slidr_date,
.slidr_entry{
    float:left;
    display:block;
}
.slidr_entry{
    width:100%;
    padding:1px;
}
.slidr_tid{
    margin-left:7px;
}
.slidr_tags{
    float:right;
    text-align:right;
    min-width:300px;
    max-width:50%;
    margin-left:7px;
}
.viewer .slidr_tags .button {
    margin-right:0;
    display:inline-block;
}
.slidr_count{
    float:right;
    margin:0 7px 0 2em;
}
.slidr_tids {
    padding:1px 0;
}
!END
*/
//}}}