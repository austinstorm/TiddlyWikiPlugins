/***
|''Name''|SlidrPlugin|
|''Description''|shows a tiddler timeline using sliders|
|''Documentation''|http://slidr.tiddlyspace.com|
|''Author''|Tobias Beer|
|''Version''|0.7.0|
|''Status''|beta|
|''CoreVersion''|2.6.5|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/SlidrPlugin.min.js|
|''License''|[[Creative Commons Attribution-Share Alike 3.0|http://creativecommons.org/licenses/by-sa/3.0/]]|
{{{
<<slidr>>
}}}
<<slidr>>
/%***/
(function(e){config.macros.slidr={defaults:{minGroup:7,openOnLoad:false,level:"day",field:"-modified",txtSliderTooltip:"Click to show tiddlers in %0",fmtSlider:"{{slidr_title{%0}}}{{slidr_count{%1}}}",fmtCount:"(%0 %1)",fmtYear:"YYYY",fmtMonth:"MMM, YYYY",fmtDay:"0DD. MMM, YYYY",lblTiddler1:"tiddler",lblTiddler2:"tiddlers",fmtTiddler:"\n|white-space:nowrap;padding-right:5px;%1 |width:100%;[[%0]]|",fmtDate:"0hh:0mm",fmtDateFull:"0DD. MMM, YYYY",errDate:"%0 is not a valid start or end date!"},handler:function(t,n,r,i,s,o){var u,a,f,l,c,h,p,d,v,m,g=[],y=config.messages,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D=this.defaults,P=r[0],H=s.parseParams("anon",null,true),B=parseInt(getParam(H,"year")),j=parseInt(getParam(H,"month")),F=parseInt(getParam(H,"day")),h=getParam(H,"start"),a=getParam(H,"end"),c=getParam(H,"level",D.level),I={open:getParam(H,"open",D.openOnLoad),year:B,month:j,day:F,fmtTiddler:getParam(H,"format",D.fmtTiddler),fmtDate:D.fmtDate,fmtDateUser:getParam(H,"dateformat"),fmtDateFull:getParam(H,"dateformat.full",D.fmtDateFull),fmtYear:getParam(H,"format.year",D.fmtYear),fmtMonth:getParam(H,"format.month",D.fmtMonth),fmtDay:getParam(H,"format.day",D.fmtDay),f:getParam(H,"field",D.field),min:getParam(H,"min",D.minGroup)},q=I.f.substr(0,1)=="-",R=function(e,t){var n=e[e.length-1],r=[t,[]];if(!n||t!=n[0]){e.push(r);n=e[e.length-1]}return n[1]};l=a?!this.isValidDate(a):false;if(l||(h?!this.isValidDate(h):false)){createTiddlyError(t,y.macroError.format(["slidr"]),y.macroErrorDetails.format(["slidr",D.errDate.format([l?a:h])]));return}h=h?Date.convertFromYYYYMMDDHHMM(h):h;a=a?Date.convertFromYYYYMMDDHHMM(a):a;c=c.toLowerCase();c=c.substr(c.length-1)=="s"?c.substr(0,c.length-1):c;I.level=c;I.f=q||I.f.substr(0,1)=="+"?I.f.substr(1):I.f;m=store.getTiddlers(I.f);if(q)m.reverse();for(p=0;p<m.length;p++){v=m[p];ti=v.title;u=v[I.f]||v.fields[I.f];if(!u.getMonth)u=Date.convertFromYYYYMMDDHHMM(u);b=u.getYear()+1900;w=u.getMonth()+1;E=u.getDate()+1;S=b==B;x=w==j;T=E==F;N=!B&&!j&&!F;L=B&&!j&&!F;M=B&&j&&!F;_=B&&j&&F;C=!B&&j&&!F;k=!B&&!j&&F;O=B&&!j&&F;A=!B&&j&&F;if((!h||h&&u>=h)&&(!a||a&&u<=a)&&(N||L&&S||C&&x||k&&T||M&&S&&x||A&&x&&T||O&&S&&T||_&&S&&x&&T)){d=R(R(R(g,b),w),E);d.push({title:ti,date:u})}}I["yrs"]=g;t=createTiddlyElement(t,"div",null,"slidr");e('<div class="slidr_clear"/>').insertAfter(e(t));e(t).data("params",I);what=F?"day":j?"month":B?"year":"";this.renderSliders(t,what,B,j,F)},renderSliders:function(t,n,r,i,s){var o,u=[],a=config.macros.slidr,f=[],l=[],c=[],h=e(t).closest(".slidr").data("params"),p=h.yrs,d=function(e,t,n,r,i){u.push({title:e,year:t,month:n,day:r,tids:i})};e.each(p,function(t,o){yK=o[0];yV=o[1];if(!n||n=="year"){if(!n||!r||yK==r)d(a.formatDate(yK,"11","11",h.fmtYear),yK,isNaN(i)?null:i,isNaN(s)?null:s,a.getTids(h,yV,h.level=="year"?false:true))}else{e.each(yV,function(t,o){mK=o[0];mV=o[1];if(n=="month"){if((!i||mK==i)&&(!r||yK==r)){d(a.formatDate(yK,mK,"11",h.fmtMonth),yK,mK,isNaN(s)?null:s,a.getTids(h,mV,h.level=="month"?false:true))}}else{e.each(mV,function(e,t){dK=t[0];dV=t[1];if((!s||mK==s)&&(!r||yK==r)&&(!i||mK==i)){d(a.formatDate(yK,mK,dK,h.fmtDay),yK,mK,dK,a.getTids(h,dV))}})}})}});for(o=0;o<u.length;o++){this.createSlider(t,u[o],n,h.open)}},createSlider:function(t,n,r,i){var s,o=config.macros.slidr.defaults,u=parseInt(n.tids)?n.tids:n.tids.length;s=e(createTiddlyElement(t,"a",null,"button slidr_button",null,{title:o.txtSliderTooltip.format([n.title]),year:n.year,month:n.month,day:n.day})).data("tiddlers",n.tids).click(this.click);wikify(o.fmtSlider.format([n.title,o.fmtCount.format([u,u>1?o.lblTiddler2:o.lblTiddler1])]),s[0]);if(i)s.click()},click:function(t){var n="",r,i=config.macros.slidr,s=t||window.event,o=e(resolveTarget(s)).closest(".slidr_button")[0],u=e(o).closest(".slidr").data("params"),a=e(o).next(),f=e(o).attr("year"),l=e(o).attr("month"),c=e(o).attr("day"),h=c?"tids":l?"day":f?"month":"",p=e(o).data("tiddlers"),d=typeof p=="object";if(a.hasClass("slidr_list")){if(a.is(":hidden")){a.slideDown()}else{a.find(".slidr_list").slideUp();a.slideUp()}}else{r=e('<div class="slidr_list'+(d?" slidr_tids":"")+'"/>').insertAfter(e(o))[0];if(d){e.each(p,function(e,t){var r=new Date(t.date);n+=u.fmtTiddler.format([t.title,r.formatString(u.fmtDateUser?u.fmtDateUser:u.level!="day"||p.length==1&&!c?u.fmtDateFull:u.fmtDate)])});wikify(n.substr(0,1)=="\n"?n.substr(1):n,r)}else{i.renderSliders(r,h,f,l,c)}e(r).slideDown()}},getTids:function(t,n,r){var i=0,s=[],o=function(t,n){if(typeof n[0]=="number"){e.each(n[1],function(e,t){o(e,t)})}else{i++;s.push(n)}};e.each(n,function(e,t){o(e,t)});return r&&i>=t.min?i:s},formatDate:function(e,t,n,r){return Date.convertFromYYYYMMDDHHMM(String.zeroPad(e,4)+String.zeroPad(t,2)+String.zeroPad(n,2)+"1111").formatString(r)},isValidDate:function(e){var t=/(\d{4})(\d{2})(\d{2})$/.exec(e),n=function(e,t,n){return t>0&&t<13&&e>0&&e<32768&&n>0&&n<=(new Date(e,t,0)).getDate()};return t&&n(t[1],t[2],t[3])}};config.shadowTiddlers["StyleSheetSlidr"]="/*{{{*/\n%0\n/*}}}*/".format([store.getTiddlerText("SlidrPlugin##CSS")]);store.addNotification("StyleSheetSlidr",refreshStyles)})(jQuery)
//%/
//{{{
/*
!CSS
.slidr{
    float:left;
    clear:left;
    min-width:550px;
}
.slidr_button,
.viewer .slidr_button{
    display:block;
    clear:left;
    cursor:pointer;
    margin:0;
}
.slidr_list{
    margin-left:1em;
    display:block;
    clear:left;
    display:none;
}
.slidr_list .slidr_tids{
    padding: 5px 0;
}
.slidr_list ul,
.slidr_list li{
    margin:0;
    padding:0;
    list-style-type:none;
}
.slidr_clear{
    height:1px;
    clear:both;
}
.slidr_list table{
    min-width:500px;
}
.slidr_list .twtable td,
.slidr_list .twtable tr,
.slidr_list .twtable,
.viewer .slidr_list .twtable td,
.viewer .slidr_list .twtable tr,
.viewer .slidr_list .twtable{
    border:0 !important;
    margin:0 !important;
    padding:0;
}
.slidr_list table .tiddlyLink {
    display:block;
}
.slidr_count{
    float:right;
}
!END
*/
//}}}