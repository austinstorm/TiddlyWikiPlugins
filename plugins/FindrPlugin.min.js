/***
|''Name''|FindrPlugin|
|''Description''|display search results in a list with more flexibility|
|''Documentation''|http://findr.tiddlyspace.com|
|''Authors''|Tobias Beer|
|''Version''|1.1.0 (2013-10-11)|
|''CoreVersion''|2.5.2|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/FindrPlugin.min.js|
|''License''|[[Creative Commons Attribution-ShareAlike 3.0 License|http://creativecommons.org/licenses/by-sa/3.0/]]|
***/
///%
(function(e){var t=config.macros.findr={config:{where:"",fallback:"#displayArea",how:"prependTo",hide:"",empty:false,listfiltr:true,fields:"",exclude:"excludeSearch",categories:"title tags text fields",sort:"title",id:"searchResults",idClose:"search_close",idOpenAll:"search_open",fmtHeader:"\n!Search Results",fmtMessage:"\n''%0''",fmtItems:"\n{{search_list{%0\n}}}\n",fmtItem:"\n* [[%0]]",fmtCategory:"\n;%0",fmtItemByCat:"\n:[[%0]]%1",fmtDetails:" {{search_details{(%0)}}}",fmtQuery:"'%0'",fmtRegExp:"/%0/",btnCloseLabel:"close",btnCloseTooltip:"dismiss search results",btnOpenLabel:"open all",btnOpenTooltip:"open all search results",cattitle:"in the title...",cattags:"in tags...",cattext:"in the text...",catfields:"in fields...",catfieldsField:"''%0'' ",cattagsTag:"<<tag [[%0]]>> "}};merge(config.macros.findr,{handler:function(e,t,n,r,i,s){wikify("<<search>>",e)},displayResults:function(n,r,i,s){var o,u,a,f="",l=s.categories||"",c=e(s.where).first(),h=0,p=[],d=[];e.each(n,function(e,t){h+=t.length;if(!l)d.concat(t)});e("#"+s.id).remove();story.refreshAllTiddlers(true);r='"""%0"""'.format(s[i?"fmtQuery":"fmtRegExp"].format(i?s.fmtRegExp.format(r):r));e(s.hide).hide();if(!c.length)c=e(s.fallback);if(s.empty)c.empty();el=e("<div/>").attr("id",s.id);switch(s.how){case"insertAfter":el.insertAfter(c);break;case"insertBefore":el.insertBefore(c);break;case"appendTo":el.appendTo(c);break;default:el.prependTo(c)}el=e('<div class="findr"/>').appendTo(el);el=el[0];if(h){u=s.fmtMessage.format(config.macros.search.successMsg.format([h,r]));s.results=[];(l?l:"tids").readBracketedList().map(function(t){var r=t=="tids"?d:n[t]||[],i=s.sort,o=i.substr(0,1)=="-";if(o)i=i.substr(1);r.sort(function(e,t){var n=e[0][i].toLowerCase()<t[0][i].toLowerCase()?o?+1:-1:e[0][i].toLowerCase()==t[0][i].toLowerCase()?0:o?-1:+1;return n});if(l&&r.length){f+=s.fmtCategory.format(s["cat"+t])}r.map(function(n){var r="",i=n[0];(n[1]||[]).map(function(e){r+=s[t=="tags"?"cattagsTag":"catfieldsField"].format(e)});p.push(i.title);f+=s[l?"fmtItemByCat":"fmtItem"].format(i.title,r?s.fmtDetails.format(e.trim(r)):"")})})}else{u=s.fmtMessage.format(config.macros.search.failureMsg.format([r]))}o=createTiddlyElement(el,"div","findr-buttons");createTiddlyButton(o,s.btnCloseLabel,s.btnCloseTooltip,t.closeResults,"button",s.idClose);if(h){createTiddlyButton(o,s.btnOpenLabel,s.btnOpenTooltip,t.openAll,"button",s.idOpenAll)}a=s.fmtHeader+u+s.fmtItems.format(f)+(s.listfiltr&&config.macros.listfiltr?"<<listfiltr>>":"");wikify(a,el);e(el).data({tids:p,options:s})},closeResults:function(t){var n=e(this).closest(".findr").data("options"),r=e("#"+n.id),i=r.closest('[refresh="content"]')[0];e(n.hide).show();if(i)config.refreshers.content(i);r.remove();highlightHack=null},openAll:function(t){tids=e(this).closest(".findr").data("tids");story.displayTiddlers(null,tids);return false},search:function(t,n,r){var i={title:[],tags:[],text:[],fields:[]},s=r.exclude.readBracketedList(),o=r.fields.readBracketedList(),u=function(e,t,n){i[t].push([e,n])};store.forEachTiddler(function(n,r){if(s.contains(r.title)||s.containsAny(r.tags))return true;if(-1!=r.title.search(t)){u(r,"title")}else if(-1!=r.tags.join(", ").search(t)){u(r,"tags",r.tags)}else if(-1!=r.text.search(t)){u(r,"text")}else if(o.length&&r.fields){var i=[];e.each(r.fields||{},function(e,n){if(o.contains(e)&&-1!=(n||"").search(t)){i.push(e)}});if(i.length)u(r,"fields",i)}});return i}});Story.prototype.search=function(e,n,r){highlightHack=new RegExp(r?e:e.escapeRegExp(),n?"mg":"img");t.displayResults(t.search(highlightHack,"text",t.config),e,r,t.config)};config.macros.search.onKeyPressFINDR=config.macros.search.onKeyPress;config.macros.search.onKeyPress=function(n){e(this).off("search").on("search",config.macros.search.onKeyPress);if(this.value.length<3){var r=e("#"+t.config.id);if(r.length){e("#"+t.config.idClose).click()}}else{config.macros.search.onKeyPressFINDR.apply(this,arguments)}}})(jQuery)
//%/