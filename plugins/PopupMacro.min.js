/***
|''Name:''|~PopupMacro|
|''Description:''|create (nested) popups with custom content|
|''Documentation:''|http://tobibeer.tiddlyspace.com/#Popup|
|''Author:''|Tobias Beer (original author: Saq Imtiaz)|
|''Version:''|1.5.0 (2013-10-13)|
|''CoreVersion:''|2.5.3 or better|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/PopupMacro.min.js|
/%***/
(function(e){var t=config.macros.popup={hover:true,toggle:false,sticky:false,arrow:document.all?" ▼":" ▾",hoverables:"#mainMenu",showAfter:400,showStandardAfter:800,enableHover:".button[tag], .tiddlyLink[tag]",disableHover:".slidr_button",err1:"missing macro parameters",err2:"missing label or content parameter",handler:function(n,r,i,s,o,u){var a,f,l,c,h,p=o.parseParams("anon",null,true),d={content:(i[1]||"").replace(/(\$\)\)|\>\+\>)/g,">>"),arrow:getParam(p,"arrow",t.arrow)},v=getParam(p,"class","");f=i[0];if(!f||!d.content){createTiddlyError(n,t.err1,t.err2);return false}["sticky","toggle","hover"].map(function(e){var n=getParam(p,e,t[e]);d[e]=i.contains("no"+e)?false:n||i.contains(e);if(n=="true")d[e]=1;if(n=="false")d[e]=0});if(i.contains("noarrow"))d.arrow="";a=e(createTiddlyButton(n,f+d.arrow,f,d.toggle?t.toggleButton:t.show,"button popupbutton"+(v?" "+v:""),null,null));d.popclass="popup popupmacro"+(t.inPopup(a)?" nested":"")+(v?" "+v:"");d.show=!d.hover;a.data(d);if(d.hover){a.on("mouseover",t.showAfter?t.delay:t.show);a.on("mouseout",t.abort)}},delay:function(n){var r=e(this.innerHTML?this:n);r.data("show",true);setTimeout(function(){if(r.data("show")){if(r.is(".popupbutton"))t.show(r[0]);else r.click()}},r.is(".popupbutton")?t.showAfter:t.showStandardAfter)},abort:function(t){e(this).data("show",false)},toggleButton:function(n){var r=e(this),i=r.data("popup");if(i)Popup.removeFrom(e(i).data("level"));else t.show.apply(this,arguments)},show:function(n){n=n||window.event;var r,i=Popup.stack.length,s=e(this.innerHTML?this:n),o=t.inPopup(s),u=o?s.closest(".popup").data("level"):0;if(!s.data("popup")){if(!o&&i)Popup.removeFrom(0);else if(o&&i>1){i=u+1;Popup.removeFrom(i)}r=createTiddlyElement(document.body,"ol",null,s.data("popclass")+(i?" nested"+i:""),null);s.data("popup",r).addClass("popupopen");e(r).data({button:s,level:i,sticky:s.data("sticky")}).click(t.popupClick);Popup.stack.push({root:s[0],popup:r});wikify(s.data("content"),r);Popup.show(r,true)}if(n){n.cancelBubble=true;if(n.stopPropagation)n.stopPropagation()}return false},popupClick:function(t){var t=t||window.event,n=e(this).closest(".popup"),r=resolveTarget(t),i=e(r).closest("a").length;Popup.removeFrom(n.data("level")+1);if(i&&!n.data("sticky")){Popup.remove()}else{t.cancelBubble=true;if(t.stopPropagation)t.stopPropagation()}return false},inPopup:function(t){return e(t).closest(".popup").length},linkOver:function(n){var r=e(this),i=r.closest(".popup").data("level")||0;Popup.removeFrom(i);if((r.is(t.enableHover)||r.data("tiddlers"))&&!r.is(t.disableHover))t.delay(r)},makeHoverable:function(n){var r=e(n);if(r.is("a")&&r.closest(t.hoverables).length&&!r.is(".popupbutton")){r.off("mouseover",t.linkOver);r.on("mouseover",t.linkOver);r.off("mouseout",t.abort);r.on("mouseout",t.abort)}}};window.refreshElementsPOPUP=window.refreshElements,window.refreshElements=function(n,r){window.refreshElementsPOPUP.apply(this,arguments);var i=e(n);e("a",i).add(i).each(function(){t.makeHoverable(this)})};window.invokeMacroPOPUP=window.invokeMacro;window.invokeMacro=function(r,i,s,o,u){window.invokeMacroPOPUP.apply(this,arguments);var a=e(r.lastChild);e("a",a).add(a).each(function(){t.makeHoverable(this)})};Popup.removeFromPOPUP=Popup.removeFrom;Popup.removeFrom=function(t){var n,r,i;for(i=Popup.stack.length-1;i>=t;i--){r=Popup.stack[i],e(r.root).removeData("popup").removeClass("popupopen")}Popup.removeFromPOPUP.apply(this,arguments)};setStylesheet(".nested {padding:3px;margin:-0.5em 0 0 2em !important;}"+".popupbutton {cursor:pointer};","PopupMacroStyles")})(jQuery)
//}%/