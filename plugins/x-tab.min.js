/***
<<xtab defaults:true>>
|''Name''|x-tab|
|''Description''|a crosstable for tags|
|''Documentation''|http://tbGTD.tiddlyspot.com/#%5B%5Bx-tab%20info%5D%5D|
|''Version''|1.0|
|''Type''|macro|
|''Author''|[[TobiasBeer]]|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/x-tab.min.js|
|''License''|[[Creative Commons Attribution-Share Alike 3.0|http://creativecommons.org/licenses/by-sa/3.0/]]|
!Code
/%***/
setStylesheet(".xtabBtn{cursor:pointer}"+".xtab{margin:5px 0 20px 0;background:#F6F6F6;padding:10px;border:5px solid #EEE;-moz-border-radius:5px;-webkit-border-radius:5px;}"+".xtabFrm td{vertical-align:bottom;height:30px;margin-right:10px !important;}"+".xtabFrm em{margin-left:10px;font-style:normal;color:#39C;font-weight:bold;font-size:90%;}"+".xtabFrm input{margin-left:10px;}.xtabFrm input,.xtabFrm span{cursor:pointer;}.xtabFrm .externalLink{margin-left:10px;}"+".xtabFrm select{padding-right:0 !important;width:210px;cursor:pointer;float:right;}"+".xtabFrm xtabToggle{display:inline-block;width:65px;text-align:center;cursor:pointer;margin-right:10px;}"+".xtabPrv{color:#888;margin:5px 0 10px 50px;display:block;}.xtabPrv span{color:#39C;}"+".xtabOut {max-width:100%;overflow-y:hidden;}"+".viewer .xtabOut .button{margin:0;}","StyleSheetGTDxLookup");config.macros.xtab={cfg:{defaults:["x-tab config##Tags","x-tab config##Presets","x-tab config##Detect","xtab"],dropClass:"button",resultTabClass:"",miniTag:"<<tiddler scripts##miniTag with: [[%0]]>>",addNew:true,headerRightFrom:10,pRows:"rows",pCols:"cols",pSec:"snd",pOps:"options",pOpAL:"ALLTAGS!",pOpSR:"1row",pOpSC:"1col",pOpTR:"transpose",info:"info",btnShow:"x-tab",btnHide:"hide x-tab",btnTip:"toggle x-tab panel",template:"preset template... ",noTags:"No valid tags provided for x-tab. ",nOkTags:"Invalid taglist for x-tab! '%0' could not be found.",nOkPresets:"Invalid presets for x-tab! '%0' could not be found.",nOkPreset:"Invalid x-tab preset! No option '%0' in dropdown '%1'. Check your custom fields or parameters.",nOkRender:"Could not render x-tab into %0. No such dom-element!",nOkDetect:"Invalid x-tab parameter '%0' for 'detect'!",nOkField:"x-tab can't find field '%0' for tiddler '%1'.",nDef:"undefined",P:["preset:","select a preset","select preset..."],R:["rows:","select a category tag for rows","select rows tag..."],C:["columns:","select a category tag for columns","select columns tag..."],S:["secondary:","select secondary for rows (first select a tag-category for rows)","select secondary..."],TR:["transpose","click to swap rows and columns"],SR:["1row","use the tag in 'rows' or 'secondary' directly instead of its subtags"],SC:["1col","use the tag in 'columns' directly instead of its subtags"],AL:["all tags","use all available tags for dropdowns"],PT:["template","provides a template which you can use to add to your list of preset definitions"]},handler:function(e,t,n,r,i,s){this.cfg.drop=document.all?"▼":"▾";var o,u,a=i,f=n[0];u=(new Date).getTime()+(""+Math.random()).substr(5);if(f&&f.toUpperCase().indexOf("BUTTON")==0){o=createTiddlyButton(e,this.cfg.btnShow+this.cfg.drop,this.cfg.btnTip,this.toggle,"button xtabBtn");jQuery(o).attr({tiddler:f.substr(7),params:a,xtabid:u})}else this.create(u,a,e)},toggle:function(e){var t,n,r=false;x=config.macros.xtab,t=x.cfg;n=document.getElementById("xtab"+this.getAttribute("xtabid")||"");if(n){r=n.style.display!="none";n.style.display=r?"none":"block"}else x.create(this);this.innerHTML=(r?t.btnShow:t.btnHide)+t.drop;return false},update:function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d="",v,m,g,y="",b,w,E,S,x,T,N,C,k,L,A,O,M,_=config.macros.xtab,s=_.cfg;i=function(e){return document.getElementById(e)};c=i("xtabFrm"+e);l=i("xtabOut"+e);b=i("xtabPrv"+e);removeChildren(l);removeChildren(b);S=i("SR"+e).checked;E=i("SC"+e).checked;L=i("TR"+e).checked;r=i("AL"+e).checked;x=i("snd"+e);u=i("cols"+e);w=i("rows"+e);a=x.selectedIndex>0?x:i("rows"+e);f=i("cols"+e);if(L){A=a;a=f;f=A}O=a.selectedIndex==0?null:a.value;M=f.selectedIndex==0?null:f.value;if(O&&M){t=E&&L?[store.getTiddler(O)]:S&&!L?[store.getTiddler(O)]:store.getTaggedTiddlers(O);n=E&&!L?[store.getTiddler(M)]:S&&L?[store.getTiddler(M)]:store.getTaggedTiddlers(M);h="▼"+O;if(E&&L||S&&!L)h="";v=M+"▶";if(S&&L||E&&!L)v="";p='"""'+(h&&v?h+"/ "+v:h?h:v)+'"""';if(n.length>=s.headerRightFrom){v=v?"◀"+M:"";d='"""'+(h&&v?v+"/ "+h:h?h:v)+'"""'}y="|"+s.resultTabClass+"|k\n| "+p;for(k=0;k<n.length;k++){N=n[k].title;m=s.addNew?tbGTD.nu(N):"";y+=" | "+m+"<<tag [["+N+"]]>>"}y+=(d!=""?"|"+d:"")+" |h\n";for(C=0;C<t.length;C++){N=t[C].title;m=s.addNew?tbGTD.nu(N):"";p="<<tag [["+N+"]]>>";y+="| !"+m+p;for(k=0;k<n.length;k++){y+="|";tgt=store.getTaggedTiddlers(t[C].title);for(T=0;T<tgt.length;T++){if(tgt[T].tags.contains(n[k].title)){N=tgt[T].title;y+="@@margin:0;<<tag [["+N+"]]>>"+s.miniTag.format([N])+"@@<br />"}}}y+=(d!=""?"|"+p+" ":"")+"|\n"}if(i("PT"+e).checked){o=function(e){return e.indexOf(" ")>=0?"'"+e+"'":e};g=S||E||L;g=g?s.pOps+":"+(S?s.pOpSR:"")+(E?(S?"&":"")+s.pOpSC:"")+(L?(S||E?"&":"")+s.pOpTR:""):"";A=x.value;A=x.selectedIndex==0?"":A;O=w.value;M=u.value;wikify(s.template+"@@font-weight:bold;"+(r?s.pOpAL:"")+o(A)+" "+o(O)+" by "+o(M)+"=="+s.pRows+":"+o(O)+" "+(A?s.pSec+":"+o(A)+" ":"")+s.pCols+":"+o(M)+" "+o(g)+"@@",b)}}wikify(y,l)},create:function(e,t,n,r){var i,s,o,u=this.cfg,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L=[],A,O,M=[],_,D,P=false;if(typeof e=="object"){S=e;_=e.getAttribute("tiddler");if(_=="")n=story.findContainingTiddler(e);else{P=_.toUpperCase().indexOf("ID==")==0;n=P?document.getElementById(_.substr(4)):story.getTiddler(n)}if(!n)alert(u.nOkRender.format([_]));else{k=n.getAttribute("tiddler");if(!P)n=jQuery(".viewer",n)[0];t=e.getAttribute("params");e=e.getAttribute("xtabid")}}if(!k){k=story.findContainingTiddler(n);if(k)k=k.getAttribute("tiddler")}g=t.parseParams(null,null,true);def=getParam(g,"defaults","").toUpperCase()=="TRUE";D=getParam(g,"taglist");if(!D&&def&&u.defaults[0])D=u.defaults[0];y=getParam(g,"presets");if(!y&&def&&u.defaults[1])y=u.defaults[1];h=getParam(g,"detect","");if(!h&&def&&u.defaults[2])h=u.defaults[2];w=getParam(g,"preset","");if(!w&&def&&u.defaults[3])w=u.defaults[3];b=getParam(g,"position","").toUpperCase();s=w.toUpperCase().indexOf(u.pOpAL)==0;if(s)w=w.substr(u.pOpAL.length);i=r||!D||s&&r==undefined;if(i){M=store.getTags()}else{if(D){M=store.getTiddlerText(D);if(!M)alert(u.nOkTags.format([D]));else M=M.readBracketedList()}if(M.length==0&&!i)alert(u.noTags)}if(y){E=store.getTiddlerText(y);if(!E)alert(u.nOkTags.format([y]));else E=E.split("\n")}c=u.dropClass;a=createTiddlyElement;if(r==undefined){x=document.createElement("span");if(b=="FIRST")n.insertBefore(x,n.firstChild);else if(!P&&S&&b!="LAST")n.insertBefore(x,S.nextSibling);else n.appendChild(x)}else x=n;n=a(x,"div","xtab"+e,"xtab");p=a(n,"form","xtabFrm"+e,"xtabFrm");p.setAttribute("params",t);wikify("|borderless|k\n|||>|\n||||\n",p);O=p.lastChild.getElementsByTagName("td");A=O[1];this.nuSel(O[0],"presets",E,u.P,"P",c);f=[["PT","tmpl"],["TR","trans"],["SR","oner"],["SC","onec"],["AL","allt",i]];for(m=0;m<f.length;m++)this.nuChk(A,f[m][0]+e,f[m][1],u[f[m][0]],c,f[m][2]);createExternalLink(A,store.getTiddlerSlice("x-tab","Documentation"),u.info);this.nuSel(O[2],"rows",M,u.R,i?"A":"R",c,e);this.nuSel(O[3],"snd",[],u.S,"S",c,e);this.nuSel(O[4],"cols",M,u.C,i?"A":"C",c,e);a(n,"div","xtabPrv"+e,"xtabPrv");a(n,"div","xtabOut"+e,"xtabOut");if(w.indexOf(":")<=0){o=w.indexOf("@");if(o>0){C=w.substr(o+1);k=store.getTiddler(C);w=w.substr(0,o);if(!k)alert(u.nOkField.format([w,C]));else k=k.title}w=store.getValue(k,w)}if(k&&h&&!w)w=this.detect(h,k);this.setPreset(e,w,r);return e},nuChk:function(e,t,n,r,i,s){var o,u;u=createTiddlyElement(e,"input",t,null,null,{type:"checkbox",name:n,value:r[0]});u.checked=s?s:false;u.onclick=this.check;o=createTiddlyElement(e,"span",null,i+" xtabToggle",r[0],{title:r[1],toggle:t});o.onclick=this.check;return u},check:function(e){var t,n,r,i,s,o,u=config.macros.xtab,a;t=document.getElementById(this.getAttribute("toggle"));if(t)t.checked=!t.checked;n=t?t:this;i=n.getAttribute("id").substr(2);if(n.name=="allt"){t=n.checked;r=n.form;n=r.parentNode;o=n.parentNode;a=r.getAttribute("params");removeChildren(n);o.removeChild(n);u.create(i,a,o,t)}else u.update(i)},nuSel:function(e,t,n,r,i,s,o){createTiddlyElement(e,"em",null,null,r[0]);var u=createTiddlyElement(e,"select",t+o,s,null,{name:t,title:r[1]});u.onchange=this.chgSel;this.setOpt(u,n,null,i,r[2])},setOpt:function(e,t,r,i,s){if(r&&e.getAttribute("cat")==r)return;var o,u,a;u=t?t.length:0;a=e.options;e.disabled=u==0;while(a.length>1)a[a.length-1]=null;a[0]=new Option(s,null,false,false);if(u){for(o=0;o<u;o++){var f=t[o];switch(i){case"P":f=f.split("==");n=f[0];v=f[1];break;case"A":n=v=f[0];break;case"S":f=f.title;default:n=f;v=f}a[a.length]=new Option(n,v,false,false)}}},chgSel:function(e){var t=config.macros.xtab,n=this.form.getAttribute("id").substr(7);switch(this.name){case"presets":if(this.selectedIndex>0)t.setPreset(n,this.value);break;case"rows":t.initSecondary(n);default:t.update(n)}},initSecondary:function(e){var t,n,r,i;n=document.getElementById("rows"+e);i=n.value;t=document.getElementById("snd"+e);r=n.selectedIndex>0?store.getTaggedTiddlers(i):[];this.setOpt(t,r,i,"S",this.cfg.S[2]);t.setAttribute("cat",i?i:"")},setPreset:function(e,t,n){var r,i,s,o,u,a,f,l=this.cfg,c=l.nDef;if(t){i=document.getElementById("xtabFrm"+e);a=t.parseParams(null,null,false);o=[["rows",getParam(a,l.pRows,c),l.pRows],["cols",getParam(a,l.pCols,c),l.pCols],["snd",getParam(a,l.pSec),l.pSec]];document.getElementById("snd"+e).selectedIndex=0;for(s=0;s<o.length;s++){if(o[s][1]&&!this.chkSel(e,o[s],i))return false}u=getParam(a,l.pOps,"");f=function(t,n){document.getElementById(t+e).checked=u.indexOf(n)>=0};f("TR",l.pOpTR);f("SR",l.pOpSR);f("SC",l.pOpSC);if(n==undefined)f("AL",l.pOpAT)}this.update(e)},detect:function(e,t){var n,r,i,s,o,u,a=this.cfg;r=store.getTiddlerText(e);f=[a.pRows+":[[%0]] "+a.pCols+":[[%1]]",a.pRows+":[[%0]] "+a.pCols+":[[%1]] "+a.pSec+":[[%2]] "+a.pOps+":"+a.pOpTR+"&"+a.pOpSR,a.pRows+":[[%0]] "+a.pCols+":[[%1]] "+a.pSec+":[[%2]] "+a.pOps+":"+a.pOpTR];if(!r)alert(a.nOkDetect.format([e]));else{n=r.split("\n");while(n.length>0){i=n.shift().readBracketedList();s=i.length;if(t==i[0]){switch(s){case 3:return f[2].format([i[0],i[1],i[2]]);case 2:case 4:return f[0].format([i[0],i[1]])}}else{o=store.getTiddler(t);if(o.tags.contains(i[0])){switch(s){case 3:return f[2].format([i[0],i[1],t]);case 2:case 4:return f[1].format([i[0],i[1],t])}}}}}},chkSel:function(e,t,n){var r="",i,s,o,u;s=document.getElementById(t[0]+e);u=t[1];if(s){i=s.options;for(o=1;o<i.length;o++){r=i[o].value;if(u==r){s.selectedIndex=o;break}}}if(u!=r){alert(this.cfg.nOkPreset.format([u,t[2]]));return false}if(t[0]=="rows")this.initSecondary(e);return true}}
//%/