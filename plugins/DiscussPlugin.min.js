/***
|''Name''|DiscussPlugin|
|''Author''|[[Tobias Beer|http://tobibeer.tiddlyspace.com]]|
|''Description''|outputs the (modified) html representation with disqus in an iframe for a tiddler on TiddlySpace|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/DiscussPlugin.min.js|
|''Documentation''|http://discuss.tiddlyspace.com|
|''Version''|0.9.3 (2013-09-06)|
|''~CoreVersion''|2.5.2|
|''Requires''|TiddlySpace / TiddlyWeb|
|''License''|Creative Commons 3.0|
***/
// /%
(function(e){config.macros.discuss={config:{always:false,tplSlider:'Show comments for \'\'"""%0"""\'\'  """//""" <<discuss count [[%0]]>>',tipSlider:"Click to show comments for %0...",url:"",header:"{{discuss_header{\nLeave a comment at tiddler [[%0]]...\n}}}",css:{width:"100%",height:"400px",border:"0",marginTop:"1em"}},handler:function(t,n,r,i,s,o){var u,a,f,l=this.config,c=o?o.title:"",h=s.parseParams("anon",null,true),p=getParam(h,"always",l.always),d=store.getTiddlerText(getParam(h,"template",""));if(r[0]=="count"){this.count(r[1],t);return}if(!c||!store.getTiddler(c))return;a=e('<div class="discuss_panel"/>').attr({url:getParam(h,"url",l.url)+"/"+encodeURIComponent(c),title:c}).css("marginTop","1em").appendTo(e(t));if(p){wikify(l.header.format([c]),a[0]);this.render(a[0])}else{u=e("<div/></div>").attr({"class":"button discuss_button",title:l.tipSlider.format([c])}).css({cursor:"pointer",padding:"0.5em 1%",width:"98%"}).appendTo(a).click(this.show);wikify((d?d:l.tplSlider).format([c]),u[0])}},render:function(t,n){var r=config.macros.discuss.config,i=e(t).closest(".discuss_panel");e("<iframe/>").hide().css(r.css).attr({src:i.attr("url")}).appendTo(i).slideDown()},show:function(t){console.log("click");var n=e(this),r=e(resolveTarget(t||window.event));if(!r.is(".discuss_button, .discuss_count")&&r.is("a"))return true;config.macros.discuss.render(n[0],true);n.remove();return false},count:function(t,n){config.extensions.tiddlyweb.getStatus(function(){var r,i=config.extensions.tiddlyspace.currentSpace.name,s=config.extensions.tiddlyspace.getHost(config.extensions.tiddlyweb.status.server_host,i);e("<a/>").attr({"class":"discuss_count","data-disqus-identifier":t,href:s+"/"+encodeURIComponent(t)+"#disqus_thread"}).appendTo(n);r=document.createElement("script");r.async=true;r.type="text/javascript";r.src="http://"+i+"-tiddlyspace.disqus.com/count.js";console.log(r);(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(r)})}}})(jQuery)
// %/