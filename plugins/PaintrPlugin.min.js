/***
|''Name''|PaintrPlugin|
|''Description''|allows to conditionally style internal links, tag buttons, titles and entire tiddlers depending on tiddler tags or title|
|''Documentation''|http://paintr.tiddlyspace.com|
|''Configuration''|PaintrConfig|
|''Author''|[[Tobias Beer|http://tobibeer.tiddlyspace.com]]|
|''Version''|2.0.0 (2013-10-02)|
|''CoreVersion''|2.5.2|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/PaintrPlugin.min.js|
|''License''|[[Creative Commons Attribution-Share Alike 3.0|http://creativecommons.org/licenses/by-sa/3.0/]]|
***/
// /%
(function(e){config.shadowTiddlers.PaintrConfig=["Need help with PaintrPlugin? [[Visit the documentation!|http://paintr.tiddlyspace.com]]","!Defaults","''what:'' links tags titles","''exclude:'' no-paint","''defaultClass:'' paintr","''titleSelector:'' div.title","''allow:''","''transclude:'' tiddler section","!StyleSheet","/* demo styles, can be safely deleted or adapted*/","/*{{{*/",".viewer .paintr.tiddlyLink {padding:0 2px; margin: 0 -2px;}\n",".demo, .demo.title {color:red !important;}","a.demo:hover {background:red !important; color:white !important;}",".tiddler.beach, .beach.paintr-transclude {background:lightyellow;}",".beach.paintr-transclude {display:block;padding:10px;}",".beach .tagInfo {background:#eef;}","/*}}}*/","!Definitions","GettingStarted demo","----","tiddler=PaintrConfig title:demo tiddler:beach"].join("\n");var t=config.extensions.paintr={config:"PaintrConfig",what:"links tags titles",exclude:"no-paint",defaultClass:"paintr",titleSelector:"div.title",transclude:"tiddler section",allow:"",paint:function(n,r,i,s){var o="",u,a=[],f,l=t.exclude.readBracketedList(),c=e(n).parents("[tiddler]").last().attr("tiddler")||"",h=store.getTiddler(c);if(h&&(l.contains(h.title)||h.tags&&h.tags.containsAny(l)))return;h=store.getTiddler(r);t.definitions.map(function(e,n){var u=t.classes[e],a=u["single"],l=u["transclude"];if(f!==""&&(!f||f=="*"||f.contains(e))&&(r==e||h&&h.tags&&h.tags.contains(e)&&!a)&&(!s||l.indexOf(s)>=0)){if(f==undefined||f=="*"){f=t.allowed[e];if(f&&f!="*")f=f.readBracketedList()}o+=u[i]+" "}});if(o)e(n).addClass(o+t.defaultClass+(s?" paintr-transclude paintr-"+s:""))},updatePaintr:function(){t.definitions=[];t.allowed={};t.classes={};["what","exclude","defaultClass","titleSelector","allow","transclude"].map(function(n){cfg=e.trim(store.getTiddlerText(t.config+"::"+n)||"");if(cfg)t[n]=cfg});(store.getTiddlerText("PaintrConfig##Definitions")||"").split("\n----\n").map(function(e){var n,r,i,s,o,u,a;if(!e.length||" "==e.substr(0,1))return true;e=e.parseParams("anon",null,true);if(!e[0]["anon"])return false;a=e[0]["anon"][0];u=0==a.indexOf("tiddler=");i=a.substr(u?8:0);t.definitions.pushUnique(i);t.allowed[i]=getParam(e,"allow",t.allow);n=getParam(e,"all",e[0]["anon"][1]||"");r=t.classes[i]={};["link","tag","title","tiddler"].map(function(i){r[i]=getParam(e,i,0>t.what.indexOf(i)?"":n)});r["single"]=u;r["transclude"]=getParam(e,"transclude",t.transclude)});removeStyleSheet("PaintrStyles");setStylesheet(store.getTiddlerText(t.config+"##StyleSheet"),"PaintrStyles")}};t.updatePaintr();createTiddlyLinkPAINTR=createTiddlyLink;createTiddlyLink=function(e,n,r,i,s,o,u){var a=createTiddlyLinkPAINTR.apply(this,arguments);t.paint(a,n,"link");return a};createTagButtonPAINTR=createTagButton;createTagButton=function(e,n,r,i,s){var o=createTagButtonPAINTR.apply(this,arguments);addClass(o,store.getTaggedTiddlers(n).length>0?"hastags":"hasnotags");t.paint(o,n,"tag");return o};config.macros.allTags.handlerPAINTR=config.macros.allTags.handler;config.macros.allTags.handler=function(n,r,i){config.macros.allTags.handlerPAINTR.apply(this,arguments);e(".button, .tiddlyLink",n).each(function(n){var r=e(this),i=r.attr("tiddlyLink");if(i)t.paint(this,i,"link");else if(r.hasClass("hastags")||r.hasClass("hasnotags"))t.paint(this,r.attr("tag"),"tag")})};Story.prototype.refreshTiddlerPAINTR=Story.prototype.refreshTiddler;Story.prototype.refreshTiddler=function(n,r,i,s,o){var u=Story.prototype.refreshTiddlerPAINTR.apply(this,arguments);t.paint(e(u).find(t.titleSelector)[0],n,"title");t.paint(e(u),n,"tiddler");e('[refresh="content"]',e(u)).each(function(){var n,r,i="tiddler",s=e(this);n=s.attr("tiddler")||"";if(!n)return true;r=n.indexOf("##");if(r>=0){n=n.substr(0,r);i="section"}else{r=n.indexOf("::");if(r>=0){n=n.substr(0,r);i="slice"}}t.paint(this,n,"tiddler",i)});return u};TiddlyWiki.prototype.saveTiddlerPAINTR=TiddlyWiki.prototype.saveTiddler;TiddlyWiki.prototype.saveTiddler=function(e,n,r,i,s,o,u,a,f,l){result=this.saveTiddlerPAINTR.apply(this,arguments);if(n==t.config){t.updatePaintr();story.refreshAllTiddlers(true)}return result}})(jQuery)
// %/