/***
|''Name''|PaintrPlugin|
|''Description''|allows to conditionally style internal links, tag buttons, titles and entire tiddlers depending on tiddler tags or title|
|''Documentation''|http://paintr.tiddlyspace.com|
|''Configuration''|PaintrConfig|
|''Author''|[[Tobias Beer|http://tobibeer.tiddlyspace.com]]|
|''Version''|2.0.1 (2013-10-02)|
|''CoreVersion''|2.5.2|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/PaintrPlugin.min.js|
|''License''|[[Creative Commons Attribution-Share Alike 3.0|http://creativecommons.org/licenses/by-sa/3.0/]]|
***/
// /%
(function(e){config.shadowTiddlers.PaintrConfig=["Need help with PaintrPlugin? [[Visit the documentation!|http://paintr.tiddlyspace.com]]","!Defaults","''what:'' links tags titles","''exclude:'' no-paint","''defaultClass:'' paintr","''titleSelector:'' div.title","''allow:''","''transclude:'' tiddler section","''nopaint:'' .nopaint, .header","!StyleSheet","/* demo styles, can be safely deleted or adapted*/","/*{{{*/",".viewer .paintr.tiddlyLink {padding:0 2px; margin: 0 -2px;}\n",".demo, .demo.title {color:red !important;}","a.demo:hover {background:red !important; color:white !important;}",".tiddler.beach, .beach.paintr-transclude {background:lightyellow;}",".beach.paintr-transclude {display:block;padding:10px;}",".beach .tagInfo {background:#eef;}","/*}}}*/","!Definitions","systemConfig + GettingStarted demo","----","tiddler=PaintrConfig title:demo tiddler:beach"].join("\n");var t=config.macros.paint={config:"PaintrConfig",what:"links tags titles",exclude:"no-paint",defaultClass:"paintr",titleSelector:"div.title",allow:"",transclude:"tiddler section",nopaint:".nopaint .header",handler:function(t,n,r,i,s,o){n=r[1];var u=t,a=r[0];if(!config.macros[n]){createTiddlyError(t,config.messages.macroError.format([n]),config.messages.macroErrorDetails.format([n,config.messages.missingMacro]));return}r.splice(0,2);s=r.join(" ");t=e("<span/>")[0];config.macros[n].handler(t,n,r,i,s,o);t=e(t).children().length==1?e(t).children(":first"):e(t);e(t).appendTo(u).addClass(a=="!"?"nopaint":a||"")},setStyle:function(n,r,i,s){var o="",u,a=[],f,l=t.exclude.readBracketedList(),c=e(n).parents("[tiddler]").last().attr("tiddler")||"",h=store.getTiddler(c);if(e(n).text()=="PaintrPlugin")console.log(e(n).closest(t.nopaint));if(e(n).closest(t.nopaint).length||h&&(l.contains(h.title)||h.tags&&h.tags.containsAny(l)))return;h=store.getTiddler(r);t.definitions.map(function(e,n){var u=t.classes[e],a=u["single"],l=u["transclude"];if(f!==""&&(!f||f=="*"||f.contains(e))&&(r==e||h&&h.tags&&h.tags.contains(e)&&!a)&&(!s||l.indexOf(s)>=0)){if(f==undefined||f=="*"){f=t.allowed[e];if(f&&f!="*")f=f.readBracketedList()}o+=u[i]+" "}});if(o)e(n).addClass(o+t.defaultClass+(s?" paintr-transclude paintr-"+s:""))},updatePaintr:function(){t.definitions=[];t.allowed={};t.classes={};["what","exclude","defaultClass","titleSelector","allow","transclude","nopaint"].map(function(n){var r=e.trim(store.getTiddlerText(t.config+"::"+n)||"");if(r)t[n]=r});(store.getTiddlerText("PaintrConfig##Definitions")||"").split("\n----\n").map(function(e){var n,r,i,s,o,u,a=[],f=0,l,c;if(!e.length||" "==e.substr(0,1))return true;e=e.parseParams("anon",null,true);n=e[0]["anon"];if(!n)return true;while(n[f+1]=="+"){a.pushUnique(n[f]);f=f+2}a.pushUnique(n[f]);a.map(function(o){l=0==o.indexOf("tiddler=");s=o.substr(l?8:0);t.definitions.pushUnique(s);t.allowed[s]=getParam(e,"allow",t.allow);r=getParam(e,"all",n[f+1]||"");i=t.classes[s]={};["link","tag","title","tiddler"].map(function(n){i[n]=getParam(e,n,0>t.what.indexOf(n)?"":r)});i["single"]=l;i["transclude"]=getParam(e,"transclude",t.transclude)})});removeStyleSheet("PaintrStyles");setStylesheet(store.getTiddlerText(t.config+"##StyleSheet"),"PaintrStyles")}};t.updatePaintr();createTiddlyLinkPAINTR=createTiddlyLink;createTiddlyLink=function(e,n,r,i,s,o,u){var a=createTiddlyLinkPAINTR.apply(this,arguments);t.setStyle(a,n,"link");return a};createTagButtonPAINTR=createTagButton;createTagButton=function(e,n,r,i,s){var o=createTagButtonPAINTR.apply(this,arguments);addClass(o,store.getTaggedTiddlers(n).length>0?"hastags":"hasnotags");t.setStyle(o,n,"tag");return o};config.macros.allTags.handlerPAINTR=config.macros.allTags.handler;config.macros.allTags.handler=function(n,r,i){config.macros.allTags.handlerPAINTR.apply(this,arguments);e(".button, .tiddlyLink",n).each(function(n){var r=e(this),i=r.attr("tiddlyLink");if(i)t.setStyle(this,i,"link");else if(r.hasClass("hastags")||r.hasClass("hasnotags"))t.setStyle(this,r.attr("tag"),"tag")})};Story.prototype.refreshTiddlerPAINTR=Story.prototype.refreshTiddler;Story.prototype.refreshTiddler=function(n,r,i,s,o){var u=Story.prototype.refreshTiddlerPAINTR.apply(this,arguments);t.setStyle(e(u).find(t.titleSelector)[0],n,"title");t.setStyle(e(u),n,"tiddler");e('[refresh="content"]',e(u)).each(function(){var n,r,i="tiddler",s=e(this);n=s.attr("tiddler")||"";if(!n)return true;r=n.indexOf("##");if(r>=0){n=n.substr(0,r);i="section"}else{r=n.indexOf("::");if(r>=0){n=n.substr(0,r);i="slice"}}t.setStyle(this,n,"tiddler",i)});return u};TiddlyWiki.prototype.saveTiddlerPAINTR=TiddlyWiki.prototype.saveTiddler;TiddlyWiki.prototype.saveTiddler=function(e,n,r,i,s,o,u,a,f,l){result=this.saveTiddlerPAINTR.apply(this,arguments);if(n==t.config){t.updatePaintr();story.refreshAllTiddlers(true)}return result}})(jQuery)
// %/