/***
|''Name''|PaintrPlugin|
|''Description''|allows to conditionally style internal links, tag buttons, titles and entire tiddlers depending on tiddler tags or title|
|''Documentation''|http://paintr.tiddlyspace.com|
|''Configuration''|PaintrConfig|
|''Author''|[[Tobias Beer|http://tobibeer.tiddlyspace.com]]|
|''Version''|2.1.5 (2013-10-04)|
|''CoreVersion''|2.5.2|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/PaintrPlugin.min.js|
|''License''|[[Creative Commons Attribution-Share Alike 3.0|http://creativecommons.org/licenses/by-sa/3.0/]]|
***/
// /%
(function(e){config.shadowTiddlers.PaintrConfig=["!Defaults","''what:'' links tags tabs titles","''exclude:'' no-paint","''transclude:'' tiddler section","''nopaint:'' .nopaint, .header","''inside:''\n","For more options and details [[read the documentation|http://paintr.tiddlyspace.com#Defaults]].","!StyleSheet","/* demo styles, can be safely deleted or adapted */","/*{{{*/",".viewer .paintr.tiddlyLink {padding:0 2px; margin: 0 -2px;}\n",".demo, .demo.title {color:red !important;}","a.demo:hover {background:red !important; color:white !important;}",".tiddler.beach, .beach.paintr-transclude {background:lightyellow;}",".beach.paintr-transclude {display:block;padding:10px;}",".beach .tagInfo {background:#eef;}","/*}}}*/","!Definitions","systemConfig + GettingStarted demo","----","tiddler=PaintrConfig title:demo tiddler:beach"].join("\n");var t=config.macros.paint={defaults:{what:"links tags tabs titles",exclude:"no-paint",defaultClass:"paintr",titleSelector:"div.title",allow:"",transclude:"tiddler section",nopaint:".nopaint .header",inside:"",when:""},handler:function(t,n,r,i,s,o){n=r[1];var u=t,a=r[0];if(!config.macros[n]){createTiddlyError(t,config.messages.macroError.format([n]),config.messages.macroErrorDetails.format([n,config.messages.missingMacro]));return}r.splice(0,2);s=r.join(" ");t=e("<span/>")[0];config.macros[n].handler(t,n,r,i,s,o);t=e(t).children().length==1?e(t).children(":first"):e(t);e(t).appendTo(u).addClass(a=="!"?"nopaint":a||"")},setStyle:function(n,r,i,s){var o,u="",a,f=[],l=t.defaults,c=l.exclude.readBracketedList(),h=store.getTiddler(e(n).parents("[tiddler]").last().attr("tiddler")||"");if(e(n).closest(l.nopaint).length||h&&(c.contains(h.title)||h.tags&&h.tags.containsAny(c)))return;h=store.getTiddler(r);t.definitions.map(function(t){if((r==t.id||h&&h.tags&&h.tags.contains(t.id)&&!t.single)&&o!==""&&(!o||o=="*"||o.contains(t.id))&&(!s||t.transclude.indexOf(s)>=0)&&(!t.inside||e(n).closest(t.inside).length)&&(!t.when||typeof window[t.when]!="function"&&window[t.when]||typeof window[t.when]=="function"&&window[t.when](n,r,i,s,t))){if(o==undefined||o=="*"){o=t.allow;if(o&&o!="*")o=o.readBracketedList()}u+=t[i]+" "}});if(u)e(n).addClass(u+l.defaultClass+(s?" paintr-transclude paintr-"+s:""))},updatePaintr:function(){var n=t.defaults;t.definitions=[];e.each(n,function(t){var r=e.trim(store.getTiddlerText("PaintrConfig::"+t)||"");if(r)n[t]=r});(store.getTiddlerText("PaintrConfig##Definitions")||"").split("\n----\n").map(function(e){var r,i,s,o=[],u=0,a,f;if(!e.length||" "==e.substr(0,1))return true;e=e.parseParams("anon",null,true);r=e[0]["anon"];if(!r)return true;while("+"==r[u+1]){o.pushUnique(r[u]);u=u+2}o.pushUnique(r[u]);o.map(function(o){a=0==o.indexOf("tiddler=");s={id:o.substr(a?8:0),allow:getParam(e,"allow",n.allow),single:a,transclude:getParam(e,"transclude",n.transclude),inside:getParam(e,"inside",n.inside),when:getParam(e,"when",n.when)};i=getParam(e,"all",r[u+1]||"");["link","tag","title","tab","tiddler"].map(function(t){s[t]=getParam(e,t,0>n.what.indexOf(t)?"":i)});t.definitions.push(s)})});removeStyleSheet("PaintrStyles");setStylesheet(store.getTiddlerText("PaintrConfig##StyleSheet"),"PaintrStyles")},tidFromReference:function(e){var t=e.indexOf("##"),n=e.indexOf("::");return t+n<=0?e:e.substr(0,t>0?t:n)},paintTabs:function(n){var r,i;e(n).find("> .tabset .tab").each(function(){var n=e(this),s=n.attr("content"),o=t.tidFromReference(s);if(n.is(".tabSelected")){i=s.indexOf("##")>0?"section":"tiddler";r=o}t.setStyle(n,o,"tab")});t.setStyle(e("> .tabContents",n),r,"tiddler",i)}};t.updatePaintr();createTiddlyLinkPAINTR=createTiddlyLink;createTiddlyLink=function(e,n,r,i,s,o,u){var a=createTiddlyLinkPAINTR.apply(this,arguments);t.setStyle(a,n,"link");return a};createTagButtonPAINTR=createTagButton;createTagButton=function(e,n,r,i,s){var o=createTagButtonPAINTR.apply(this,arguments);addClass(o,store.getTaggedTiddlers(n).length>0?"hastags":"hasnotags");t.setStyle(o,n,"tag");return o};config.macros.allTags.handlerPAINTR=config.macros.allTags.handler;config.macros.allTags.handler=function(n,r,i){config.macros.allTags.handlerPAINTR.apply(this,arguments);e(".button, .tiddlyLink",n).each(function(n){var r=e(this),i=r.attr("tiddlyLink");if(i)t.setStyle(this,i,"link");else if(r.hasClass("hastags")||r.hasClass("hasnotags"))t.setStyle(this,r.attr("tag"),"tag")})};config.macros.tabs.handlerPAINTR=config.macros.tabs.handler;config.macros.tabs.handler=function(n,r,i){config.macros.tabs.handlerPAINTR.apply(this,arguments);t.paintTabs(e(n).last())};config.macros.tabs.switchTabPaintr=config.macros.tabs.switchTab;config.macros.tabs.switchTab=function(n,r){$t=e(n);$t.next().attr("class","tabContents");config.macros.tabs.switchTabPaintr.apply(this,arguments);t.paintTabs($t.parent())};Story.prototype.refreshTiddlerPAINTR=Story.prototype.refreshTiddler;Story.prototype.refreshTiddler=function(n,r,i,s,o){var u=Story.prototype.refreshTiddlerPAINTR.apply(this,arguments);t.setStyle(e(u).find(t.defaults.titleSelector)[0],n,"title");t.setStyle(e(u),n,"tiddler");e('[refresh="content"]',e(u)).each(function(){var n,r,i,s,o=e(this);i=o.attr("tiddler")||"";if(!i)return true;t.tidFromReference(i);s=i.indexOf("##")>0?"section":i.indexOf("::")>0?"sllice":"tiddler";t.setStyle(this,i,"tiddler",s)});return u};TiddlyWiki.prototype.saveTiddlerPAINTR=TiddlyWiki.prototype.saveTiddler;TiddlyWiki.prototype.saveTiddler=function(e,n,r,i,s,o,u,a,f,l){result=this.saveTiddlerPAINTR.apply(this,arguments);if(n=="PaintrConfig"){t.updatePaintr();story.refreshAllTiddlers(true)}return result}})(jQuery)
// %/