/***
|''Name''|PagrPlugin|
|''Description''|powerful navigation based on a toc with... <br>» sitemap style breadcrumbs with popup navigation <br>» prev next home buttons <br>» chapter tocs for chapters <br>» menu highlight|
|''Documentation''|http://pagr.tiddlyspace.com|
|''Author''|Tobias Beer|
|''Version''|1.3.0 (2013-10-11)|
|''~CoreVersion''|2.5.3|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/PagrPlugin.min.js|
|''License''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
***/
// /%
(function(e){var t=config.macros.pagr={toc:"",home:"",tiddler:"",menuSelector:"#mainMenu",sub:"#subMenu",tocClass:"toc",crumbsSeparator:"»",tipSeparator:'Show other chapter items for "%0"',homeText:"%0",fmtNext:"[[%0]]",fmtHome:"[[▲|%0]]",fmtPrev:"[[%0]]",fmtTocLink:"[[○|%0]] ",fmtNotInToc:"[[○|%0]] ",handler:function(n,r,i,s,o,u){$el=e('<span class="pagr_refresh"/>').appendTo(n).attr({refresh:"macro",macroName:"pagr",params:o}).data({params:i});t.refresh($el[0],o)},refresh:function(n,r){var i,s,o,u,a,f,l,c,h=[],p="",d,v={},m,g,y,b,w,E,S,x,T,N,C=e(n).data("params"),k=story.findContainingTiddler(n),L=r.parseParams("anon",null,true),b=getParam(L,"sub",C.contains("sub"));e(n).empty();["fmtPrev|p","fmtHome|h","fmtNext|n","fmtTocLink","fmtNotInToc","toc","home","menu","menuSelector","controls","paging","chapter","crumbs","crumbsOnly|bC","crumbsSeparator|cs","tiddler|tid","homeText","tocClass|tc"].map(function(e){e=e.split("|");v[e[1]?e[1]:e[0]]=getParam(L,e[0],t[e[0]]?t[e[0]]:C.contains(e[0]))});l=store.getTiddlerText(v.toc);if(v.tid&&store.getTiddler(v.tid)){E=v.tid}else{E=k?k.getAttribute("tiddler"):""}if(!E||!l)return;g=v.toc.indexOf("##");v.toc=v.toc.substr(0,g>0?g:v.toc.length);x=t.renderToc(l);s=x.clone();["chapter","crumbs","bC"].map(function(e){v[e]=true==v[e]?E:v[e]});if(v.menu){t.highlightMenu(v.menuSelector,E,s)}if(v.chapter||b){b=true===b?t.sub:b;N=b?e(b):n;if(v.chapter||N.length){i=x.find('[tiddlyLink="'+(b?e(".pagr_selected",v.menuSelector).first().attr("tiddlyLink"):v.chapter)+'"]').first();d=i.next("ol,ul");if(d.closest(".pseudo-ol").length)d.addClass("pseudo-ol");if(b)N.empty();else d.addClass(v.tc);d.appendTo(N);t.highlightMenu(b,E,s);if(v.chapter){return}}}if(v.crumbs||v.bC){if(v.bC){o=e('<div class="crumbs"/>');o.appendTo(n)}if(!o){o=e("#crumbs")}if(!o.length)o=e(k).find(".crumbs").first();if(!o.length)o=e('<div class="crumbs"/>').appendTo(n);o.empty();o=e('<span class="pagr_crumbs"/>').appendTo(o);i=s.find('[tiddlyLink="'+(v.bC?v.bC:v.crumbs)+'"]').first();d=E==v.home?[]:i.next("ol, ul").add(i.parents("ol, ul"));if(v.home&&i.length){h=[];e("ol > li, ul > li",x).not("li li").each(function(){var t=e(this).find(".tiddlyLink").first().attr("tiddlyLink");if(t&&t!=E)h.push(t)});a=v.homeText.format([v.home]);if(E!=v.home){u=createTiddlyLink(o[0],v.home,false);createTiddlyText(u,a)}else{createTiddlyText(o[0],a)}e(createTiddlyButton(o[0],v.cs,t.tipSeparator.format([v.home]),t.crumbsPopup,"crumbs_separator tiddlyLink")).data("tids",h.slice())}e.each(d,function(n,r){var i=e(r).parent().children(".tiddlyLink").first(),s=i.attr("tiddlyLink");if(s==E)if(w)return true;else w=1;if(s){h=[];i.nextAll("ol, ul").children().each(function(){var t=e(this).find(".tiddlyLink").first().attr("tiddlyLink");if(t&&t!=E)h.push(t)});if(s==E)createTiddlyElement(o[0],"span",null,"crumbs_current",s);else createTiddlyLink(o[0],s,true);e(createTiddlyButton(o[0],v.cs,t.tipSeparator.format([s]),t.crumbsPopup,"crumbs_separator tiddlyLink")).data("tids",h.slice())}});if(!h.length)e(".crumbs_separator",o).last().remove();e(".crumbs_separator",o).each(function(){var t=e(this),n=t.data("tids"),r=t.next().text(),i=n.indexOf(r);if(i>-1)n.splice(i,1);if(!n.length){e('<span class="crumbs_separator"/>').insertAfter(t).text(v.cs);t.remove()}});if(v.fmtTocLink){u=e('<span class="pagr_toclink"/>');wikify(v[i.length?"fmtTocLink":"fmtNotInToc"].format(v.toc),u[0]);u.insertBefore(o)}if(v.bC)return}if(v.paging||v.controls){S=[];e(".tiddlyLink",s).each(function(){S.push(e(this).attr("tiddlyLink"))});g=S.indexOf(E);if(g<0)return;m=g-1<0?-1:g-1;h=g+1>=S.length?0:g+1;y=createTiddlyElement(n,"div",null,"pagr");if(v.p&&m>=0)p+="{{pagr_prev{"+v.p.format([S[m]])+"}}}";if(v.h)p+=v.h.format([v.toc]);if(v.n&&h)p+="{{pagr_next{"+v.n.format([S[h]])+"}}}";wikify(p,y)}x.add(s).remove()},renderToc:function(t){var n=e("<div/>");wikify(t,n[0]);return n},highlightMenu:function(t,n,r){e(t).each(function(){var t=e(".tiddlyLinkExisting",this),i=r.find('[tiddlyLink="'+n+'"]').first();t.removeClass("pagr_selected");e.each(t,function(){var t,r=e(this),s=r.attr("tiddlyLink");if(s==n){r.addClass("pagr_selected");return false}e.each(i.parents("ol, ul"),function(){var n=e(this).parent().children(".tiddlyLink").first();if(s==n.attr("tiddlyLink")){t=1;r.addClass("pagr_selected");return false}});return!t})})},crumbsPopup:function(t){var n,r=t||window.event,i=e(this),s=Popup.create(this),o=i.data("tids"),u=i.next().attr("tiddlyLink");o.map(function(e){if(e!=u){createTiddlyLink(createTiddlyElement(s,"li"),e,true);n++}});Popup.show();r.cancelBubble=true;if(r.stopPropagation)r.stopPropagation();return false}};config.shadowTiddlers.StyleSheetPagr=["/*{{{*/",".pagr {margin: 0 0 0.5em 1em;}",".pagr a {padding:5px;}",'.pagr_prev a:before {content:"« ";}','.pagr_next a:after {content:" »";}',".crumbsHeader {position:absolute;float:left;font-size:0.8em;top:-1.15em;color:[[ColorPalette::TertiaryLight]];}",".crumbsHeader a.tiddlyLink {color:[[ColorPalette::PrimaryLight]];font-weight:normal;}",".tiddler:hover .crumbsHeader a.tiddlyLink {color:[[ColorPalette::PrimaryMid]]}",".tiddler:hover .crumbsHeader a.tiddlyLink:hover {background:none;color:[[ColorPalette::PrimaryDark]];}",".crumbs_separator {padding:0 3px;margin: 0 2px;}","/*}}}*/"].join("\n");store.addNotification("StyleSheetPagr",refreshStyles)})(jQuery)
// %/