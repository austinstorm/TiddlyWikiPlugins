/***
|''Name''|PagrPlugin|
|''Description''|powerful navigation based on a toc with... <br>» sitemap style breadcrumbs with popup navigation <br>» prev next home buttons <br>» chapter tocs for chapters <br>» menu highlight|
|''Documentation''|http://pagr.tiddlyspace.com|
|''Author''|Tobias Beer|
|''Version''|1.2.0 (2013-10-11)|
|''~CoreVersion''|2.5.3|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/PagrPlugin.min.js|
|''License''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
***/
// /%
(function(e){var t=config.macros.pagr={toc:"",home:"",tiddler:"",menuSelector:"#mainMenu",tocClass:"toc",crumbsSeparator:"»",tipSeparator:'Show other chapter items for "%0"',homeText:"%0",fmtNext:"[[%0]]",fmtHome:"[[▲|%0]]",fmtPrev:"[[%0]]",fmtTocLink:"[[○|%0]] ",fmtNotInToc:"[[○|%0]] ",handler:function(n,r,i,s,o,u){$el=e('<span class="pagr_refresh"/>').appendTo(n).attr({refresh:"macro",macroName:"pagr",params:o}).data({params:i});t.refresh($el[0],o)},refresh:function(n,r){var i,s,o,u,a,f,l,c,h=[],p="",d,v={},m,g,y,b,w,E,S,x,T=e(n).data("params"),N=story.findContainingTiddler(n),C=r.parseParams("anon",null,true);e(n).empty();["fmtPrev|p","fmtHome|h","fmtNext|n","fmtTocLink","fmtNotInToc","toc","home","menu","menuSelector","chapter","crumbs","crumbsOnly|bC","crumbsSeparator|cs","tiddler|tid","homeText","tocClass|tc"].map(function(e){e=e.split("|");v[e[1]?e[1]:e[0]]=getParam(C,e[0],t[e[0]]?t[e[0]]:T.contains(e[0]))});l=store.getTiddlerText(v.toc);if(v.tid&&store.getTiddler(v.tid)){w=v.tid}else{w=N?N.getAttribute("tiddler"):""}if(!w||!l)return;g=v.toc.indexOf("##");v.toc=v.toc.substr(0,g>0?g:v.toc.length);S=e("<div/>");wikify(l,S[0]);["chapter","crumbs","bC"].map(function(e){v[e]=true==v[e]?w:v[e]});l=e(".tiddlyLinkExisting",v.menuSelector);if(v.menu&&l.length){i=S.find('[tiddlyLink="'+w+'"]').first();l.removeClass("pagr_selected");e.each(l,function(){var t,n=e(this),r=n.attr("tiddlyLink");if(r==w){n.addClass("pagr_selected");return false}e.each(i.parents("ol, ul"),function(){var i=e(this).parent().children(".tiddlyLink").first();if(r==i.attr("tiddlyLink")){t=1;n.addClass("pagr_selected");return false}});return!t})}if(v.chapter){i=S.find('[tiddlyLink="'+v.chapter+'"]').first();d=i.next("ol,ul");if(d.closest(".pseudo-ol").length)d.addClass("pseudo-ol");d.addClass(v.tc);d.appendTo(n);return}if(v.crumbs||v.bC){s=e("#crumbs");if(!s.length)s=e(N).find(".crumbs").first();if(!s.length){s=e('<div class="crumbs"/>').appendTo(n)}s.empty();s=e('<span class="pagr_crumbs"/>').appendTo(s);i=S.find('[tiddlyLink="'+(v.bC?v.bC:v.crumbs)+'"]').first();d=w==v.home?[]:i.next("ol, ul").add(i.parents("ol, ul"));if(v.home&&i.length){h=[];e("ol > li, ul > li",S).not("li li").each(function(){var t=e(this).find(".tiddlyLink").first().attr("tiddlyLink");if(t&&t!=w)h.push(t)});u=v.homeText.format([v.home]);if(w!=v.home){o=createTiddlyLink(s[0],v.home,false);createTiddlyText(o,u)}else{createTiddlyText(s[0],u)}e(createTiddlyButton(s[0],v.cs,t.tipSeparator.format([v.home]),t.crumbsPopup,"crumbs_separator tiddlyLink")).data("tids",h.slice())}e.each(d,function(n,r){f=e(r).parent().children(".tiddlyLink").first();if(w==f.attr("tiddlyLink"))if(b)return true;else b=1;if(f.length){h=[];f.nextAll("ol, ul").children().each(function(){var t=e(this).find(".tiddlyLink").first().attr("tiddlyLink");if(t&&t!=w)h.push(t)});(w==f.attr("tiddlyLink")?e('<span class="crumbs_current"/>').text(w):f).appendTo(s);e(createTiddlyButton(s[0],v.cs,t.tipSeparator.format([f.attr("tiddlyLink")]),t.crumbsPopup,"crumbs_separator tiddlyLink")).data("tids",h.slice())}});if(!h.length)e(".crumbs_separator",s).last().remove();e(".crumbs_separator",s).each(function(){var t=e(this),n=t.data("tids"),r=t.next().text(),i=n.indexOf(r);if(i>-1)n.splice(i,1);if(!n.length){e('<span class="crumbs_separator"/>').insertAfter(t).text(v.cs);t.remove()}});if(v.fmtTocLink){o=e('<span class="pagr_toclink"/>');wikify(v[i.length?"fmtTocLink":"fmtNotInToc"].format(v.toc),o[0]);o.insertBefore(s)}if(v.bC)return}E=[];e(".tiddlyLink",S).each(function(){E.push(e(this).attr("tiddlyLink"))});g=E.indexOf(w);if(g<0)return;m=g-1<0?-1:g-1;h=g+1>=E.length?0:g+1;y=createTiddlyElement(n,"div",null,"pagr");if(v.p&&m>=0)p+="{{pagr_prev{"+v.p.format([E[m]])+"}}}";if(v.h)p+=v.h.format([v.toc]);if(v.n&&h)p+="{{pagr_next{"+v.n.format([E[h]])+"}}}";wikify(p,y)},crumbsPopup:function(t){var n,r=t||window.event,i=e(this),s=Popup.create(this),o=i.data("tids"),u=i.next().attr("tiddlyLink");o.map(function(e){if(e!=u){createTiddlyLink(createTiddlyElement(s,"li"),e,true);n++}});Popup.show();r.cancelBubble=true;if(r.stopPropagation)r.stopPropagation();return false}};config.shadowTiddlers.StyleSheetPagr="/*{{{*/\n"+".pagr {margin: 0 0 0.5em 1em;}\n"+".pagr a {padding:5px;}\n"+'.pagr_prev a:before {content:"« ";}\n'+'.pagr_next a:after {content:" »";}\n'+".crumbs {position:absolute;float:left;font-size:0.8em;top:-1.15em;color:[[ColorPalette::TertiaryLight]]}\n"+".crumbs a.tiddlyLink {color:[[ColorPalette::PrimaryLight]];font-weight:normal;}\n"+".tiddler:hover .crumbs a.tiddlyLink {color:[[ColorPalette::PrimaryMid]]}\n"+".tiddler:hover .crumbs a.tiddlyLink:hover {background:none;color:[[ColorPalette::PrimaryDark]];}\n"+".crumbs_separator {padding:0 3px;margin: 0 2px;}\n"+"/*}}}*/";store.addNotification("StyleSheetPagr",refreshStyles)})(jQuery)
// %/