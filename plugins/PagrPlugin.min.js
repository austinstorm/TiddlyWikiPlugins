/***
|''Name''|PagrPlugin|
|''Description''|powerful navigation based on a toc with...<br>» sitemap style breadcrumbs with popup navigation<br>» prev next home buttons<br>» chapter tocs for chapters|
|''Documentation''|http://pagr.tiddlyspace.com|
|''Author''|Tobias Beer|
|''Version''|1.2.0 (2013-10-11)|
|''~CoreVersion''|2.5.3|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/PagrPlugin.min.js|
|''License''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
***/
// /%
(function(e){var t=config.macros.pagr={toc:"",home:"",tiddler:"",menu:"#mainMenu",tocClass:"toc",crumbsSeparator:"»",tipSeparator:'Show other chapter items for "%0"',homeText:"%0",fmtNext:"[[%0]]",fmtHome:"[[▲|%0]]",fmtPrev:"[[%0]]",fmtTocLink:"[[○|%0]] ",fmtNotInToc:"[[○|%0]] ",handler:function(n,r,i,s,o,u){var a,f,l,c,h,p,d,v,m=[],g="",y,b={},w,E,S,x,T,N,C,k,L=story.findContainingTiddler(n),A=o.parseParams("anon",null,true);["fmtPrev|p","fmtHome|h","fmtNext|n","fmtTocLink","fmtNotInToc","toc","home","menu","chapter","crumbs","crumbsOnly|bC","crumbsSeparator|cs","tiddler|tid","homeText","tocClass|tc"].map(function(e){e=e.split("|");b[e[1]?e[1]:e[0]]=getParam(A,e[0],t[e[0]]?t[e[0]]:i.contains(e[0]))});d=store.getTiddlerText(b.toc);if(b.tid&&store.getTiddler(b.tid)){T=b.tid}else{T=L?L.getAttribute("tiddler"):""}if(!T||!d)return;E=b.toc.indexOf("##");b.toc=b.toc.substr(0,E>0?E:b.toc.length);C=e("<div/>");wikify(d,C[0]);["chapter","crumbs","bC"].map(function(e){b[e]=true==b[e]?T:b[e]});d=e(".tiddlyLinkExisting",b.menu);if(b.menu&&d.length){a=C.find('[tiddlyLink="'+T+'"]').first();d.removeClass("pagr_selected");e.each(d,function(){var t,n=e(this),r=n.attr("tiddlyLink");if(r==T){n.addClass("pagr_selected");return false}e.each(a.parents("ol, ul"),function(){var i=e(this).parent().children(".tiddlyLink").first();if(r==i.attr("tiddlyLink")){t=1;n.addClass("pagr_selected");return false}});return!t})}if(b.chapter){a=C.find('[tiddlyLink="'+b.chapter+'"]').first();y=a.next("ol,ul");if(y.closest(".pseudo-ol").length)y.addClass("pseudo-ol");y.addClass(b.tc);y.appendTo(n);return}if(b.crumbs||b.bC){f=e("#crumbs");if(!f.length)f=e(L).find(".crumbs").first();if(!f.length){f=e('<div class="crumbs"/>').appendTo(n)}f.empty();f=e('<span class="pagr_crumbs"/>').appendTo(f);a=C.find('[tiddlyLink="'+(b.bC?b.bC:b.crumbs)+'"]').first();y=T==b.home?[]:a.next("ol, ul").add(a.parents("ol, ul"));if(b.home&&a.length){m=[];e("ol > li, ul > li",C).not("li li").each(function(){var t=e(this).find(".tiddlyLink").first().attr("tiddlyLink");if(t&&t!=T)m.push(t)});c=b.homeText.format([b.home]);if(T!=b.home){l=createTiddlyLink(f[0],b.home,false);createTiddlyText(l,c)}else{createTiddlyText(f[0],c)}e(createTiddlyButton(f[0],b.cs,t.tipSeparator.format([b.home]),t.crumbsPopup,"crumbs_separator tiddlyLink")).data("tids",m.slice())}e.each(y,function(n,r){p=e(r).parent().children(".tiddlyLink").first();if(T==p.attr("tiddlyLink"))if(x)return true;else x=1;if(p.length){m=[];p.nextAll("ol, ul").children().each(function(){var t=e(this).find(".tiddlyLink").first().attr("tiddlyLink");if(t&&t!=T)m.push(t)});(T==p.attr("tiddlyLink")?e('<span class="crumbs_current"/>').text(T):p).appendTo(f);e(createTiddlyButton(f[0],b.cs,t.tipSeparator.format([p.attr("tiddlyLink")]),t.crumbsPopup,"crumbs_separator tiddlyLink")).data("tids",m.slice())}});if(!m.length)e(".crumbs_separator",f).last().remove();e(".crumbs_separator",f).each(function(){var t=e(this),n=t.data("tids"),r=t.next().text(),i=n.indexOf(r);if(i>-1)n.splice(i,1);if(!n.length){e('<span class="crumbs_separator"/>').insertAfter(t).text(b.cs);t.remove()}});if(b.fmtTocLink){l=e('<span class="pagr_toclink"/>');wikify(b[a.length?"fmtTocLink":"fmtNotInToc"].format(b.toc),l[0]);l.insertBefore(f)}if(b.bC)return}N=[];e(".tiddlyLink",C).each(function(){N.push(e(this).attr("tiddlyLink"))});E=N.indexOf(T);if(E<0)return;w=E-1<0?-1:E-1;m=E+1>=N.length?0:E+1;S=createTiddlyElement(n,"div",null,"pagr");if(b.p&&w>=0)g+="{{pagr_prev{"+b.p.format([N[w]])+"}}}";if(b.h)g+=b.h.format([b.toc]);if(b.n&&m)g+="{{pagr_next{"+b.n.format([N[m]])+"}}}";wikify(g,S)},crumbsPopup:function(t){var n,r=t||window.event,i=e(this),s=Popup.create(this),o=i.data("tids"),u=i.next().attr("tiddlyLink");o.map(function(e){if(e!=u){createTiddlyLink(createTiddlyElement(s,"li"),e,true);n++}});Popup.show();r.cancelBubble=true;if(r.stopPropagation)r.stopPropagation();return false}};config.shadowTiddlers.StyleSheetPagr="/*{{{*/\n"+".pagr {margin: 0 0 0.5em 1em;}\n"+".pagr a {padding:5px;}\n"+'.pagr_prev a:before {content:"« ";}\n'+'.pagr_next a:after {content:" »";}\n'+".crumbs {position:absolute;float:left;font-size:0.8em;top:-1.15em;color:[[ColorPalette::TertiaryLight]]}\n"+".crumbs a.tiddlyLink {color:[[ColorPalette::PrimaryLight]];font-weight:normal;}\n"+".tiddler:hover .crumbs a.tiddlyLink {color:[[ColorPalette::PrimaryMid]]}\n"+".tiddler:hover .crumbs a.tiddlyLink:hover {background:none;color:[[ColorPalette::PrimaryDark]];}\n"+".crumbs_separator {padding:0 3px;margin: 0 2px;}\n"+"/*}}}*/";store.addNotification("StyleSheetPagr",refreshStyles)})(jQuery)
// %/