/***
|''Name''|PagrPlugin|
|''Description''|powerful navigation based on a toc with...<br>» sitemap style breadcrumbs with popup navigation<br>» prev next home buttons<br>» chapter tocs for chapters|
|''Documentation''|http://pagr.tiddlyspace.com|
|''Author''|Tobias Beer|
|''Version''|1.0.1 (2013-10-08)|
|''~CoreVersion''|2.5.3|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/PagrPlugin.min.js|
|''License''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
***/
// /%
(function(e){var t=config.macros.pagr={crumbsSeparator:"»",tipSeparator:'Show other chapter items for "%0"',fmtNext:"[[%0]]",fmtHome:"[[▲|%0]]",fmtPrev:"[[%0]]",toc:"",home:"",tocClass:"toc",handler:function(n,r,i,s,o,u){var a,f,l,c,h,p,d=[],v="",m,g={},y,b,w,E,S,x,T,N,C=o.parseParams("anon",null,true);["fmtPrev|p","fmtHome|h","fmtNext|n","toc","home","chapter","crumbs","crumbsOnly|bC","crumbsSeparator|cs","tocClass|tc"].map(function(e){e=e.split("|");g[e[1]?e[1]:e[0]]=getParam(C,e[0],t[e[0]]?t[e[0]]:i.contains(e[0]))});h=store.getTiddlerText(g.toc);S=story.findContainingTiddler(n);E=S?S.getAttribute("tiddler"):"";if(!E||!h)return;b=g.toc.indexOf("##");g.toc=g.toc.substr(0,b>0?b:g.toc.length);T=e("<div/>");wikify(h,T[0]);g.chapter=true===g.chapter?E:g.chapter;if(g.chapter){m=T.find('[tiddlyLink="'+g.chapter+'"]').first().next("ol,ul");if(m.closest(".pseudo-ol").length)m.addClass("pseudo-ol");m.addClass(g.tc);m.appendTo(n);return}g.crumbs=true===g.crumbs?E:g.crumbs;g.bC=true==g.bC?E:g.bC;if(g.crumbs||g.bC){f=e("#crumbs");if(!f.length)f=e(S).find(".crumbs").first();if(!f.length){f=e('<div class="crumbs"/>').appendTo(n)}e(f).empty();a=T.find('[tiddlyLink="'+(g.bC?g.bC:g.crumbs)+'"]').first();m=E==g.home?[]:a.next("ol, ul").add(a.parents("ol, ul"));if(g.home&&E!=g.home&&a.length){d=[];e("ol > li, ul > li",T).not("li li").each(function(){var t=e(this).find(".tiddlyLink").first().attr("tiddlyLink");if(t&&t!=E)d.push(t)});createTiddlyLink(f[0],g.home,true);e(createTiddlyButton(f[0],g.cs,t.tipSeparator.format([g.home]),t.crumbsPopup,"crumbs_separator tiddlyLink")).data("tids",d.slice())}for(l=0;l<m.length;l++){c=e(m[l]).prev();if(c.length){d=[];c.next().children().each(function(){var t=e(this).find(".tiddlyLink").first().attr("tiddlyLink");if(t&&t!=E)d.push(t)});(E==c.attr("tiddlyLink")?e('<span class="crumbs_current"/>').text(E):c).appendTo(f);e(createTiddlyButton(f[0],g.cs,t.tipSeparator.format([c.attr("tiddlyLink")]),t.crumbsPopup,"crumbs_separator tiddlyLink")).data("tids",d.slice())}}if(!d.length)e(".crumbs_separator",f).last().remove();e(".crumbs_separator",f).each(function(){var t=e(this),n=t.data("tids"),r=t.next().text(),i=n.indexOf(r);if(i>-1)n.splice(i,1);if(!n.length){e('<span class="crumbs_separator"/>').insertAfter(t).text(g.cs);t.remove()}});if(g.bC)return}x=[];e(".tiddlyLink",T).each(function(){x.push(e(this).attr("tiddlyLink"))});b=x.indexOf(E);if(b<0)return;y=b-1<0?-1:b-1;d=b+1>=x.length?0:b+1;w=createTiddlyElement(n,"div",null,"pagr");if(g.p&&y>=0)v+="{{pagr_prev{"+g.p.format([x[y]])+"}}}";if(g.h)v+=g.h.format([g.toc]);if(g.n&&d)v+="{{pagr_next{"+g.n.format([x[d]])+"}}}";wikify(v,w)},crumbsPopup:function(t){var n,r=t||window.event,i=e(this),s=Popup.create(this),o=i.data("tids"),u=i.next().attr("tiddlyLink");o.map(function(e){if(e!=u){createTiddlyLink(createTiddlyElement(s,"li"),e,true);n++}});Popup.show();r.cancelBubble=true;if(r.stopPropagation)r.stopPropagation();return false}};config.shadowTiddlers.StyleSheetPagr="/*{{{*/\n"+".pagr {margin: 0 0 0.5em 1em;}\n"+".pagr a {padding:5px;}\n"+'.pagr_prev a:before {content:"« ";}\n'+'.pagr_next a:after {content:" »";}\n'+".crumbs {position:absolute;float:left;font-size:0.8em;top:-1.15em;color:[[ColorPalette::TertiaryLight]]}\n"+".crumbs a.tiddlyLink {color:[[ColorPalette::PrimaryLight]];font-weight:normal;}\n"+".tiddler:hover .crumbs a.tiddlyLink {color:[[ColorPalette::PrimaryMid]]}\n"+".tiddler:hover .crumbs a.tiddlyLink:hover {background:none;color:[[ColorPalette::PrimaryDark]];}\n"+".crumbs_separator {padding:0 3px;margin: 0 2px;}\n"+"/*}}}*/";store.addNotification("StyleSheetPagr",refreshStyles)})(jQuery)
// %/