/***
|''Name''|TagFiltrPlugin|
|''Description''|tag-based faceted tiddler navigation based on FND's tagsplorer|
|''Author''|Tobias Beer|
|''Documentation''|http://tagfiltr.tiddlyspace.com|
|''Version''|1.4.8 (2013-09-30)|
|''CoreVersion''|2.6.0|
|''License''|Creative Commons 3.0|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/TagFiltrPlugin.min.js|
<<tagfiltr>>
***/
// /%
(function(e){var t=config.macros.tagfiltr={};config.macros.tagfiltr=e.extend(t,{exclude:"excludeLists",filter:"",listfiltr:true,tags:"",hide:"",fix:false,groups:"TagFiltrConfig##Groups",onlyGroups:false,format:"[[%0]]",lblTags:"tags:",lblAdd:"+",tipAdd:"add tag to filter",tipPrefix:"select tag from group",tipRemove:"remove tag from filter",tipFix:"this tag cannot be removed",handler:function(n,r,i,s,o,u){var a={},f,l,c={},h=o.parseParams("anon",null,true),p=getParam(h,"template",""),d=e(n).closest("#tiddlerDisplay").length;(store.getTiddlerText(p)||"").split("\n").map(function(e){var t=e.split(":");c[t[0]]=undefined!=t[1]?t[1]:true});["exclude|ex","filter","listfiltr|lf","tags","fix","hide","groups","onlyGroups|bG","lblTags","format|fmt"].map(function(e){e=e.split("|");var n=e[0],r=e[1]||e[0];a[r]=getParam(h,n,p&&c[n]?c[n]:t[n]!=undefined?t[n]:"");if(i.contains(n)){a[r]=true}});["bG","lf"].map(function(e){a[e]="true"==a[e].toString()});l=e('<div class="tagfiltr" />').append('<b class="tp_tags_label" />').children(":last").text(a.lblTags).end().append('<div class="tf-tags" />').append('<div class="tf-listfiltr" />').attr({refresh:"macro",macroName:"tagfiltr",params:o});a.ex=a.ex.readBracketedList();a.hide=a.hide.readBracketedList();a.tags=a.tags.readBracketedList();if(a.fix)a.fix=typeof a.fix==="string"?a.fix.readBracketedList():a.tags.slice();else a.fix=[];if(a.fix.length&&!a.tags.length)a.tags=a.fix.slice();if(a.fmt.toLowerCase().indexOf("tiddler=")==0){f=t.getRef(a.fmt.substr(8),p);a.fmt=store.getTiddlerText(f)}a.fmt=a.fmt||t.format;e.extend(a,{g_def:{},g_all:{},g_tags:{},g_match:{}});(store.getTiddlerText(t.getRef(a.groups,p))||"").split("\n").map(function(t){t=e.trim(t).split("|");var n=e.trim(t[0]),r=e.trim(t[1]),i=n&&!t[2]?n+r:e.trim(t[2]?t[2]:r),s=n?n:r;if(t.length>1){a.g_def[s]={title:i,group:r,prefix:n}}});l.appendTo(n).dblclick(function(e){return false});l.data(a);t.refresh(l,true)},refresh:function(n,r){if(!n.html)n=e(n);t.getGroupTags(n);var i,s,o,u,a=n.data(),f=n.find(".tf-tags"),l=n.find(".tf-listfiltr"),c=n.find(".tf-groups");e(".tf-tag, .tf-add",f).remove();if(0==c.length){c=e('<span class="tf-groups"/>').appendTo(f);e.each(a.g_def,function(e,n){var r=n.prefix||"",i=n.title,s=i?i:r?r+n.group:e;t.newTagButton(c,s,t.tipPrefix,t.clickTag,"button").data({group:s,tags:[]}).attr({group:r?r:e})})}a.tags.map(function(e){var r=a.fix.contains(e);if(0==n.find('.tf-groups [tag="'+e+'"]').length&&!a.hide.contains(e)){t.newTagButton(f,e,r?t.tipFix:t.tipRemove,t.removeTag,"button tf-tag"+(r?" tf-fix":"")).attr("tag",e)}});l.empty();u=e('<ul class="tf-tids"/>').appendTo(l);if(a.fmt==t.format)l.addClass("tf-default");o=t.getTiddlers(n);o.map(function(t){i=e("<li/>").appendTo(u);wikify(a.fmt.format([t.title]),i[0],null,t)});if(r){e(".tf-group",n).each(function(){var t=e(this);if(a.hide.contains(t.attr("tag"))){t.hide()}})}a.hide.map(function(t){e('a.button[tag="'+t+'"]',l).hide()});if(a.lf&&config.macros.listfiltr)wikify("<<listfiltr>>",l[0]);s=t.getTagSelection(n,o);if(s.length){t.newTagButton(f,t.lblAdd,t.tipAdd,null,"button tf-add").data("tags",s).click(t.clickTag)}},clickTag:function(n){var r,i,s,o=e(this),u=o.closest(".tagfiltr"),a=u.data(),f=o.data("group");if(o.hasClass("tf-fix"))return false;if(o.hasClass("tf-selected")){i=e(".tf-selected",u).text();t.removeTag(0,o);t.setGroupButton(o);t.refresh(u);if(i==e(".tf-selected",u).text()){s=e(".tf-tag",u);if(s.length){s.click()}else if(a.last&&a.last.is(".tf-selected")){a.last.click()}else{a.tags=a.fix.slice();t.refresh(u)}}return true}else{t.openPopup(u,this);n.stopPropagation();return false}},openPopup:function(n,r){var i=e(r),s=Popup.create(r,"ul");e(s).data({tagfiltr:n,button:i});i.data("tags").map(function(e){t.newTagButton(s,e,t.tipAdd,t.popClick)});Popup.show()},popClick:function(n){var r=e(this),i=r.text(),s=r.closest(".popup");d=s.data(),$t=d.tagfiltr,$btn=d.button,g=$btn.attr("group");d=$t.data();if(g)t.setGroupButton($btn,i);d.tags.pushUnique(i);t.refresh($t);if(g)d.last=$btn;if(config.options.chkAnimate&&anim&&typeof Scroller=="function")anim.startAnimating(new Scroller($t[0]));else window.scrollTo(0,ensureVisible($t[0]));if(n.ctrlKey&&$btn.hasClass("tf-add")){s.remove();e(".tf-add",$t).first().click()}return!n.ctrlKey},removeTag:function(n,r){var i=r?e(r):e(this),s=i.closest(".tagfiltr"),o=s.data();if(i.is(".tf-fix")){e(".tf-tag",s).not(".tf-fix").each(function(){o.tags.remove(e(this).text())})}else o.tags.remove(i.text());if(!r)t.refresh(s);return false},getTiddlers:function(n){var r,i,s,o=[],u=n.data();u.g_all={};gm=u.g_match={};(u.filter?store.filterTiddlers(u.filter):store.getTiddlers("title")).map(function(e){if(!(e.tags&&e.tags.containsAny(u.ex))&&(1>u.tags.length||e.tags.containsAll(u.tags))&&(!u.bG||t.inGroup(n,e,true)))o.push(e)});if(!e.isEmptyObject(gm)){e.each(u.g_def,function(s,a){var f=[];if(gm[s])e.each(gm[s],function(e){f.push(e)});r=n.find('.tf-tags [group="'+s+'"]');if(f.length){f.sort();f.map(function(e){u.g_all[e]=s});if(1==f.length&&o.length==gm[s][f[0]].length&&!t.hasFixedDuplicate(n,f[0],s)){t.setGroupButton(r,f[0])}else{t.setGroupButton(r)}r.addClass("tf-group").data("tags",f);i=e('.tf-tag[tag="'+f[0]+'"]',n);if(i.length){i.remove();u.last=r}}else{r.removeClass("tf-group").data("tags",undefined)}})}return o},getTagSelection:function(e,t){var n=[],r=e.data();t.map(function(e){e.tags.map(function(e){if(!(r.ex.contains(e)||r.g_all[e]||r.g_tags[e]||r.tags.contains(e)||r.hide.contains(e))){n.pushUnique(e)}})});return n.sort()},newTagButton:function(t,n,r,i,s){if(e(t).hasClass("popup"))t=e("<li/>").appendTo(t);return e('<a href="javascript:;" />').addClass(s||"").attr("title",r||"").text(n).click(i||null).appendTo(t)},getGroupTags:function(t){var n=t.data();n.g_tags={};e.each(n.g_def,function(e,t){if(!t.prefix){store.getTaggedTiddlers(e).map(function(t){n.g_tags[t.title]=e})}})},inGroup:function(n,r,i){var s,o=0,u=n.data();if(r.tags){r.tags.map(function(a){e.each(u.g_def,function(e,f){var l=f.prefix,c=u.g_match;if(l&&a.indexOf(e)==0||!l&&u.g_tags[a]==e){o=1;s=n.find('.tf-tags [group="'+e+'"]');if(!l&&t.hasFixedDuplicate(n,a,e)){s.hide()}else if(u.fix.contains(a)){t.setGroupButton(s.data("fixed",true).addClass("tf-fix").attr("title",t.tipFix),a)}if(i){if(!c[e])c[e]={};if(!c[e][a])c[e][a]=[];c[e][a].push(r.title)}}return i||!o});return i||!o})}return o},setGroupButton:function(e,t,n){if(t){e.text(t).attr("tag",t).addClass("tf-selected")}else if(!e.data("fixed")||n){e.text(e.data("group")).attr("tag",undefined).removeClass("tf-selected")}},hasFixedDuplicate:function(t,n,r){var i,s=t.find(".tf-tags .tf-selected");s.each(function(){var t=e(this);if(r!=t.attr("group")&&t.data("fixed")&&n==t.attr("tag")){i=true}return!i});return i},getRef:function(t,n){t=e.trim(t);return 0==t.indexOf("##")?n+t:t}});Array.prototype.containsAll=function(e){for(var t=0;t<e.length;t++){if(!this.contains(e[t])){return false}}return true};config.shadowTiddlers.TagFiltrConfig="!Groups\n"+" -|realm\n"+" &|area\n"+" $|project"+" +|opportunity\n"+" ยง|stage\n"+" ?|who\n"+" /|where\n"+" !|resolution\n"+" #|status\n"+" ^|prio\n"+" @|context\n"+" =|type\n";config.shadowTiddlers.StyleSheetTagFiltr="/*{{{*/\n"+".filtr {display:block;}\n"+".tagfiltr ul {margin: 0;padding: 0;}\n"+".tagfiltr > b,\n"+".tf-tags,\n"+".tf-tags .button {float: left;margin: 0 0.25em 0 0;padding: 0 0.25em;}\n"+".tf-tags .tf-fix {border-color:[[ColorPalette::TertiaryPale]];pointer:default;}\n"+".tf-tags {padding-bottom: 0.5em;}\n"+".tf-tag {\nborder-top-right-radius:7px;\n-webkit-border-top-right-radius: 7px;\n-moz-border-radius-topright: 7px;\nborder-bottom-right-radius: 7px;\n-webkit-border-bottom-right-radius: 7px;\n-moz-border-radius-bottomright: 7px;}\n"+".tf-groups {padding-right:7px;float:left;}\n"+".tf-groups .button {display:none;}\n"+".tf-groups .tf-group {display:block;}\n"+".tf-groups .tf-selected {color:[[ColorPalette::SecondaryMid]];}\n"+".tagfiltr .tf-tids {clear:left;}\n"+".tf-default li {list-style-type:none;}\n"+".tf-default .tiddlyLink{display:block; padding: 1px 1px 1px 7px;}\n"+".tf-listfiltr{clear:left;}\n"+"/*}}}*/";store.addNotification("StyleSheetTagFiltr",refreshStyles)})(jQuery)
// %/