/***
|''Name''|TagFiltrPlugin|
|''Description''|tag-based faceted tiddler navigation based on FND's tagsplorer|
|''Author''|Tobias Beer|
|''Documentation''|http://tagfiltr.tiddlyspace.com|
|''Version''|1.4.1|
|''Status''|beta|
|''CoreVersion''|2.6.0|
|''License''|Creative Commons 3.0|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/TagFiltrPlugin.min.js|
***/
// /%
(function(e){var t=config.macros.tagfiltr={};config.macros.tagfiltr=e.extend(t,{exclude:"excludeLists",tags:"",fix:false,prefixes:"TagFiltrConfig##Prefixes",onlyPrefixed:false,format:"[[» %0|%0]]",lingo:{lblTags:"tags:",lblAdd:"+",tipAdd:"add tag to filter",tipPrefix:"select tag from prefix",tipRemove:"remove tag from filter",tipFix:"this tag cannot be removed"},handler:function(n,r,i,s,o,u){var a={},f,l,c={},h=o.parseParams("anon",null,true),p=getParam(h,"template","");(store.getTiddlerText(p)||"").split("\n").map(function(e){var t=e.split(":");c[t[0]]=undefined!=t[1]?t[1]:true});["exclude|ex","tags","fix","prefixes","onlyPrefixed|bP","format|fmt"].map(function(e){e=e.split("|");var n=e[0],r=e[1]||e[0];a[r]=getParam(h,n,p&&c[n]?c[n]:t[n]!=undefined?t[n]:"");if(i.contains(n)){a[r]=true}});["bP"].map(function(e){a[e]="true"==a[e].toString()});l=e('<div class="tagfiltr" />').append('<b class="tp_tags_label" />').children(":last").text(t.lingo.lblTags).end().append('<div class="tf-tags" />').append('<div class="tf-tids" />').attr({refresh:"macro",macroName:"tagfiltr",params:o});a.ex=a.ex.readBracketedList();a.tags=a.tags.readBracketedList();if(a.fix)a.fix=typeof a.fix==="string"?a.fix.readBracketedList():a.tags.slice();else a.fix=[];if(a.fmt.toLowerCase().indexOf("tiddler=")==0){f=t.getRef(a.fmt.substr(8),p);a.fmt=store.getTiddlerText(f)}a.fmt=a.fmt||t.format;a.px={tf_a:[],tf_m:{}};(store.getTiddlerText(t.getRef(a.prefixes,p))||"").split("\n").map(function(t){t=e.trim(t).split("|");if(t.length<3){a.px[t[0]]={title:t[1]}}});l.appendTo(n).dblclick(function(e){return false});l.data(a);if(!startingUp)t.refresh(l,false)},refresh:function(n,r){if(r)n=e(n);var i,s,o,u=n.data(),a=n.find(".tf-tags"),f=n.find(".tf-tids"),l=n.find(".tf-prefixes");e(".tf-tag, .tf-add",a).remove();if(0==l.length){l=e('<span class="tf-prefixes"/>').appendTo(a);e.each(u.px,function(e,n){var r=e+n.title;if(["tf_a","tf_m"].contains(e))return true;t.newTagButton(l,r,t.lingo.tipPrefix,t.addTag,"button").data("tags",[]).attr({prefix:e,category:r})})}u.tags.map(function(e){var r=u.fix.contains(e);if(0==n.find('.tf-prefixes [tag="'+e+'"]').length){t.newTagButton(a,e,r?t.lingo.tipFix:t.lingo.tipRemove,t.removeTag,"button tf-tag"+(r?" tf-fix":"")).attr("tag",e)}});f.empty();if(u.fmt==t.format)f.addClass("tf-default");o=t.getTiddlers(n);o.map(function(e){wikify(u.fmt.format([e.title]),f[0])});s=t.getTagSelection(n,o);if(s.length){t.newTagButton(a,t.lingo.lblAdd,t.lingo.tipAdd,t.addTag,"button tf-add").data("tags",s)}},addTag:function(n){var r,i,s,o=e(this),u=o.closest(".tagfiltr"),a=u.data(),f=o.attr("prefix");if(o.hasClass("tf-selected")){i=e(".tf-selected",u).text();t.removeTag(0,o);o.text(o.attr("category")).attr("tag",undefined).removeClass("tf-selected");t.refresh(u);if(i==e(".tf-selected",u).text()){s=e(".tf-tag",u);if(s.length){s.click()}else if(a.last&&a.last.is(".tf-selected")){a.last.click()}else{a.tags=a.fix.slice();t.refresh(u)}}return true}else{r=Popup.create(this,"ul");e(r).data({tagfiltr:u,prefix:f,button:o});o.data("tags").map(function(e){t.newTagButton(r,e,t.lingo.tipAdd,t.popClick)});Popup.show();n.stopPropagation();return false}},popClick:function(n){var r=e(this),i=r.text(),s=r.closest(".popup");pd=s.data(),p=pd.prefix,$btn=pd.button,$t=pd.tagfiltr,d=$t.data();if(p){$btn.text(i).attr("tag",i).addClass("tf-selected")}d.tags.pushUnique(i);if(config.options.chkAnimate&&anim&&typeof Scroller=="function")anim.startAnimating(new Scroller($t[0]));else window.scrollTo(0,ensureVisible($t[0]));t.refresh($t);if(p)d.last=$btn;return!n.ctrlKey},removeTag:function(n,r){var i=r?e(r):e(this),s=i.closest(".tagfiltr"),o=s.data();if(i.is(".tf-fix")){e(".tf-tag",s).not(".tf-fix").each(function(){o.tags.remove(e(this).text())})}else o.tags.remove(i.text());if(!r)t.refresh(s);return false},getTiddlers:function(n){var r,i,s,o=[],u=n.data(),a=u.px;pm=a.tf_m={};a.tf_a=[];(u.filter?store.filterTiddlers(u.filter):store.getTiddlers("title")).map(function(e){if(!(e.tags&&e.tags.containsAny(u.ex))&&(1>u.tags.length||e.tags.containsAll(u.tags))&&(!u.bP||t.hasPrefix(n,e,true)))o.push(e)});if(!e.isEmptyObject(pm)){e.each(a,function(t,s){if(["tf_a","tf_m"].contains(t))return true;var f=[];if(pm[t])e.each(pm[t],function(e){f.push(e)});r=n.find('.tf-tags [prefix="'+t+'"]');if(f.length){f.sort();f.map(function(e){a.tf_a.push(e)});if(1==f.length&&o.length==pm[t][f[0]].length){r.text(f[0]).attr("tag",f[0]).addClass("tf-selected")}else{r.text(r.attr("category")).attr("tag",undefined).removeClass("tf-selected")}r.addClass("tf-prefix").data("tags",f);i=e('.tf-tag[tag="'+f[0]+'"]',n);if(i.length){i.remove();u.last=r}}else{r.removeClass("tf-prefix").data("tags",undefined)}})}return o},getTagSelection:function(e,t){var n=[],r=e.data();t.map(function(e){e.tags.map(function(e){if(!(r.px.tf_a.contains(e)||r.ex.contains(e)||r.tags.contains(e))){n.pushUnique(e)}})});return n.sort()},newTagButton:function(t,n,r,i,s){if(e(t).hasClass("popup"))t=e("<li/>").appendTo(t);return e('<a href="javascript:;" />').addClass(s||"").attr("title",r||"").text(n).click(i||null).appendTo(t)},hasPrefix:function(t,n,r){var i=0,s=t.data("px");if(n.tags){n.tags.map(function(t){e.each(s,function(e,o){if(t.indexOf(e)==0){i=1;if(r){if(!s.tf_m[e])s.tf_m[e]={};if(!s.tf_m[e][t])s.tf_m[e][t]=[];s.tf_m[e][t].push(n.title)}}return r||!i});return r||!i})}return i},getRef:function(t,n){t=e.trim(t);return 0==t.indexOf("##")?n+t:t}});Array.prototype.containsAll=function(e){for(var t=0;t<e.length;t++){if(!this.contains(e[t])){return false}}return true};config.shadowTiddlers.TagFiltrConfig="!Prefixes\n"+" #|status\n"+" ^|prio\n"+" @|context\n"+" &|area\n"+" ?|who\n"+" -|realm\n"+" =|type\n"+" !|resolution\n"+" §|stage\n"+" +|opportunity\n"+" /|where\n"+" $|project";config.shadowTiddlers.StyleSheetTagFiltr="/*{{{*/\n"+".filtr {display:block;}\n"+".tagfiltr {padding:5px;}\n"+".tagfiltr ul {margin: 0;padding: 0;}\n"+".tagfiltr > b,\n"+".tf-tags,\n"+".tf-tags .button {float: left;}\n"+".tf-tags .tf-fix {border-color:[[ColorPalette::TertiaryPale]];pointer:default;}\n"+".tf-tags {padding-bottom: 0.5em;}\n"+".tf-prefixes {padding-right:7px;float:left;}\n"+".tf-prefixes .button {display:none;}\n"+".tf-prefixes .tf-prefix {display:block;}\n"+".tf-prefixes .tf-selected {color:[[ColorPalette::SecondaryMid]];}\n"+".tagfiltr .tf-tids {clear:left;}\n"+".tf-default li {list-style-type:none;}\n"+".tf-default .tiddlyLink{display:block; padding: 1px 1px 1px 7px;}\n"+"/*}}}*/";store.addNotification("StyleSheetTagFiltr",refreshStyles)})(jQuery)
// %/