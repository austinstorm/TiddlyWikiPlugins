/***
|''Name:''|TagSearchPlugin|
|''Description:''|Provides a drop down listing current tags and others to be set.|
|''Author:''|[[Tobias Beer]]|
|''Version:''|1.2.0 (2010-10-10)|
|''Documentation:''|http://tagsearch.tiddlyspot.com|
|''Source:''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/IconTabsPlugin.min.js|
|''~CoreVersion:''|Version 2.5.3 or better|
/%***/
(function(e){config.macros.tagsearch={cfg:{defaultSource:"",defaultMore:"",defaultMode:1,keepModified:false,sidebarOffset:20,newAtSingle:30,newAt:18,excludeTagged:"",toolbar:"",label:"tags",options:"Options",more:"More...",tooltip:"Manage tiddler tags",notags:"no tags set...",aretags:"Current tags",addTag:"Add tag...",addTags:"Set tag...",txtEdit:"~ edit categories...",txtEditTip:"edit tiddler with GTD tag categories used by x-tagger",txtNew:"~ add another tag",txtRemove:"remove tag %0",txtAdd:"set tag %0",txtFor:"To be tagged... ",txtCtrl:" (hold SHIFT to just add it or CTRL to replace in category)",promptNew:"Enter new tag:",modeAsk:"Do you want to remove existing tags from category '%0'?\nCancel simply adds tag '%1'."},handler:function(t,n,r,i,s,o){var u=this.cfg,a=story.findContainingTiddler(t),f=s.parseParams("tagman",null,true);e(createTiddlyButton(t,getParam(f,"label",u.label),getParam(f,"tooltip",u.tooltip),this.click,"button")).attr({id:this.newId("btntgs"),tid:a?a.getAttribute("tiddler"):""}).data({pa:r,p:f})},click:function(t){var n,r,i,s,o=[],u=true,a,f,l,c,h,p,d,v,m,g,y=[],b,w,E,S=t||window.event,x=e(this),T=x.attr("popup"),N=window.event?"keydown":"keypress",C=config.macros.tagsearch,k=C.cfg,L=x.data("pa"),A=x.data("p"),O=L.contains("toolbar"),M=getParam(A,"source",k.defaultSource),_=getParam(A,"more",k.defaultMore),D=!L.contains("nosearch"),P=!L.contains("notags"),H=!L.contains("nomore"),B=getParam(A,"goto",""),j=parseInt(getParam(A,"mode")),F=getParam(A,"tiddler",""),I=F?F:x.attr("tid"),q=(getParam(A,"exclude","")+" "+k.excludeTagged).readBracketedList(),R=nu=M?k.newAt:k.newAtSingle,U=store.getTiddler(I);if(!I)return;j=isNaN(j)?k.defaultMode:j;q.map(function(e){o.pushUnique(e)});for(a=0;a<q.length;a++){store.getTaggedTiddlers(q[a]).map(function(e){o.pushUnique(e.title)})}if(M&&!store.getTiddlerText(M))return false;if(T){v=e("#"+T)[0];e(v).empty()}if(!v){c=true;T=C.newId("tgspop");v=Popup.create(this);e(v).addClass("tgs").attr({id:T}).data({btn:x,tiddler:I,source:M,mode:j}).click(C.noBubble);x.attr("popup",T)}if(M){b=store.getTiddlerText(M).readBracketedList();for(g=0;g<b.length;g++){if(!o.contains(b[g])){E=store.getTaggedTiddlers(b[g]);y.push("TAG:"+b[g]);for(m=0;m<E.length;m++){if(!o.contains(E[m].title))y.push(E[m].title)}}}}else y=store.getTags();r=U?U.tags.sort():[];p=function(e,t){return createTiddlyElement(createTiddlyElement(e,"li",null,null),"ol",null,t?t:null)};h=function(t,n,r,i){var s,o;s=createTiddlyElement(createTiddlyElement(t,"li"),"span",null,null);o=e(createTiddlyButton(s,n,i.format(["'"+r+"'"]),C.setTag,"button toggleButton",null));o.data({tiddler:I,tag:r,source:M,mode:j});insertSpacer(s);createTagButton(s,r)};i=p(v,"tgside");if(config.macros.gotoTiddler&&D){s=p(i);if(F){l=createTiddlyElement(s,"li",null,"addto","");wikify("{{title{"+k.txtFor+"}}}<<tag [["+I+"]]>>",l);s=p(i)}createTiddlyElement(s,"li",null,"title",k.addTag);wikify("<<gotoTiddler "+B+" >>",s);e("input",v).bind(N,C.noBubble).data("notify",config.macros.tagsearch.notify).focus()}s=p(i);createTiddlyElement(s,"li",null,"title",k.aretags);if(r.length==0)wikify("{{notags{"+k.notags+"}}}",s);else for(g=0;g<r.length;g++)h(s,"[X]",r[g],k.txtRemove);if(P){for(a=0;a<y.length;a++){nu++;w=M?y[a]:y[a][0];if(w.indexOf("TAG:")==0){w=w.substr(4);if(nu>R){nu=0;i=p(v)}s=p(i);nu++;createTiddlyLink(createTiddlyElement(s,"li",null,null),w,w,"title")}else if(!r.contains(w)&&!o.contains(w)){if(!M&&nu>R||M&&nu>k.newAtSingle){nu=0;i=p(v);s=p(i);if(u){createTiddlyElement(createTiddlyElement(s,"li",null,null),"li",null,"title",k.addTags);u=false}}h(s,"["+String.fromCharCode(160,160,160)+"]",w,k.txtAdd+(M?k.txtCtrl:""))}}}if(H){i=p(v,"tgside");s=p(i);createTiddlyElement(s,"li",null,"title",k.options,null);createTiddlyButton(createTiddlyElement(s,"li"),k.txtNew,null,C.setTag,"tsopt",null,null,{tiddler:I});if(M){createTiddlyButton(createTiddlyElement(s,"li"),k.txtEdit,k.txtEditTip,onClickTiddlerLink,"tsopt",null,null,{tiddlyLink:M.split("##")[0]})}u=true;if(_){d=store.getTiddlerText(_).readBracketedList();if(d.length>0){for(a=0;a<d.length;a++){w=d[a];if(w.indexOf("TAG:")==0){w=w.substr(4,w.length-4);s=p(i);createTiddlyLink(createTiddlyElement(s,"li",null,null),w,w,"title");n=store.getTaggedTiddlers(w);for(f=0;f<n.length;f++){w=n[f].title;if(!r.contains(w)&&!o.contains(w))h(s,"["+String.fromCharCode(160,160)+"]",w,k.txtAdd)}}else{if(u){s=p(i);createTiddlyElement(s,"li",null,"title",k.more);u=false}if(!r.contains(w)&&!o.contains(w))h(s,"["+String.fromCharCode(160,160)+"]",w,k.txtAdd)}}}}}if(c){Popup.show(v,false);if(O){m=document.getElementById("sidebar");v.style.left="";v.style.right=k.sidebarOffset+(m?m.offsetWidth:0)+"px"}}return C.noBubble(S)},setTag:function(t){var n,r,i,s=true,o,u,a,f,l=t||window.event,c=config.macros.tagsearch,h=c.cfg,p=e(this),d=p.closest(".tgs"),v=d.data("btn"),m=p.data("tag"),g=d.data("tiddler"),y=d.data("source"),b=parseInt(d.data("mode"));if(!m){i=prompt(h.promptNew,"");if(!i)return false;else m=i}tid=c.exists(g,m);if(tid){u=tid.tags;if(!u.contains(m)){if(y&&b<2&&!l.shiftKey){r=store.getTiddlerText(y).readBracketedList();e:for(n=0;n<r.length;n++){f=r[n];a=store.getTaggedTiddlers(f).map(function(e){return e.title});if(a.contains(m)){a.splice(a.indexOf(m),1);if(!l.ctrlKey&&b==1&&u.containsAny(a))s=confirm(h.modeAsk.format([f,m]));if(s){for(o=0;o<a.length;o++){f=a[o];if(u.contains(f))store.setTiddlerTag(g,false,f)}}break e}}}store.setTiddlerTag(g,true,m)}else if(!i)store.setTiddlerTag(g,false,m);o=store.getTiddler(g);store.saveTiddler(g,g,o.text,h.keepModified?o.modifier:config.options.txtUserName,h.keepModified?o.modified:new Date,o.tags,o.fields)}if(config.options.chkAutoSave)autoSaveChanges();v.click();d.find("input").focus();return c.noBubble(l)},newId:function(e){return e+Math.random().toString().substr(3)},notify:function(n,r){var i=e(r).closest(".tgs"),s=e("form input",i)[0];t=config.macros.tagsearch.exists(i.data("tiddler"),n);if(t&&!t.tags.contains(n))store.setTiddlerTag(t.title,t,n);i.data("btn").click();s.select()},exists:function(e,t){if(!store.getTiddler(e)){var n=merge({},config.defaultCustomFields);store.saveTiddler(e,e,"",config.options.txtUserName,new Date,t,n);return false}return store.getTiddler(e)},noBubble:function(e){var t=e||window.event,n=resolveTarget(t);if(t.keyCode==27)Popup.remove(0);else if(t.type!="click"&&n.nodeName.toUpperCase()=="INPUT")return true;if(hasClass(n,"tiddlyLink"))return true;Popup.remove(1);t.cancelBubble=true;try{event.keyCode=0}catch(t){}if(window.event)t.returnValue=false;if(t.preventDefault)t.preventDefault();if(t.stopPropagation)t.stopPropagation();return false}};config.commands.tagSearch={};var n=config.macros.toolbar;n.createCommandTAGS=n.createCommand;n.createCommand=function(t,r,i,s){if(r=="tagSearch"){wikify("<<tagsearch toolbar "+config.macros.tagsearch.cfg.toolbar+">>",t);e(t.lastChild).attr({commandName:"tagSearch",tiddler:i.title})}else n.createCommandTAGS.apply(this,arguments)};var r=config.macros.gotoTiddler;if(r){r.processItem=function(t,n,r,i){if(!t.length)return;r.style.display=i?"block":"none";if(t=="*"){story.search(n.value);return false}if(!i)n.value=t;var s=e(n).data("notify");if(s)s.call(this,t,n);else story.displayTiddler(null,t);return false};r.IEtableFixup="%0"}var i=store.getTiddlerText("ColorPalette::TertiaryMid"),s=store.getTiddlerText("ColorPalette::TertiaryDark");config.shadowTiddlers["StyleSheetTagSearch"]="/*{{{*/\n"+".tgs {padding:7px !important;-moz-border-radius:5px; -webkit-border-radius:5px;border-radius:5px;}\n"+".tgs li a, .tgs .quickopentag .tiddlyLink {display:inline;padding:2px;clear:none;}\n"+".tgs li a.toggleButton {display:inline;margin-left:5px;}\n"+".tgs .title {margin:3px 0 0 5px;font-weight:bold;font-size:150%;color:"+i+";padding:0;}\n"+".tgs form{display:block;float:left;clear:both;padding-left:5px !important;}\n"+".tgs .addto .quickopentag{display:block;clear:both;padding:5px;font-size:120%;}\n"+".tgs .notags, .tsopt{display:block;clear:both;margin:5px;}\n"+".tgs .highlight{background:"+s+";}\n"+".tgs ol{margin:0;padding:0 0 5px 0;}\n"+".tgs li{display:block;float:left;padding-bottom:10px !important;}\n"+".tgs li span{line-height:1em;}\n"+".tgs li ol li{clear:both;min-width:120px;display:inline;border:1px solid transparent;}\n"+".tgs li ol li:hover{border:1px solid "+i+";}\n"+".tgs li ol li ol li{padding:0 !important;}\n"+".tgs li ol li ol li:hover{border:1px solid transparent;}\n"+".tgside li ol li {min-width:150px;}"+".tgs .quickopentag {display:inline;}\n"+".tgs .quickopentag .tiddlyLink:hover {text-decoration:underline;}\n"+".tgs .quickopentag .button {border:0;padding:2px;font-size:1.5em;}\n"+"/*}}}*/";store.addNotification("StyleSheetTagSearch",refreshStyles)})(jQuery)
//%/