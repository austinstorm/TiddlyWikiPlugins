/***
|''Name''|GetPlugin|
|''Author''|[[Tobias Beer|http://tobibeer.tiddlyspace.com]]|
|''Description''|fetch and output a (list of) tiddler, section, slice or field using a predefined or custom format|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/GetPlugin.min.js|
|''Documentation''|http://get.tiddlyspace.com|
|''Version''|1.0.5 2013-10-08|
|''~CoreVersion''|2.6.2|
|''License''|Creative Commons 3.0|
/%***/
(function(e){var t=config.macros.get={config:"GetPluginConfig",dict:{errFunction:"Function undefined!",errFunctionInfo:"config.macros.get.get%0 is not a valid function!",errConfig:"Config not found!",errConfigInfo:"Config '%0' either does not exist or does not have a 'Tags' section!",defaultCategory:"Tiddler"},identifiers:{filter:"$",fuzzy:"~",tiddler:"!"},template:{fuzzy:"%0",tiddler:"![[%1]]\n%0",section:"!%3 / [[%1]]\n%0",slice:";%3\n:» %0",field:";%3\n:» %0",tiddlerList:"!![[%1]]\n%0",sectionList:"!![[%1]]\n%0",sliceList:";[[%1]]\n:» %0",fieldList:";[[%1]]\n:» %0",tiddlerTable:"|[[%1]]|<<tiddler [[%4]]>>|",sectionTable:"|[[%1]]|<<tiddler [[%4]]>>|",sliceTable:"|[[%1]]|<<tiddler [[%4]]>>|",fieldTable:"|[[%1]]|%0|\n",tiddlerTableHead:"| !%0 | !Text |h\n",sectionTableHead:"| !%0 | !%1 |h\n",sliceTableHead:"| !%0 | !%1 |h\n",fieldTableHead:"| !%0 | !%1 |h\n",tableClass:"getTable",dateFormat:"0DD.0MM.YYYY"},handler:function(n,r,i,s,o,u){if(!o)return;var a,f,l,c="",h,p,d,v,m,g,y=story.findContainingTiddler(n),b=u&&u.tags?u.tags:[],w=o.parseParams("anon",null,true),E=getParam(w,"config",false),S=getParam(w,"filter"),x=i.contains("listfiltr"),T=i[0];if(t.identifiers.fuzzy==T){var N=true;i.shift()}title=u&&!N?u.title:y?y.getAttribute("tiddler"):"";if(t.identifiers.tiddler==T){var C=true;i.shift()}if(t.identifiers.filter==T){e(store.getTiddlerText(i[1]).split("\n")).each(function(){var t=this.split("|");e(store.filterTiddlers(t[0])).each(function(){if(title==this.title)c=t[1];return!c});return!c});if(!c)return}else if(E){refItem=getParam(w,"refItem",t.identifiers.tiddler);refTag=getParam(w,"refTag",t.identifiers.tiddler);E=E=="true"?t.config:E;d=store.getTiddlerText(E+"##Tags");if(!d){createTiddlyError(n,t.dict.errConfig,t.dict.errConfigInfo.format([E]))}else{d=d.split("\n");v=store.getTiddlerText(E+"##Template");for(y=0;y<d.length;y++){h=d[y];if([""," ","/","{"].contains(h.substr(0,1)))continue;h=d[y].split("|");f=e.trim(h[h.length>2?2:h.length-1]).parseParams("anon",null,true);if(u.title==h[h.length==1?0:1]&&(h.length==1||h[1]!="")&&refTag!="false")l=1;else if(b.contains(h[0])&&(h.length==1||h[0]!="")&&refItem!="false")l=2;if(l){wikify('<<tiddler "'+E+'##Template" with: "'+(l==1?getParam(f,"refTag",refTag):getParam(f,"refItem",refItem))+'" "'+u.title+'"'+">>",n);return}}}return}var k=0,L="",A=[],O,M,_,D,P,H=e(n),B=H.attr("macroName")=="get",j=t[getParam(w,"exec","getValues")],F=getParam(w,"format",""),I=store.getTiddlerText(getParam(w,"template","")),q=i.contains("plain"),v=i.contains("table")?"Table":S||i.contains("list")?"List":"",R=v.toLowerCase(),g=C?"":i[0];ref=config.filters.get.delimiterRegExp.exec(c?"":g),sep=ref?ref[2]:"",element=ref?ref[3]:"",type=sep=="##"?"section":sep=="::"?"slice":sep=="??"?"field":"tiddler",prefixv=getParam(w,"valueprefix",""),prefix=getParam(w,"prefix",""),suffix=getParam(w,"suffix",""),cat=getParam(w,"category",t.dict.defaultCategory),header=getParam(w,"header",R!="table"?"":"|"+t.template.tableClass+" "+t.template.tableClass+type.toUpperCase()+"|k\n"+t.template[type+"TableHead"].format([cat,element])),footer=getParam(w,"footer",""),separator=getParam(w,"separator","\n");if(!c){title=N||!g?title:ref?ref[1]?ref[1]:title:g;O=q?"%0":F?F:I?I:t.template[N?"fuzzy":sep=="##"?"section"+v:sep=="::"?"slice"+v:sep=="??"?"field"+v:"tiddler"+v];if(j){P=j.call(t,o,N?g:(R?"":title)+sep+element,title,type,element,R,N)}else{createTiddlyError(n,t.dict.errFunction,t.dict.errFunctionInfo.format([get]));return false}do{k++;A.push(L);L=getParam(w,"$"+k,null)}while(L!=null);for(_=0;_<P.length;_++){M=P[_][0];D=prefixv+P[_][1];D=D.indexOf("***/\n")!=0?D:D.substr(5);for(k=1;k<A.length;k++){D=D.replace(new RegExp("\\$"+k,"mg"),A[k])}c+=(prefix+O.format([D,M,type,element,(R?M:"")+g,cat])+suffix).replace(/\$count/mg,String.zeroPad(_+1,P.length.toString().length))+(R&&_<P.length-1?separator:"")}}c=(header?header:"")+c+(footer?footer:"");if(!B){H=e("<span />");H.appendTo(n);n=H[0];H.attr({refresh:"macro",macroName:"get",params:o})}wikify((x?"{{lf_get{\n%0\n}}}<<listfiltr>>":"%0").format([e.trim(c)]),n)},refresh:function(n,r){e(n).empty();t.handler(n,"get",r.readMacroParams(),null,r)},getValues:function(e,n,r,i,s,o,u){var a,f,l,c,h,p=[],d=e.parseParams("getval",null,true),v=getParam(d,"filter",null),m=u?config.macros.ns:false,c=o?v?store.filterTiddlers(v):store.getTiddlers("title"):[{title:r}];if(u)o="";if(m){m=m?m.defaults.separator:"";l=r+m+n;m=store.getTiddlerText(l);if(m){p.push([l,m]);r=store.getTiddler(l);i="tiddler";u=null}}if(!m){for(f=0;f<c.length;f++){h=undefined;l=c[f].title;if(u||i=="field"){h=store.getValue(l,u?n:s);if(u&&h)i="field"}if(!h){if(u){h=store.getTiddlerText(l+"::"+n);if(h)i="slice";if(!h){h=store.getTiddlerText(l+"##"+n);if(h)i="section"}if(!h){h=store.getTiddlerText(n);if(h){i="tiddler"}}}else{h=store.getTiddlerText((o?l:"")+n)}}a=h&&h.length==12?Date.convertFromYYYYMMDDHHMM(h):undefined;if(a&&!isNaN(a.getMonth))h=a.formatString(t.template.dateFormat);if(h)p.push([l,h])}}return p}};config.filters.get=function(e,t){var n=config.filters.get.delimiterRegExp.exec(t[3]),r=n?n[1]:t[3],i=n?n[2]:"",s=n?n[3]:"";store.forEachTiddler(function(t,n){if(r&&r==t||!r&&(i=="??"&&store.getValue(t,s)||store.getTiddlerText(t+i+s)))e.pushUnique(n)});return e};config.filters.get.delimiterRegExp=/(.*)?(\#\#|::|\?\?)(.*)/})(jQuery)
//%/