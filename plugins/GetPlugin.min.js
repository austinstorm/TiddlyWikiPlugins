/***
|''Name''|GetPlugin|
|''Author''|[[Tobias Beer|http://tobibeer.tiddlyspace.com]]|
|''Description''|fetch and output a (list of) tiddler, section, slice or field using a predefined or custom format|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/GetPlugin.min.js|
|''Documentation''|http://get.tiddlyspace.com|
|''Version''|1.0.3 2013-08-28|
|''~CoreVersion''|2.6.2|
|''License''|Creative Commons 3.0|
/%***/
(function(e){config.macros.get={config:"GetPluginConfig",dict:{errFunction:"Function undefined!",errFunctionInfo:"config.macros.get.get%0 is not a valid function!",errConfig:"Config not found!",errConfigInfo:"Config '%0' either does not exist or does not have a 'Tags' section!",defaultCategory:"Tiddler"},identifiers:{filter:"$",fuzzy:"~",tiddler:"!"},template:{fuzzy:"%0",tiddler:"![[%1]]\n%0",section:"!%3 / [[%1]]\n%0",slice:";%3\n:» %0",field:";%3\n:» %0",tiddlerList:"!![[%1]]\n%0",sectionList:"!![[%1]]\n%0",sliceList:";[[%1]]\n:» %0",fieldList:";[[%1]]\n:» %0",tiddlerTable:"|[[%1]]|<<tiddler [[%4]]>>|",sectionTable:"|[[%1]]|<<tiddler [[%4]]>>|",sliceTable:"|[[%1]]|<<tiddler [[%4]]>>|",fieldTable:"|[[%1]]|%0|\n",tiddlerTableHead:"| !%0 | !Text |h\n",sectionTableHead:"| !%0 | !%1 |h\n",sliceTableHead:"| !%0 | !%1 |h\n",fieldTableHead:"| !%0 | !%1 |h\n",tableClass:"getTable",dateFormat:"0DD.0MM.YYYY"},handler:function(t,n,r,i,s,o){if(!s)return;var u,a,f,l="",c,h,p,d,v,m,g=story.findContainingTiddler(t),y=o&&o.tags?o.tags:[],b=s.parseParams("anon",null,true),w=getParam(b,"config",false),E=getParam(b,"filter"),S=r[0];if(this.identifiers.fuzzy==S){var x=true;r.shift()}title=o&&!x?o.title:g?g.getAttribute("tiddler"):"";if(this.identifiers.tiddler==S){var T=true;r.shift()}if(this.identifiers.filter==S){e(store.getTiddlerText(r[1]).split("\n")).each(function(){var t=this.split("|");e(store.filterTiddlers(t[0])).each(function(){if(title==this.title)l=t[1];return!l});return!l});if(!l)return}else if(w){refItem=getParam(b,"refItem",this.identifiers.tiddler);refTag=getParam(b,"refTag",this.identifiers.tiddler);w=w=="true"?this.config:w;p=store.getTiddlerText(w+"##Tags");if(!p){createTiddlyError(t,this.dict.errConfig,this.dict.errConfigInfo.format([w]))}else{p=p.split("\n");d=store.getTiddlerText(w+"##Template");for(g=0;g<p.length;g++){c=p[g];if([""," ","/","{"].contains(c.substr(0,1)))continue;c=p[g].split("|");a=e.trim(c[c.length>2?2:c.length-1]).parseParams("anon",null,true);if(o.title==c[c.length==1?0:1]&&(c.length==1||c[1]!="")&&refTag!="false"&&o)f=1;else if(y.contains(c[0])&&(c.length==1||c[0]!="")&&refItem!="false")f=2;if(f){wikify('<<tiddler "'+w+'##Template" with: "'+(f==1?getParam(a,"refTag",refTag):getParam(a,"refItem",refItem))+'" "'+o+'"'+">>",t);return}}}return}var N=0,C="",k=[],L,A,O,M,_,D=e(t),P=D.attr("macroName")=="get",H=this[getParam(b,"exec","getValues")],B=getParam(b,"format",""),j=store.getTiddlerText(getParam(b,"template","")),F=r.contains("plain"),d=r.contains("table")?"Table":E||r.contains("list")?"List":"",I=d.toLowerCase(),m=T?"":r[0];ref=config.filters.get.delimiterRegExp.exec(l?"":m),sep=ref?ref[2]:"",element=ref?ref[3]:"",type=sep=="##"?"section":sep=="::"?"slice":sep=="??"?"field":"tiddler",prefixv=getParam(b,"valueprefix",""),prefix=getParam(b,"prefix",""),suffix=getParam(b,"suffix",""),cat=getParam(b,"category",this.dict.defaultCategory),header=getParam(b,"header",I!="table"?"":"|"+this.template.tableClass+" "+this.template.tableClass+type.toUpperCase()+"|k\n"+this.template[type+"TableHead"].format([cat,element])),footer=getParam(b,"footer",""),separator=getParam(b,"separator","\n");if(!l){title=x?title:ref?ref[1]?ref[1]:title:m;if(!title)return;L=F?"%0":B?B:j?j:this.template[x?"fuzzy":sep=="##"?"section"+d:sep=="::"?"slice"+d:sep=="??"?"field"+d:"tiddler"+d];if(H){_=H.call(this,s,x?m:(I?"":title)+sep+element,title,type,element,I,x)}else{createTiddlyError(t,this.dict.errFunction,this.dict.errFunctionInfo.format([get]));return false}do{N++;k.push(C);C=getParam(b,"$"+N,null)}while(C!=null);for(O=0;O<_.length;O++){A=_[O][0];M=prefixv+_[O][1];M=M.indexOf("***/\n")!=0?M:M.substr(5);for(N=1;N<k.length;N++){M=M.replace(new RegExp("\\$"+N,"mg"),k[N])}l+=(prefix+L.format([M,A,type,element,(I?A:"")+m,cat])+suffix).replace(/\$count/mg,String.zeroPad(O+1,_.length.toString().length))+(I&&O<_.length-1?separator:"")}}l=(header?header:"")+l+(footer?footer:"");if(!P){D=e("<span />");D.appendTo(t);t=D[0];D.attr({refresh:"macro",macroName:"get",params:s})}wikify(e.trim(l),t)},refresh:function(t,n){e(t).empty();this.handler(t,"get",n.readMacroParams(),null,n)},getValues:function(e,t,n,r,i,s,o){var u,a,f,l,c,h=[],p=e.parseParams("getval",null,true),d=getParam(p,"filter",null),v=o?config.macros.ns:false,l=s?d?store.filterTiddlers(d):store.getTiddlers("title"):[{title:n}];if(o)s="";if(v){v=v?v.defaults.separator:"";f=n+v+t;v=store.getTiddlerText(f);if(v){h.push([f,v]);n=store.getTiddler(f);r="tiddler";o=null}}if(!v){for(a=0;a<l.length;a++){c=undefined;f=l[a].title;if(o||r=="field"){c=store.getValue(f,o?t:i);if(o&&c)r="field"}if(!c){if(o){c=store.getTiddlerText(f+"::"+t);if(c)r="slice";if(!c){c=store.getTiddlerText(f+"##"+t);if(c)r="section"}if(!c){c=store.getTiddlerText(t);if(c){r="tiddler"}}}else{c=store.getTiddlerText((s?f:"")+t)}}u=c&&c.length==12?Date.convertFromYYYYMMDDHHMM(c):undefined;if(u&&!isNaN(u.getMonth))c=u.formatString(this.template.dateFormat);if(c)h.push([f,c])}}return h}};config.filters.get=function(e,t){var n=config.filters.get.delimiterRegExp.exec(t[3]),r=n?n[1]:t[3],i=n?n[2]:"",s=n?n[3]:"";store.forEachTiddler(function(t,n){if(r&&r==t||!r&&(i=="??"&&store.getValue(t,s)||store.getTiddlerText(t+i+s)))e.pushUnique(n)});return e};config.filters.get.delimiterRegExp=/(.*)?(\#\#|::|\?\?)(.*)/})(jQuery)
//%/