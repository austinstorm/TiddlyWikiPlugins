/***
|''Name''|GetPlugin|
|''Author''|[[Tobias Beer|http://tobibeer.tiddlyspace.com]]|
|''Description''|fetch and output a (list of) tiddler, section, slice or field using a predefined or custom format|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/GetPlugin.min.js|
|''Documentation''|http://get.tiddlyspace.com|
|''Version''|1.0.1 2013-08-23|
|''~CoreVersion''|2.6.2|
|''License''|Creative Commons 3.0|
/%***/
(function(e){config.macros.get={dict:{errFunction:"Function undefined!",errFunctionInfo:"config.macros.get.get%0 is not a valid function!",defaultCategory:"Tiddler"},template:{fuzzy:"%0",tiddler:"![[%1]]\n%0",section:"!%3 / [[%1]]\n%0",slice:";%3\n:» %0",field:";%3\n:» %0",tiddlerList:"!![[%1]]\n%0",sectionList:"!![[%1]]\n%0",sliceList:";[[%1]]\n:» %0",fieldList:";[[%1]]\n:» %0",tiddlerTable:"|[[%1]]|<<tiddler [[%4]]>>|",sectionTable:"|[[%1]]|<<tiddler [[%4]]>>|",sliceTable:"|[[%1]]|<<tiddler [[%4]]>>|",fieldTable:"|[[%1]]|%0|\n",tiddlerTableHead:"| !%0 | !Text |h",sectionTableHead:"| !%0 | !%1 |h",sliceTableHead:"| !%0 | !%1 |h",fieldTableHead:"| !%0 | !%1 |h",tableClass:"getTable",dateFormat:"0DD.0MM.YYYY"},handler:function(n,r,i,s,o,u){if(!o)return;if("~"==i[0]){var a=true;i.shift()}if("!"==i[0]){var f=true;i.shift()}var l=0,c="",h=[],p,d="",v,m,g,y,b=e(n),w=b.attr("macroName")=="get",E=o.parseParams("anon",null,true);exec=this[getParam(E,"exec","getValues")],what=f?"":i[0],format=getParam(E,"format",""),template=store.getTiddlerText(getParam(E,"template","")),filter=getParam(E,"filter"),plain=i.contains("plain"),tpl=i.contains("table")?"Table":filter||i.contains("list")?"List":"",as=tpl.toLowerCase(),ref=config.filters.get.delimiterRegExp.exec(what),u=ref?ref[1]:what,sep=ref?ref[2]:"",element=ref?ref[3]:"",type=sep=="##"?"section":sep=="::"?"slice":sep=="??"?"field":"tiddler",prefixv=getParam(E,"valueprefix",""),prefix=getParam(E,"prefix",""),suffix=getParam(E,"suffix",""),cat=getParam(E,"category",this.dict.defaultCategory),header=getParam(E,"header",as!="table"?"":"|"+this.template.tableClass+" "+this.template.tableClass+type.toUpperCase()+"|k\n"+this.template[type+"TableHead"].format([cat,element])),footer=getParam(E,"footer",""),separator=getParam(E,"separator","\n"),t=story.findContainingTiddler(n);u=u&&!a?u:t?t.getAttribute("tiddler"):"";if(!u)return;p=plain?"%0":format?format:template?template:this.template[a?"fuzzy":sep=="##"?"section"+tpl:sep=="::"?"slice"+tpl:sep=="??"?"field"+tpl:"tiddler"+tpl];if(exec){y=exec.call(this,o,a?what:(as?"":u)+sep+element,u,type,element,as,a)}else{createTiddlyError(n,this.dict.noFunction,this.dict.errFunctionInfo.format([get]));return false}do{l++;h.push(c);c=getParam(E,"$"+l,null)}while(c!=null);for(m=0;m<y.length;m++){v=y[m][0];g=prefixv+y[m][1];g=g.indexOf("***/\n")!=0?g:g.substr(5);for(l=1;l<h.length;l++){g=g.replace(new RegExp("\\$"+l,"mg"),h[l])}d+=(prefix+p.format([g,v,type,element,(as?v:"")+what,cat])+suffix).replace(/\$count/mg,String.zeroPad(m+1,y.length.toString().length))+(as&&m<y.length-1?separator:"")}d=(header?header+"\n":"")+d+(footer?"\n"+footer:"");if(!w){b=e("<span />");b.appendTo(n);n=b[0];b.attr({refresh:"macro",macroName:"get",params:o})}wikify(e.trim(d),n)},refresh:function(t,n){e(t).empty();this.handler(t,"get",n.readMacroParams(),null,n)},getValues:function(e,t,n,r,i,s,o){var u,a,f,l,c,h=[],p=e.parseParams("getval",null,true),d=getParam(p,"filter",null),v=o?config.macros.ns:false,l=s?d?store.filterTiddlers(d):store.getTiddlers("title"):[{title:n}];if(o)s="";if(v){v=v?v.defaults.separator:"";f=n+v+t;v=store.getTiddlerText(f);console.log("NS: "+f+"\n"+v+"\n\n");if(v){h.push([f,v]);n=store.getTiddler(f);r="tiddler";o=null}}if(!v){for(a=0;a<l.length;a++){c=undefined;f=l[a].title;if(o||r=="field"){c=store.getValue(f,o?t:i);console.log("FIELD: "+f+"??"+o?t:i+"\n"+c+"\n\n");if(o&&c)r="field"}if(!c){if(o){c=store.getTiddlerText(f+"::"+t);console.log("SLICE: "+f+"::"+t+"\n"+c+"\n\n");if(c)r="slice";if(!c){c=store.getTiddlerText(f+"##"+t);console.log("SECTION: "+f+"##"+t+"\n"+c+"\n\n");if(c)r="section"}if(!c){c=store.getTiddlerText(t);console.log("TIDDLER: "+t+"\n"+c+"\n\n");if(c){r="tiddler"}}}else{c=store.getTiddlerText((s?f:"")+t)}}u=c&&c.length==12?Date.convertFromYYYYMMDDHHMM(c):undefined;if(u&&!isNaN(u.getMonth))c=u.formatString(this.template.dateFormat);if(c)h.push([f,c])}}return h}};config.filters.get=function(e,t){var n=config.filters.get.delimiterRegExp.exec(t[3]),r=n?n[1]:t[3],i=n?n[2]:"",s=n?n[3]:"";store.forEachTiddler(function(t,n){if(r&&r==t||!r&&(i=="??"&&store.getValue(t,s)||store.getTiddlerText(t+i+s)))e.pushUnique(n)});return e};config.filters.get.delimiterRegExp=/(.*)?(\#\#|::|\?\?)(.*)/})(jQuery)
//%/