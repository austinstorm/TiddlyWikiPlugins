/***
|''Name''|GetPlugin|
|''Author''|[[Tobias Beer|http://tobibeer.tiddlyspace.com]]|
|''Description''|fetch and output a (list of) tiddler, section, slice or field using a predefined or custom format|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/GetPlugin.min.js|
|''Documentation''|http://get.tiddlyspace.com|
|''Version''|1.0.2 2013-08-25|
|''~CoreVersion''|2.6.2|
|''License''|Creative Commons 3.0|
/%***/
(function(e){config.macros.get={config:"GetPluginConfig",dict:{errFunction:"Function undefined!",errFunctionInfo:"config.macros.get.get%0 is not a valid function!",errConfig:"Config not found!",errConfigInfo:"Config '%0' either does not exist or does not have a 'Tags' section!",defaultCategory:"Tiddler"},template:{fuzzy:"%0",tiddler:"![[%1]]\n%0",section:"!%3 / [[%1]]\n%0",slice:";%3\n:» %0",field:";%3\n:» %0",tiddlerList:"!![[%1]]\n%0",sectionList:"!![[%1]]\n%0",sliceList:";[[%1]]\n:» %0",fieldList:";[[%1]]\n:» %0",tiddlerTable:"|[[%1]]|<<tiddler [[%4]]>>|",sectionTable:"|[[%1]]|<<tiddler [[%4]]>>|",sliceTable:"|[[%1]]|<<tiddler [[%4]]>>|",fieldTable:"|[[%1]]|%0|\n",tiddlerTableHead:"| !%0 | !Text |h",sectionTableHead:"| !%0 | !%1 |h",sliceTableHead:"| !%0 | !%1 |h",fieldTableHead:"| !%0 | !%1 |h",tableClass:"getTable",dateFormat:"0DD.0MM.YYYY"},handler:function(t,n,r,i,s,o){if(!s)return;var u,a,f,l,c,h,p,d,v=o&&o.tags?o.tags:[],m=s.parseParams("anon",null,true),g=getParam(m,"config",false);if(g){refItem=getParam(m,"refItem","!");refTag=getParam(m,"refTag","!");g=g=="true"?this.config:g;h=store.getTiddlerText(g+"##Tags");if(!h){createTiddlyError(t,this.dict.errConfig,this.dict.errConfigInfo.format([g]))}else{h=h.split("\n");p=store.getTiddlerText(g+"##Template");for(f=0;f<h.length;f++){l=h[f];if([""," ","/","{"].contains(l.substr(0,1)))continue;l=h[f].split("|");u=e.trim(l[l.length>2?2:l.length-1]).parseParams("anon",null,true);if(o.title==l[l.length==1?0:1]&&(l.length==1||l[1]!="")&&refTag!="false"&&o)a=1;else if(v.contains(l[0])&&(l.length==1||l[0]!="")&&refItem!="false")a=2;if(a){wikify('<<tiddler "'+g+'##Template" with: "'+(a==1?getParam(u,"refTag",refTag):getParam(u,"refItem",refItem))+'" "'+o.title+'"'+">>",t);return}}}return}if("~"==r[0]){var y=true;r.shift()}if("!"==r[0]){var b=true;r.shift()}var w=0,E="",S=[],x,T="",N,C,k,L,A=e(t),O=A.attr("macroName")=="get",M=this[getParam(m,"exec","getValues")],_=b?"":r[0],D=getParam(m,"format",""),P=store.getTiddlerText(getParam(m,"template","")),H=getParam(m,"filter"),B=r.contains("plain"),p=r.contains("table")?"Table":H||r.contains("list")?"List":"",j=p.toLowerCase(),F=config.filters.get.delimiterRegExp.exec(_),o=F?F[1]:_,I=F?F[2]:"",q=F?F[3]:"",R=I=="##"?"section":I=="::"?"slice":I=="??"?"field":"tiddler",U=getParam(m,"valueprefix",""),z=getParam(m,"prefix",""),W=getParam(m,"suffix",""),X=getParam(m,"category",this.dict.defaultCategory),V=getParam(m,"header",j!="table"?"":"|"+this.template.tableClass+" "+this.template.tableClass+R.toUpperCase()+"|k\n"+this.template[R+"TableHead"].format([X,q])),$=getParam(m,"footer",""),J=getParam(m,"separator","\n"),f=story.findContainingTiddler(t);o=o&&!y?o:f?f.getAttribute("tiddler"):"";if(!o)return;x=B?"%0":D?D:P?P:this.template[y?"fuzzy":I=="##"?"section"+p:I=="::"?"slice"+p:I=="??"?"field"+p:"tiddler"+p];if(M){L=M.call(this,s,y?_:(j?"":o)+I+q,o,R,q,j,y)}else{createTiddlyError(t,this.dict.errFunction,this.dict.errFunctionInfo.format([get]));return false}do{w++;S.push(E);E=getParam(m,"$"+w,null)}while(E!=null);for(C=0;C<L.length;C++){N=L[C][0];k=U+L[C][1];k=k.indexOf("***/\n")!=0?k:k.substr(5);for(w=1;w<S.length;w++){k=k.replace(new RegExp("\\$"+w,"mg"),S[w])}T+=(z+x.format([k,N,R,q,(j?N:"")+_,X])+W).replace(/\$count/mg,String.zeroPad(C+1,L.length.toString().length))+(j&&C<L.length-1?J:"")}T=(V?V+"\n":"")+T+($?"\n"+$:"");if(!O){A=e("<span />");A.appendTo(t);t=A[0];A.attr({refresh:"macro",macroName:"get",params:s})}wikify(e.trim(T),t)},refresh:function(t,n){e(t).empty();this.handler(t,"get",n.readMacroParams(),null,n)},getValues:function(e,t,n,r,i,s,o){var u,a,f,l,c,h=[],p=e.parseParams("getval",null,true),d=getParam(p,"filter",null),v=o?config.macros.ns:false,l=s?d?store.filterTiddlers(d):store.getTiddlers("title"):[{title:n}];if(o)s="";if(v){v=v?v.defaults.separator:"";f=n+v+t;v=store.getTiddlerText(f);if(v){h.push([f,v]);n=store.getTiddler(f);r="tiddler";o=null}}if(!v){for(a=0;a<l.length;a++){c=undefined;f=l[a].title;if(o||r=="field"){c=store.getValue(f,o?t:i);if(o&&c)r="field"}if(!c){if(o){c=store.getTiddlerText(f+"::"+t);if(c)r="slice";if(!c){c=store.getTiddlerText(f+"##"+t);if(c)r="section"}if(!c){c=store.getTiddlerText(t);if(c){r="tiddler"}}}else{c=store.getTiddlerText((s?f:"")+t)}}u=c&&c.length==12?Date.convertFromYYYYMMDDHHMM(c):undefined;if(u&&!isNaN(u.getMonth))c=u.formatString(this.template.dateFormat);if(c)h.push([f,c])}}return h}};config.filters.get=function(e,t){var n=config.filters.get.delimiterRegExp.exec(t[3]),r=n?n[1]:t[3],i=n?n[2]:"",s=n?n[3]:"";store.forEachTiddler(function(t,n){if(r&&r==t||!r&&(i=="??"&&store.getValue(t,s)||store.getTiddlerText(t+i+s)))e.pushUnique(n)});return e};config.filters.get.delimiterRegExp=/(.*)?(\#\#|::|\?\?)(.*)/})(jQuery)
//%/