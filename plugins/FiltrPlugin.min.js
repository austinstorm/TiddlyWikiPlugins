/***
|''Name:''|FiltrPlugin|
|''Description:''|provides interactive tiddler filtering by date range, tags or modifers|
|''Documentation:''|http://filtr.tiddlyspace.com|
|''Author:''|[[Tobias Beer|http://tobibeer.tiddlyspace.com]]|
|''Version:''|1.4.4 (2013-10-07)|
|''Source''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/FiltrPlugin.min.js|
|''License''|[[Creative Commons Attribution-Share Alike 3.0|http://creativecommons.org/licenses/by-sa/3.0/]]|
|''CoreVersion:''|2.5|
<<filtr showTags exclude:''>>
/%***/
(function(e){var t=config.macros.filtr={};config.macros.filtr=e.extend(t,{exclude:"excludeLists",sortField:"-modified",showSpaces:false,showTags:false,showUsers:false,showValues:false,showDates:true,showMonths:true,showLabels:true,showCount:true,showNoTag:true,showNoValue:true,allYears:true,listfiltr:true,fmtHeaderCount:"%0",fmtHeaderField:"%0",fmtHeader:"",fmtItem:"\n*{{filtrDate{%modified}}}%hastags %tags",fmtCount:"",fmtField:"%0",fmtDate:"YYYY-0MM-0DD",fmtYear:"YYYY",fmtMonth:"mmm",fmtTags:'{{filtrTags{<<tags "%0">>}}}',fmtLabel:"%0:",txtSel:"select ",txtSet:"set or unset %0 filter to %1...",txtSpace:"space",txtTag:"tag",txtUser:"user",txtYear:"year",txtMonth:"month",txtEmpty:{tag:"<untagged>",user:"<missing>",space:"<missing>",field:"<undefined>"},spaces:"",users:"",tags:"",field:"",handler:function(n,r,i,s,o,u){var a,f,l,c,h=0,p,d,v,m={},g=0,y=[],b,w={},E,S,x,T,N=[],b=config.extensions.tiddlyspace,C=o.parseParams("anon",null,true),k=getParam(C,"template","");(store.getTiddlerText(k)||"").split("\n").map(function(e){var t=e.indexOf(":"),n=t<0?e:e.substr(0,t);w[n]=t<0?true:e.substr(t+1)});["exclude|x","sortField|sf","showSpaces|bS","showTags|bT","showUsers|bU","showValues|bF","showDates|bD","showMonths|bM","showLabels|bL","showCount|bC","showNoTag|nT","showNoValue|nV","allYears|aY","listfiltr|lf","fmtHeader|f0","fmtItem|f1","fmtCount|fc","fmtHeaderCount|fch","fmtDate|fd","fmtField|ff","fmtHeaderField|ffh","fmtYear|fy","fmtMonth|fm","fmtTags|fts","fmtLabel|fl","spaces","tags","users","field|fi"].map(function(e){e=e.split("|");var n=e[0],r=e[1]||e[0];m[r]=getParam(C,n,k&&w[n]?w[n]:t[n]!=undefined?t[n]:"");if(i.contains(n)){m[r]=true}});m.desc=0==m.sf.indexOf("-"),m.sf=m.desc?m.sf.substr(1):m.sf;p=createTiddlyElement(n,"div",null,"filtr");m.fi=m.fi.split("|");m.filbl=m.fi[0];m.fi=(m.fi[1]||m.fi[0]).toLowerCase();m.ex=[];m.x=m.x.readBracketedList();m.x.map(function(e){m.ex.push(e)});store.forEachTiddler(function(e,t){if(m.x.containsAny(t.tags)){m.ex.pushUnique(t.title)}else{y.push(t)}});["bS","bT","bU","bF","bD","bM","bL","bC","nT","nV","lf"].map(function(e){m[e]="true"==m[e].toString()});if(m.spaces&&b){l=true;m.spaces=m.spaces.readBracketedList()}else m.spaces=[];m.bS=b&&!l&&m.bS;if(m.tags)f=true;else m.tags=[];m.bT=!f&&m.bT;if(f){if(m.tags.substr(0,8).toUpperCase()=="TIDDLER=")m.tags=store.getTiddlerText(m.tags.substr(8))||"";m.tags=m.tags.readBracketedList()}if(m.users){c=true;m.users=m.users.readBracketedList()}else m.users=[];m.bU=!c&&m.bU;m.vals=[];while(g<y.length){a=1;tid=y[g];if(m.x.containsAny(tid.tags)){a=0}if(a&&b.resolveSpaceName&&(l||m.bS)){T=b.resolveSpaceName(store.getValue(tid.title,"server.bag"));if(l&&!m.spaces.contains(T))a=0}if(a&&f){if(!m.tags.containsAny(tid.tags))a=0}if(a&&m.bT){S=[];if(tid.tags.length==0){if(m.nT)S.push("");else a=0}tid.tags.map(function(e){if(config.macros.untagged&&(config.macros.untagged.hideTags+(readOnly?" "+config.macros.untagged.hideTagsReadOnly:"")).readBracketedList().contains(e))return true;if(!m.tags.contains(e)){var t=store.getTiddler(e);if(m.ex.contains(e)||m.ex.containsAny(t?t.tags:[])){a=0}else{S.push(e)}}})}if(a&&(c||m.bU)){x=tid.modifier;if(c&&!m.users.contains(x))a=0}if(a&&m.bF){E=store.getValue(tid.title,m.fi);if(!m.nV&&!E||m.vals.contains(E)){a=0}}if(a&&m.bD){if(0==h){d=t.isDate(tid[m.sf]);m.yMin=3e3;m.yMax=0;h=1}if(d){var L=(new Date(tid[m.sf])).getYear()+1900;m.yMin=Math.min(m.yMin,L);m.yMax=Math.max(m.yMax,L);N[L]=true}}if(a){if(T!=undefined)m.spaces.pushUnique(T);if(S!=undefined)S.map(function(e){m.tags.pushUnique(e)});if(x!=undefined)m.users.pushUnique(x);if(E!=undefined)m.vals.pushUnique(E);g++}else{y.splice(g,1)}}"Space|User|Tag|VAL|Year|Month".split("|").map(function(n){var r,i,s,o,u,a=n.toLowerCase(),f=m[a+"s"],l=n=="VAL"?m.filbl:t["txt"+n],c=m.bL?m["fl"].format([l.length<15?l:l.replace(/(\.|\_)/mg,".\n")]):"",r="filtr_"+(n=="VAL"?m.fi.replace(/\./mg,"_"):a),h=n=="VAL"?m.fi:a;if(f){if(f.length){f.sortCaseInsensitive();if(""==f[0]){f.splice(0,1);f.push("")}}else return true}else if(!m.bD||!m.bM&&n=="Month"){return true}i=createTiddlyElement(p,"div",null,"filtrGroup");if(c)createTiddlyElement(i,"strong",null,null,c);i=createTiddlyElement(i,"div",null,r,null,{group:h});for(o=h=="year"?m.yMax:h=="month"?1:0;h=="year"?o>=m.yMin:h=="month"?o<13:o<f.length;h=="year"?o--:o++){if(h=="year"&&(!m.yMin||!N[o])||h=="month"&&(!m.bM||!m.yMin))continue;s=f?f[o]:o;u=h=="year"?(new Date(o+"/01/01 00:00:00")).formatString(m.fy):h=="month"?(new Date("2000/"+String.zeroPad(o,2)+"/01 00:00:00")).formatString(m.fm):""==s?t.txtEmpty[n=="VAL"?"field":h]:s;e(createTiddlyButton(i,u,t.txtSet.format(l,u),t.filter,"button")).data("value",s==""?"":["year","month"].contains(h)?o:u).dblclick(function(){return false})}});v=e(createTiddlyElement(n,"div",null,"filtrList"));v.data(m);this.filter(v)},filter:function(n){var r,i,s,o,u,a=0,f="",l,c,h,p,d,v,m,g,y=config.extensions.tiddlyspace,b=e(n.html?n:this),m=b.data("value"),w=n||window.event,l=w.shiftKey,E=n.html?b:b.closest(".filtr").next(),S=E.prev(),x=E.data(),T="space|user|tag|VAL|year|month".split("|");if(x.y0==undefined){x.y1=x.yMax;x.y0=x.aY?x.yMin:x.y1;x.m0=1;x.m1=12}d=store.getTiddlers(x.sf);if(m!=undefined){o=b.closest("div").attr("group");switch(o){case"space":x.space=x.space==m?undefined:m;break;case"tag":x.tag=x.tag==m?undefined:m;break;case"user":x.user=x.user==m?undefined:m;break;case"year":if(l){u=x.yX;u=u?u:x.y0;x.y0=m<u?m:u;x.y1=m<u?u:m}else{if(b.hasClass("filtr_active")&&b.parent().find(".button").not(".filtr_active").length>0){x.yX=x.y0=x.yMin;x.y1=x.yMax}else{x.yX=x.y0=x.y1=m}}if(!w.ctrlKey){x.m0=x.mX=1;x.m1=12}break;case"month":if(l){u=x.mX;u=u?u:x.m0;x.m0=m<u?m:u;x.m1=m<u?u:m}else{if(b.hasClass("filtr_active")&&b.parent().find(".button").not(".filtr_active").length>0){x.mX=x.m0=1;x.m1=12}else{x.m0=x.m1=x.mX=m}}break;default:x.field=x.field==m?undefined:m;break}}for(h=x.desc?d.length-1:0;x.desc?h>=0:h<d.length;x.desc?h--:h++){p=d[h];g=x.fi?store.getValue(p.title,x.fi):"";space=y&&y.resolveSpaceName?y.resolveSpaceName(store.getValue(p.title,"server.bag")):"";i=p[x.sf]?p[x.sf]:store.getValue(p.title,x.sf);if(x.ex.containsAny(p.tags)||undefined!=x.space&&space!=x.space||undefined!=x.tag&&!(x.tag==""&&!p.tags.length)&&!p.tags.contains(x.tag)||undefined!=x.user&&x.user!=p.modifier||undefined!=x.field&&!(x.field==""&&g==undefined)&&x.field!=g||x.bD&&!t.inRange(i,x.m0,x.m1,x.y0,x.y1)||x.fi&&!x.bF&&!g)continue;c=!p.tags||p.tags.length<1?"":x.fts.format([p.title]);a++;f+=x.f1.replace(/%title/mg,"[["+p.title+"]]").replace(/%modifier/mg,p.modifier).replace(/%modified/mg,p.modified.formatString(x.fd)).replace(/%created/mg,p.created.formatString(x.fd)).replace(/%sortfield/mg,x.bD||t.isDate(i)?i.formatString(x.fd):i).replace(/%space/mg,space).replace(/%tags/mg,c).replace(/%hastags/mg,store.getTaggedTiddlers(p.title).length>0?"<<tag [["+p.title+"]]>>":"[["+p.title+"]]").replace(/%field/mg,x.fi?x.ff.format([t.isDate(g)?(new Date(g)).formatString(x.fd):g]):"").replace(/%count/mg,x.bC?x.fc.format([a]):"").replace(/(%nl)|\\n/mg,"\n")}T.map(function(t){s=0;if(t=="VAL"){s=1;t=x.fi.replace(/\./mg,"_")}var n=e(".filtr_"+t+" .button",S);n.each(function(){var r=e(this),i=r.data("value");if(n.length==1||t=="space"&&(undefined==x.space||x.space==i)||t=="tag"&&(undefined==x.tag||x.tag==i)||t=="user"&&(undefined==x.user||x.user==i)||t=="year"&&x.y0<=i&&i<=x.y1||t=="month"&&x.m0<=i&&i<=x.m1||s&&(undefined==x.field||x.field==i))r.addClass("filtr_active");else r.removeClass("filtr_active")})});E.empty();if(f){wikify((x.lf&&config.macros.listfiltr?"\n{{filtr_list{%0\n}}}<<listfiltr>>":"%0").format([x.f0.replace(/%field/mg,x.fi?x.ffh.format([x.filbl]):"").replace(/%count/mg,x.bC?x.fch:"").replace(/%sortfield/mg,x.sf).replace(/(%nl)|\\n/mg,"\n")+f]),E[0])}if(config.tableSorting&&config.tableSorting.refresh)config.tableSorting.refresh(E[0].parentNode);return false},inRange:function(e,t,n,r,i){var s,o=32-(new Date(i,n+1,32)).getDate();for(s=r;s<=i;s++){if(e>=this.getDate(s,t,1)&&e<=this.getDate(s,n,o,true))return true}return false},getDate:function(e,t,n,r){return new Date(e+"/"+String.zeroPad(t,2)+"/"+String.zeroPad(n,2)+(r?" 23:59:59":" 00:00:00"))},isDate:function(e){return(new Date(e)).getMonth()}});if(!Array.prototype.sortCaseInsensitive)Array.prototype.sortCaseInsensitive=function(){return this.sort(function(e,t){var n=e.toLowerCase(),r=t.toLowerCase();return n<r?-1:n>r?1:0})};config.shadowTiddlers.StyleSheetFiltr=["/*{{{*/",".filtr {display:block;}",".filtr .button{display:block;float:left;margin:3px 3px 0 0;padding:0.2em 0.4em;-moz-border-radius:7px;border-radius:7px;}",".filtr .filtr_active{background:#FE8 !important;}",".filtrGroup {display:block;padding:5px 0 0 0;clear:left;vertical-align:middle;}",".filtrGroup div {display:block; float:left; width:85%;}",".filtrGroup strong{display:block;float:left;min-width:80px;width:14%;text-align:right;padding-top:0.2em;margin:3px 1% 0 0;}",".filtrList {clear:left;padding-top:1px;}",".filtrList ul {list-style-type:none;}",".filtrList ul,.filtrList ol {margin-left:0;padding-left:0em;list-style-position:inside;}",".filtrList ul li,.filtrList ol li {padding:2px 0 2px 0.5em;border-bottom:1px solid [[ColorPalette::TertiaryPale]];}",".filtrList ul li:hover,.filtrList ol li:hover {background:[[ColorPalette::TertiaryPale]];}",".filtrDate {color:[[ColorPalette::TertiaryMid]];margin-right:5px;}",".filtrTags {max-width:50%;float:right;text-align:right;display:inline-block;margin-right:0.5em;}",".filtrTags .button {margin:0 0 0 3px;}",".filtrTags .listTitle {display:none}",".filtrTags ul, .filtrTags li {margin:0 !important;padding:0 !important;list-style-type:none;display:inline;}","/*}}}*/"].join("\n");store.addNotification("StyleSheetFiltr",refreshStyles)})(jQuery)
//%/