/***
|''Name:''|SinglePageHistoryPlugin|
|''Description:''|Limits to only one tiddler open. Manages an history stack and provides macro to navigate in this history (<<history>><<history back>><<history forward>>).|
|''Version:''|0.7.0|
|''Date:''|2008-08-28|
|''Source:''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/SimpleTreePlugin.js|
|''Author:''|[[Tobias Beer|http://tobibeer.tiddlyspace.com]]|
|''[[License]]:''|[[BSD open source license|http://tiddlywiki.bidix.info/#%5B%5BBSD%20open%20source%20license%5D%5D ]]|
|''~CoreVersion:''|2.5.2|
* based on http://tiddlywiki.bidix.info/#HistoryPlugin by BidiX
* added features of http://tiddlytools.com/#SinglePageModePlugin by Eric Shulman
** browser history forward back
** location in address bar
!Code
***/
//{{{
(function(e){config.options.chkOpenDefaultOnEmpty=true;config.macros.history={lingo:{historyLbl:"History",historyTip:"Click to show history...",forwardLbl:">",forwardTip:"Forward to previous tiddler...",backLbl:"<",backTip:"Back to last tiddler...",cancelEdit:"'%0' is being edited.\n\n"+"OK saves and closes the tiddler,\n"+"cancel leaves it open."},maxHistory:30,headerHeight:150,handler:function(t,n,r){var i,s=r[0],o=story.historyIndex;cls="button btn-history btn-history-";if(s){type=s=="back"?s:"forward";i=createTiddlyButton(t,this.lingo[type+"Lbl"],this.lingo[type+"Tip"],config.macros.history.go,cls+type);if(s=="back"&&o==0||o==story.tiddlerHistory.length-1)e(i).addClass("btn-history-none")}else{createTiddlyButton(t,this.lingo.historyLbl,this.lingo.historyTip,config.macros.history.showPopup,"button btn-history btn-history-popup")}},showPopup:function(t){var n,r,i,s=t||window.event,o=Popup.create(this);for(n=0;n<story.tiddlerHistory.length;n++){i=story.tiddlerHistory[n];r=createTiddlyButton(createTiddlyElement(o,"li"),i,i,config.macros.history.go);e(r).attr("historyIndex",n);if(i==story.currentTiddler)e(r).addClass("btn-history-current")}Popup.show(o,false);s.cancelBubble=true;if(s.stopPropagation)s.stopPropagation();return false},go:function(){var t=config.macros.history;len=story.tiddlerHistory.length,forward=e(this).hasClass("btn-history-forward"),history=e(this).attr("historyIndex")!=undefined,p0=story.historyIndex,index=history?parseInt(this.getAttribute("historyIndex")):forward?p0+1:p0-1,current=story.currentTiddler,next=story.tiddlerHistory[index];if(!next||next==current||t.checkDirty()){return false}story.historyIndex=index;story.button=true;story.displayTiddler(null,next);story.button=false;e(".btn-history-back, .btn-history-forward").addClass("btn-history-none");if(index>=0&&index<len-1)e(".btn-history-forward").removeClass("btn-history-none");if(index<=len-1&&index>0)e(".btn-history-back").removeClass("btn-history-none");return false},checkDirty:function(){var e=false;story.forEachTiddler(function(t,n){if("true"==n.getAttribute("dirty")){if(confirm(config.macros.history.lingo.cancelEdit.format([t])))story.saveTiddler(t);else{e=true;return false}}});return e}};var t=Story.prototype;t.tiddlerHistory=[];t.historyIndex=-1;t.currentTiddler=null;t.button=false;t.displayTiddlerSINGLEPAGEHISTORY=t.displayTiddler;t.displayTiddler=function(t,n,r,i,s){var o,u=[],a=config.macros.history;index=this.historyIndex,len=this.tiddlerHistory.length,current=this.currentTiddler,next=typeof n==="string"?n:n.title;if(current!=next&&r!=2){if(!this.button){if(a.checkDirty()){return false}if(len>0&&index<len-1){for(o=0;o<=index;o++)u.push(this.tiddlerHistory[o]);u.push(next);this.historyIndex+=1;this.tiddlerHistory=u}else{this.tiddlerHistory.push(next);if(len>a.maxHistory)this.tiddlerHistory.shift();else this.historyIndex+=1}e(".btn-history-forward").addClass("btn-history-none");if(next!=current&&index>=0)e(".btn-history-back").removeClass("btn-history-none")}if(current)story.closeTiddler(current);this.currentTiddler=next;var f=encodeURIComponent(String.encodeTiddlyLink(next));window.location.href=location.protocol+"//"+location.host+location.pathname+"#"+f;document.title=wikifyPlain("SiteTitle")+" - "+next}story.displayTiddlerSINGLEPAGEHISTORY("top",next,r,i,s);var l=e(document.body),c=e(story.getTiddler(next));l.animate({scrollTop:c.offset().top-l.offset().top-a.headerHeight})};var n=config.commands;n.closeTiddler.handlerSINGLEPAGEHISTORY=n.closeTiddler.handler;n.closeTiddler.handler=function(e,t,n){config.commands.closeTiddler.handlerSINGLEPAGEHISTORY.apply(this,arguments);story.displayTiddler("top",store.getTiddlerText("DefaultTiddlers").readBracketedList()[0]);return false}})(jQuery)
//}}}