/***
|''Name:''|SinglePageHistoryPlugin|
|''Description:''|Limits to only one tiddler open. Manages an history stack and provides macro to navigate in this history (<<history>><<history back>><<history forward>>).|
|''Author:''|[[Tobias Beer|http://tobibeer.tiddlyspace.com]]|
|''Version:''|0.7.3 (2013-09-05)|
|''~CoreVersion:''|2.5.2|
|''Documentation:''|http://singlepagehistory.tiddlyspace.com|
|''Source:''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/SinglePageHistoryPlugin.min.js|
|''License''|Creative Commons 3.0|
***/
// /%
(function(e){var t={chkOpenDefaultOnEmpty:true,chkSinglePageMode:true};for(var n in t)if(config.options[n]===undefined)config.options[n]=t[n];config.macros.history={lingo:{historyLbl:"History",historyTip:"Click to show history...",forwardLbl:">",forwardTip:"Forward to previous tiddler...",backLbl:"<",backTip:"Back to last tiddler...",cancelEdit:"'%0' is being edited.\n\n"+"OK saves and closes the tiddler,\n"+"cancel leaves it open."},maxHistory:30,headerHeight:150,handler:function(t,n,r){var i,s=r[0],o=story.historyIndex;cls="button btn-history btn-history-";if(s){type=s=="back"?s:"forward";i=createTiddlyButton(t,this.lingo[type+"Lbl"],this.lingo[type+"Tip"],config.macros.history.go,cls+type);if(s=="back"&&o==0||o==story.tiddlerHistory.length-1)e(i).addClass("btn-history-none")}else{createTiddlyButton(t,this.lingo.historyLbl,this.lingo.historyTip,config.macros.history.showPopup,"button btn-history btn-history-popup")}},showPopup:function(t){var n,r,i,s=t||window.event,o=Popup.create(this);for(n=0;n<story.tiddlerHistory.length;n++){i=story.tiddlerHistory[n];r=createTiddlyButton(createTiddlyElement(o,"li"),i,i,config.macros.history.go);e(r).attr("historyIndex",n);if(i==story.currentTiddler)e(r).addClass("btn-history-current")}Popup.show(o,false);s.cancelBubble=true;if(s.stopPropagation)s.stopPropagation();return false},go:function(){var t=config.macros.history;len=story.tiddlerHistory.length,forward=e(this).hasClass("btn-history-forward"),history=e(this).attr("historyIndex")!=undefined,p0=story.historyIndex,index=history?parseInt(this.getAttribute("historyIndex")):forward?p0+1:p0-1,current=story.currentTiddler,next=story.tiddlerHistory[index];if(!next||next==current||t.checkDirty()){return false}story.historyIndex=index;story.button=true;story.displayTiddler(null,next);story.button=false;e(".btn-history-back, .btn-history-forward").addClass("btn-history-none");if(index>=0&&index<len-1)e(".btn-history-forward").removeClass("btn-history-none");if(index<=len-1&&index>0)e(".btn-history-back").removeClass("btn-history-none");return false},checkDirty:function(){var e=false;story.forEachTiddler(function(t,n){if("true"==n.getAttribute("dirty")){if(confirm(config.macros.history.lingo.cancelEdit.format([t])))story.saveTiddler(t);else{e=true;return false}}});return e}};var r=Story.prototype;r.tiddlerHistory=[];r.historyIndex=-1;r.currentTiddler=null;r.button=false;r.displayTiddlerSINGLEPAGEHISTORY=r.displayTiddler;r.displayTiddler=function(t,n,r,i,s){var o,u=[],a=config.options["chkSinglePageMode"],f=config.macros.history;index=this.historyIndex,len=this.tiddlerHistory.length,current=this.currentTiddler,next=typeof n==="string"?n:n.title;if(current!=next&&r!=2){if(!this.button){if(f.checkDirty()&&a){return false}if(len>0&&index<len-1){for(o=0;o<=index;o++)u.push(this.tiddlerHistory[o]);u.push(next);this.historyIndex+=1;this.tiddlerHistory=u}else{this.tiddlerHistory.push(next);if(len>f.maxHistory)this.tiddlerHistory.shift();else this.historyIndex+=1}e(".btn-history-forward").addClass("btn-history-none");if(next!=current&&index>=0)e(".btn-history-back").removeClass("btn-history-none")}if(current&&a&&!story.reallyDoOpenAll){story.closeTiddler(current,false,"OPENING")}this.currentTiddler=next;var l=encodeURIComponent(String.encodeTiddlyLink(next));window.location.href=location.protocol+"//"+location.host+location.pathname+"#"+l;document.title=wikifyPlain("SiteTitle")+" - "+next}story.displayTiddlerSINGLEPAGEHISTORY("top",next,r,i,s);var c=e(document.body),h=e(story.getTiddler(next));c.animate({scrollTop:h.offset().top-c.offset().top-f.headerHeight})};Story.prototype.closeTiddlerSINGLEPAGEHISTORY=Story.prototype.closeTiddler;Story.prototype.closeTiddler=function(e,t,n){Story.prototype.closeTiddlerSINGLEPAGEHISTORY.apply(this,arguments);if(n!="OPENING"&&config.options.chkOpenDefaultOnEmpty){var r=0;this.forEachTiddler(function(e,t){r++;return r<2});if(r<2){this.displayTiddler("top",store.getTiddlerText("DefaultTiddlers").readBracketedList()[0])}}};onClickTagSINGLEPAGEHISTORY=onClickTag;onClickTag=function(t){onClickTagSINGLEPAGEHISTORY.apply(this,arguments);var n=t||window.event,r=e("#popup");if(n.ctrlKey){r.attr("doOpenAll","true")}else{if(config.options.chkSinglePageMode){var i=e("a",r).first(),s=e("a",r).last(),o=s.parent();if(i.length){s.insertAfter(i);i.remove();o.add(o.prev(".listBreak")).remove()}}}};onClickTagOpenAllSINGLEPAGEHISTORY=onClickTagOpenAll;onClickTagOpenAll=function(t){story.reallyDoOpenAll=e(this).closest("#popup").attr("doOpenAll");onClickTagOpenAllSINGLEPAGEHISTORY.apply(this,arguments);story.reallyDoOpenAll=false}})(jQuery)
// %/