/***
|''Name:''|SinglePageHistoryPlugin|
|''Description:''|Limits to only one tiddler open (mostly). Manages an history stack and provides macro to navigate in this history (<<history>><<history back>><<history forward>>).|
|''Author:''|[[Tobias Beer|http://tobibeer.tiddlyspace.com]]|
|''Version:''|1.0.5 (2013-10-14)|
|''~CoreVersion:''|2.5.2|
|''Documentation:''|http://singlepagehistory.tiddlyspace.com|
|''Source:''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/SinglePageHistoryPlugin.min.js|
|''License''|Creative Commons 3.0|
***/
// /%
(function(e){var t=config.options;e.each({chkOpenDefaultOnEmpty:true,chkSinglePageMode:true,chkOpenTop:true},function(e,n){if(t[e]===undefined)t[e]=n});var n=config.macros.history={maxHistory:30,intervalUpdateURL:500,lingo:{historyLbl:"History",historyTip:"Click to show history...",forwardLbl:">",forwardTip:"Forward to previous in history...",backLbl:"<",backTip:"Back to last in history...",cancelEdit:"'%0' is being edited.\n\n"+"OK saves and closes it.\n"+"CANCEL leaves it open."},history:[],historyIndex:-1,currentTiddler:null,button:false,timeoutChangedURL:0,lastURL:window.location.href,openAll:false,handler:function(t,r,i){var s,o=i[0],u=n.historyIndex,a="button btn-history btn-history-";if(o){type=o=="back"?o:"forward";s=createTiddlyButton(t,n.lingo[type+"Lbl"],n.lingo[type+"Tip"],n.go,a+type);if(o=="back"&&u==0||o!="back"&&u==n.history.length-1)e(s).addClass("btn-history-none")}else{createTiddlyButton(t,n.lingo.historyLbl,n.lingo.historyTip,n.showPopup,"button btn-history btn-history-popup")}},showPopup:function(t){var r,i,s,o=t||window.event,u=Popup.create(this);for(r=0;r<n.history.length;r++){s=n.history[r];i=createTiddlyButton(createTiddlyElement(u,"li"),s,s,n.go);e(i).attr("historyIndex",r);if(s==n.currentTiddler)e(i).addClass("btn-history-current")}Popup.show(u,false);o.cancelBubble=true;if(o.stopPropagation)o.stopPropagation();return false},go:function(){var t,r=e(this),i=n.history.length,s=r.hasClass("btn-history-forward"),o=r.attr("historyIndex"),u=n.currentTiddler,o=undefined!=o?parseInt(o):n.historyIndex+(s?1:-1);t=n.history[o];if(!t||t==u||n.checkDirty()){return false}n.historyIndex=o;n.button=true;story.displayTiddler(null,t);n.button=false;e(".btn-history-back, .btn-history-forward").addClass("btn-history-none");if(o>=0&&o<i-1)e(".btn-history-forward").removeClass("btn-history-none");if(o<=i-1&&o>0)e(".btn-history-back").removeClass("btn-history-none");return false},checkDirty:function(){var e=false;story.forEachTiddler(function(t,r){if("true"==r.getAttribute("dirty")){if(confirm(n.lingo.cancelEdit.format([t])))story.saveTiddler(t);else{e=true;return false}}});return e},startURL:function(e){var t=window.location.href.split("#");return e?t[0]:!t[1]||t.length==1},openTiddlers:function(e){n.openAll=true;story.displayTiddlers(null,e?e:store.getTiddlerText("DefaultTiddlers").readBracketedList());story.permaView();n.openAll=false}};checkChangedURL=function(){var e,r,i=window.location.href,s=i.indexOf("#"),o=t.chkSinglePageMode;if(i==n.lastURL)return;r=decodeURIComponent(i.substr(s+1)).readBracketedList();if(o&&r.length==1&&!story.getTiddler(r[0])||!o&&t.chkOpenTop&&story.getTiddler(r[0]))story.displayTiddler(null,r[0]);else if(o){n.lastURL=i;e=r.length;r.map(function(t){e=e&&story.getTiddler(t);return e});if(!e){if(r.length)n.openTiddlers(r);else n.openTiddlers()}}};var r=Story.prototype;r.displayTiddlerSINGLEPAGEHISTORY=r.displayTiddler;r.displayTiddler=function(r,i,s,o,u){var a,f=[],l,c,h,p=0,d,v=t.chkSinglePageMode,m=n.historyIndex,g=n.history.length,y=n.currentTiddler,b=typeof i==="string"?i:i.title;if(y!=b&&s!=2){if(!n.button){if(n.checkDirty()&&v){return false}if(g>0&&m<g-1){for(h=0;h<=m;h++)f.push(n.history[h]);f.push(b);n.historyIndex+=1;n.history=f}else{n.history.push(b);if(g>n.maxHistory)n.history.shift();else n.historyIndex+=1}e(".btn-history-forward").addClass("btn-history-none");if(b!=y&&m>=0)e(".btn-history-back").removeClass("btn-history-none")}if(y&&!n.openAll&&v&&s!=2){n.openAll=true;story.closeAllTiddlers();n.openAll=false}n.currentTiddler=b;if(!n.openAll){href=n.startURL(true)+"#"+encodeURIComponent(String.encodeTiddlyLink(b));window.location.href=href}n.lastURL=window.location.href;document.title=wikifyPlain("SiteTitle")+" - "+b}c=story.displayTiddlerSINGLEPAGEHISTORY("top",b,s,v?false:o);this.forEachTiddler(function(){p++;return p<3});if(s!=2&&p<2||!v){open=story.getTiddler(b);if(t.chkOpenTop)e("#tiddlerDisplay").prepend(e(open));d=v||!open||t.chkOpenTop?0:ensureVisible(open);if(t.chkAnimate)e(document.body).animate({scrollTop:d});else window.scrollTo(0,d)}if(!n.timeoutChangedURL)n.timeoutChangedURL=window.setInterval(function(){checkChangedURL()},n.intervalUpdateURL);return c};r.closeTiddlerSINGLEPAGEHISTORY=r.closeTiddler;r.closeTiddler=function(e,i,s){r.closeTiddlerSINGLEPAGEHISTORY.apply(this,arguments);if(s!="OPENING"&&t.chkOpenDefaultOnEmpty&&!n.openAll){var o=0;this.forEachTiddler(function(e,t){o++;return o<2});if(o==0)n.openTiddlers()}};onClickTagOpenAllSINGLEPAGEHISTORY=onClickTagOpenAll;onClickTagOpenAll=function(e){n.openAll=true;story.closeAllTiddlers();onClickTagOpenAllSINGLEPAGEHISTORY.apply(this,arguments);story.permaView();n.openAll=false};config.commands.saveTiddler.handlerSINGLEPAGEHISTORY=config.commands.saveTiddler.handler;config.commands.saveTiddler.handler=function(e,t,r){n.openAll=true;var i=config.commands.saveTiddler.handlerSINGLEPAGEHISTORY.apply(this,arguments);n.openAll=false;return i};var i=config.paramifiers;e.each(config.paramifiers,function(e,t){t.onstartSINGEPAGEHISTORY=t.onstart;t.onstart=function(e){n.openAll=true;t.onstartSINGEPAGEHISTORY.apply(this,arguments);n.openAll=false}})})(jQuery)
// %/