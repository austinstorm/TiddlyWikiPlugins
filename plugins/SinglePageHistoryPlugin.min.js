/***
|''Name:''|SinglePageHistoryPlugin|
|''Description:''|Limits to only one tiddler open (mostly). Manages an history stack and provides macro to navigate in this history (<<history>><<history back>><<history forward>>).|
|''Author:''|[[Tobias Beer|http://tobibeer.tiddlyspace.com]]|
|''Version:''|1.0.0 (2013-10-12)|
|''~CoreVersion:''|2.5.2|
|''Documentation:''|http://singlepagehistory.tiddlyspace.com|
|''Source:''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/plugins/SinglePageHistoryPlugin.min.js|
|''License''|Creative Commons 3.0|
***/
// /%
(function(e){var t=config.options;e.each({chkOpenDefaultOnEmpty:true,chkSinglePageMode:true},function(e,n){if(t[e]===undefined)t[e]=n});var n=config.macros.history={maxHistory:30,intervalUpdateURL:500,lingo:{historyLbl:"History",historyTip:"Click to show history...",forwardLbl:">",forwardTip:"Forward to previous in history...",backLbl:"<",backTip:"Back to last in history...",cancelEdit:"'%0' is being edited.\n\n"+"OK saves and closes it.\n"+"CANCEL leaves it open."},history:[],historyIndex:-1,currentTiddler:null,button:false,timeoutChangedURL:0,lastURL:window.location.href,openAll:false,handler:function(t,r,i){var s,o=i[0],u=n.historyIndex,a="button btn-history btn-history-";if(o){type=o=="back"?o:"forward";s=createTiddlyButton(t,n.lingo[type+"Lbl"],n.lingo[type+"Tip"],n.go,a+type);if(o=="back"&&u==0||o!="back"&&u==n.history.length-1)e(s).addClass("btn-history-none")}else{createTiddlyButton(t,n.lingo.historyLbl,n.lingo.historyTip,n.showPopup,"button btn-history btn-history-popup")}},showPopup:function(t){var r,i,s,o=t||window.event,u=Popup.create(this);for(r=0;r<n.history.length;r++){s=n.history[r];i=createTiddlyButton(createTiddlyElement(u,"li"),s,s,n.go);e(i).attr("historyIndex",r);if(s==n.currentTiddler)e(i).addClass("btn-history-current")}Popup.show(u,false);o.cancelBubble=true;if(o.stopPropagation)o.stopPropagation();return false},go:function(){var t,r=e(this),i=n.history.length,s=r.hasClass("btn-history-forward"),o=r.attr("historyIndex"),u=n.currentTiddler,o=undefined!=o?parseInt(o):n.historyIndex+(s?1:-1);t=n.history[o];if(!t||t==u||n.checkDirty()){return false}n.historyIndex=o;n.button=true;story.displayTiddler(null,t);n.button=false;e(".btn-history-back, .btn-history-forward").addClass("btn-history-none");if(o>=0&&o<i-1)e(".btn-history-forward").removeClass("btn-history-none");if(o<=i-1&&o>0)e(".btn-history-back").removeClass("btn-history-none");return false},checkDirty:function(){var e=false;story.forEachTiddler(function(t,r){if("true"==r.getAttribute("dirty")){if(confirm(n.lingo.cancelEdit.format([t])))story.saveTiddler(t);else{e=true;return false}}});return e},startURL:function(e){var t=window.location.href.split("#");return e?t[0]:!t[1]||t.length==1},openTiddlers:function(e){n.openAll=true;story.displayTiddlers(null,e?e:store.getTiddlerText("DefaultTiddlers").readBracketedList());story.permaView();n.openAll=false}};checkChangedURL=function(){if(!t.chkSinglePageMode){window.clearInterval(n.timeoutChangedURL);n.timeoutChangedURL=0;return}var e,r,i=window.location.href,s=i.indexOf("#");if(i==n.lastURL)return;r=decodeURIComponent(i.substr(s+1)).readBracketedList();if(r.length==1&&!story.getTiddler(r[0]))story.displayTiddler(null,r[0]);else{n.lastURL=i;e=r.length;r.map(function(t){e=e&&story.getTiddler(t);return e});if(!e){if(r.length)n.openTiddlers(r);else n.openTiddlers()}}};var r=Story.prototype;r.displayTiddlerSINGLEPAGEHISTORY=r.displayTiddler;r.displayTiddler=function(r,i,s,o,u){var a=[],f,l,c,h=0,p=t.chkSinglePageMode,d=n.historyIndex,v=n.history.length,m=n.currentTiddler,g=typeof i==="string"?i:i.title;if(m!=g&&s!=2){if(!n.button){if(n.checkDirty()&&p){return false}if(v>0&&d<v-1){for(c=0;c<=d;c++)a.push(n.history[c]);a.push(g);n.historyIndex+=1;n.history=a}else{n.history.push(g);if(v>n.maxHistory)n.history.shift();else n.historyIndex+=1}e(".btn-history-forward").addClass("btn-history-none");if(g!=m&&d>=0)e(".btn-history-back").removeClass("btn-history-none")}if(m&&!n.openAll&&p&&s!=2){n.openAll=true;story.closeAllTiddlers();n.openAll=false}n.currentTiddler=g;if(!n.openAll){href=n.startURL(true)+"#"+encodeURIComponent(String.encodeTiddlyLink(g));window.location.href=href}n.lastURL=window.location.href;document.title=wikifyPlain("SiteTitle")+" - "+g}l=story.displayTiddlerSINGLEPAGEHISTORY("top",g,s,false);this.forEachTiddler(function(e,t){h++;return h<2});if(s!=2&&h<2){if(t.chkAnimate)e(document.body).animate({scrollTop:0});else window.scrollTo(0,0)}if(!n.timeoutChangedURL)n.timeoutChangedURL=window.setInterval(function(){checkChangedURL()},n.intervalUpdateURL);return l};r.closeTiddlerSINGLEPAGEHISTORY=r.closeTiddler;r.closeTiddler=function(e,i,s){r.closeTiddlerSINGLEPAGEHISTORY.apply(this,arguments);if(s!="OPENING"&&t.chkOpenDefaultOnEmpty&&!n.openAll){var o=0;this.forEachTiddler(function(e,t){o++;return o<2});if(o==0)n.openTiddlers()}};onClickTagOpenAllSINGLEPAGEHISTORY=onClickTagOpenAll;onClickTagOpenAll=function(e){n.openAll=true;story.closeAllTiddlers();onClickTagOpenAllSINGLEPAGEHISTORY.apply(this,arguments);story.permaView();n.openAll=false};config.commands.saveTiddler.handlerSINGLEPAGEHISTORY=config.commands.saveTiddler.handler;config.commands.saveTiddler.handler=function(e,t,r){n.openAll=true;var i=config.commands.saveTiddler.handlerSINGLEPAGEHISTORY.apply(this,arguments);n.openAll=false;return i};var i=config.paramifiers;e.each(config.paramifiers,function(e,t){t.onstartSINGEPAGEHISTORY=t.onstart;t.onstart=function(e){n.openAll=true;t.onstartSINGEPAGEHISTORY.apply(this,arguments);n.openAll=false}})})(jQuery)
// %/